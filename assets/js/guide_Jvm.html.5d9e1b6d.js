"use strict";(self.webpackChunkwomeng_docs=self.webpackChunkwomeng_docs||[]).push([[358],{547(n,s,a){a.r(s),a.d(s,{comp:()=>l,data:()=>t});var e=a(641);const p={},l=(0,a(262).A)(p,[["render",function(n,s){return(0,e.uX)(),(0,e.CE)("div",null,[...s[0]||(s[0]=[(0,e.Fv)('<h1 id="jvm-黑马" tabindex="-1"><a class="header-anchor" href="#jvm-黑马"><span>JVM (黑马)</span></a></h1><h2 id="程序计数器" tabindex="-1"><a class="header-anchor" href="#程序计数器"><span>程序计数器</span></a></h2><p>程序计数器对应的物理储存位置是CPU寄存器，计数器记录着当前线程下一条要执行的JVM指令的地址。</p><blockquote><p>特点：线程私有、没有内存溢出</p></blockquote><h2 id="虚拟机栈" tabindex="-1"><a class="header-anchor" href="#虚拟机栈"><span>虚拟机栈</span></a></h2><ul><li>一个虚拟机栈对应一个线程运行的内存。</li><li>栈里面包含多个栈帧，每个栈帧对应每个方法调用所占用的内存，栈帧包含有参数、局部变量、返回地址、对象的引用等内容。</li><li>每个线程就是每个栈只能有一个活动的栈帧，对应着当前正在执行的那个方法。</li></ul><h2 id="线程诊断" tabindex="-1"><a class="header-anchor" href="#线程诊断"><span>线程诊断</span></a></h2><p>排查出哪个线程占用cpu过高</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token comment">#通过进程id查出线程id（tid）</span></span>\n<span class="line"><span class="token function">ps</span> H <span class="token parameter variable">-eo</span> pid,tid,%cpu<span class="token operator">|</span><span class="token function">grep</span> 进程id</span>\n<span class="line"></span>\n<span class="line"><span class="token comment">#打印进程下的所有线程的信息，找到对应的线程查看（16进制），找出问题对应的代码类名和  行号，还能查看死锁</span></span>\n<span class="line">jstack 进程id</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="堆" tabindex="-1"><a class="header-anchor" href="#堆"><span>堆</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token comment">#查看所有Java进程id</span></span>\n<span class="line">jps</span>\n<span class="line"></span>\n<span class="line"><span class="token comment">#某个时刻堆内存使用状况</span></span>\n<span class="line">jmap <span class="token parameter variable">-heap</span> 进程id</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>堆检查工具常用的有 jconsole， jvisualVM等。jvisualvm可以把堆内存dump下来，找出较大的对象。</p></blockquote><h2 id="stringtable-常量池" tabindex="-1"><a class="header-anchor" href="#stringtable-常量池"><span>StringTable（常量池）</span></a></h2><ul><li><p>常量池中的字符串仅是符号，第一次用到时才变为对象</p></li><li><p>字符串变量拼接的原理是StringBuilder</p></li><li><p>字符串常量拼接的原理是编译器优化</p></li><li><p>可以使用<code>intern()</code>方法主动将常量池中还没有的字符串放入常量池，如果常量池中已经有了，就会入池失败，如果没有，入池成功，返回字符串在常量池中的地址。</p></li></ul><blockquote><p>jdk1.6 常量池在方法区--&gt;永久代中</p><p>jdk1.7以上 常量池在堆内存中</p></blockquote><h3 id="常量池调优" tabindex="-1"><a class="header-anchor" href="#常量池调优"><span>常量池调优</span></a></h3><ul><li>调整 <code>-XX:StringTableSize=哈希桶个数</code>，桶数越多，哈希碰撞几率越小，操作越快。</li><li>有大量重复字符串的时候，使用 <code>intern()</code> 方法主动入池，减少内存消耗。</li></ul><h2 id="什么是jvm" tabindex="-1"><a class="header-anchor" href="#什么是jvm"><span>什么是JVM</span></a></h2><h3 id="定义" tabindex="-1"><a class="header-anchor" href="#定义"><span>定义</span></a></h3><p>Java Virtual Machine，JAVA程序的<strong>运行环境</strong>（JAVA二进制字节码的运行环境）</p><h3 id="好处" tabindex="-1"><a class="header-anchor" href="#好处"><span>好处</span></a></h3><ul><li>一次编写，到处运行</li><li>自动内存管理，垃圾回收机制</li><li>数组下标越界检查</li></ul><h3 id="比较" tabindex="-1"><a class="header-anchor" href="#比较"><span>比较</span></a></h3><p>JVM JRE JDK的区别</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150422.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150422.png" alt="img"></a></p><h2 id="二、内存结构" tabindex="-1"><a class="header-anchor" href="#二、内存结构"><span>二、内存结构</span></a></h2><h3 id="整体架构" tabindex="-1"><a class="header-anchor" href="#整体架构"><span><strong>整体架构</strong></span></a></h3><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150440.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150440.png" alt="img"></a></p><h3 id="_1、程序计数器" tabindex="-1"><a class="header-anchor" href="#_1、程序计数器"><span>1、程序计数器</span></a></h3><h4 id="作用" tabindex="-1"><a class="header-anchor" href="#作用"><span>作用</span></a></h4><p>用于保存JVM中下一条所要执行的指令的地址</p><h4 id="特点" tabindex="-1"><a class="header-anchor" href="#特点"><span>特点</span></a></h4><ul><li>线程私有 <ul><li>CPU会为每个线程分配时间片，当当前线程的时间片使用完以后，CPU就会去执行另一个线程中的代码</li><li>程序计数器是<strong>每个线程</strong>所<strong>私有</strong>的，当另一个线程的时间片用完，又返回来执行当前线程的代码时，通过程序计数器可以知道应该执行哪一句指令</li></ul></li><li>不会存在内存溢出</li></ul><h3 id="_2、虚拟机栈" tabindex="-1"><a class="header-anchor" href="#_2、虚拟机栈"><span>2、虚拟机栈</span></a></h3><h4 id="定义-1" tabindex="-1"><a class="header-anchor" href="#定义-1"><span>定义</span></a></h4><ul><li>每个<strong>线程</strong>运行需要的内存空间，称为<strong>虚拟机栈</strong></li><li>每个栈由多个<strong>栈帧</strong>组成，对应着每次调用方法时所占用的内存</li><li>每个线程只能有<strong>一个活动栈帧</strong>，对应着<strong>当前正在执行的方法</strong></li></ul><h4 id="演示" tabindex="-1"><a class="header-anchor" href="#演示"><span>演示</span></a></h4><p>代码</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token function">method2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token keyword">int</span> c <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token keyword">return</span> c<span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150534.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150534.png" alt="img"></a></p><p>在控制台中可以看到，主类中的方法在进入虚拟机栈的时候，符合栈的特点</p><h4 id="问题辨析" tabindex="-1"><a class="header-anchor" href="#问题辨析"><span>问题辨析</span></a></h4><ul><li>垃圾回收是否涉及栈内存？ <ul><li><strong>不需要</strong>。因为虚拟机栈中是由一个个栈帧组成的，在方法执行完毕后，对应的栈帧就会被弹出栈。所以无需通过垃圾回收机制去回收内存。</li></ul></li><li>栈内存的分配越大越好吗？ <ul><li>不是。因为<strong>物理内存是一定的</strong>，栈内存越大，可以支持更多的递归调用，但是可执行的线程数就会越少。</li></ul></li><li>方法内的局部变量是否是线程安全的？ <ul><li>如果方法内<strong>局部变量没有逃离方法的作用范围</strong>，则是<strong>线程安全</strong>的</li><li>如果如果<strong>局部变量引用了对象</strong>，并<strong>逃离了方法的作用范围</strong>，则需要考虑线程安全问题</li></ul></li></ul><h4 id="内存溢出" tabindex="-1"><a class="header-anchor" href="#内存溢出"><span>内存溢出</span></a></h4><p><strong>Java.lang.stackOverflowError</strong> 栈内存溢出</p><p><strong>发生原因</strong></p><ul><li>虚拟机栈中，<strong>栈帧过多</strong>（无限递归）</li><li>每个栈帧<strong>所占用过大</strong></li></ul><h4 id="线程运行诊断" tabindex="-1"><a class="header-anchor" href="#线程运行诊断"><span>线程运行诊断</span></a></h4><p>CPU占用过高</p><ul><li>Linux环境下运行某些程序的时候，可能导致CPU的占用过高，这时需要定位占用CPU过高的线程 <ul><li><strong>top</strong>命令，查看是哪个<strong>进程</strong>占用CPU过高</li><li><strong>ps H -eo pid, tid（线程id）, %cpu | grep 刚才通过top查到的进程号</strong> 通过ps命令进一步查看是哪个线程占用CPU过高</li><li><strong>jstack 进程id</strong> 通过查看进程中的线程的nid，刚才通过ps命令看到的tid来<strong>对比定位</strong>，注意jstack查找出的线程id是<strong>16进制的</strong>，<strong>需要转换</strong></li></ul></li></ul><h3 id="_3、本地方法栈" tabindex="-1"><a class="header-anchor" href="#_3、本地方法栈"><span>3、本地方法栈</span></a></h3><p>一些带有<strong>native关键字</strong>的方法就是需要JAVA去调用本地的C或者C++方法，因为JAVA有时候没法直接和操作系统底层交互，所以需要用到本地方法</p><h3 id="_4、堆" tabindex="-1"><a class="header-anchor" href="#_4、堆"><span>4、堆</span></a></h3><h4 id="定义-2" tabindex="-1"><a class="header-anchor" href="#定义-2"><span>定义</span></a></h4><p>通过new关键字<strong>创建的对象</strong>都会被放在堆内存</p><h4 id="特点-1" tabindex="-1"><a class="header-anchor" href="#特点-1"><span>特点</span></a></h4><ul><li><strong>所有线程共享</strong>，堆内存中的对象都需要<strong>考虑线程安全问题</strong></li><li>有垃圾回收机制</li></ul><h4 id="堆内存溢出" tabindex="-1"><a class="header-anchor" href="#堆内存溢出"><span>堆内存溢出</span></a></h4><p><strong>java.lang.OutofMemoryError</strong> ：java heap space. 堆内存溢出</p><h4 id="堆内存诊断" tabindex="-1"><a class="header-anchor" href="#堆内存诊断"><span>堆内存诊断</span></a></h4><p><strong>jps</strong></p><p><strong>jmap</strong></p><p><strong>jconsole</strong></p><p><strong>jvirsalvm</strong></p><h3 id="_5、方法区" tabindex="-1"><a class="header-anchor" href="#_5、方法区"><span>5、方法区</span></a></h3><h4 id="结构" tabindex="-1"><a class="header-anchor" href="#结构"><span>结构</span></a></h4><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150547.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150547.png" alt="img"></a></p><h4 id="内存溢出-1" tabindex="-1"><a class="header-anchor" href="#内存溢出-1"><span>内存溢出</span></a></h4><ul><li>1.8以前会导致<strong>永久代</strong>内存溢出</li><li>1.8以后会导致<strong>元空间</strong>内存溢出</li></ul><h4 id="常量池" tabindex="-1"><a class="header-anchor" href="#常量池"><span>常量池</span></a></h4><p>二进制字节码的组成：类的基本信息、常量池、类的方法定义（包含了虚拟机指令）</p><p><strong>通过反编译来查看类的信息</strong></p><ul><li><p>获得对应类的.class文件</p><ul><li><p>在JDK对应的bin目录下运行cmd，<strong>也可以在IDEA控制台输入</strong></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150602.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150602.png" alt="img"></a></p></li><li><p>输入 <strong>javac 对应类的绝对路径</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">F:<span class="token punctuation">\\</span>JAVA<span class="token punctuation">\\</span>JDK8.0<span class="token punctuation">\\</span>bin<span class="token operator">&gt;</span>javac F:<span class="token punctuation">\\</span>Thread_study<span class="token punctuation">\\</span>src<span class="token punctuation">\\</span>com<span class="token punctuation">\\</span>nyima<span class="token punctuation">\\</span>JVM<span class="token punctuation">\\</span>day01<span class="token punctuation">\\</span>Main.java</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>输入完成后，对应的目录下就会出现类的.class文件</p></li></ul></li><li><p>在控制台输入 javap -v 类的绝对路径</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">javap <span class="token parameter variable">-v</span> F:<span class="token punctuation">\\</span>Thread_study<span class="token punctuation">\\</span>src<span class="token punctuation">\\</span>com<span class="token punctuation">\\</span>nyima<span class="token punctuation">\\</span>JVM<span class="token punctuation">\\</span>day01<span class="token punctuation">\\</span>Main.class</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>然后能在控制台看到反编译以后类的信息了</p><ul><li><p>类的基本信息</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150618.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150618.png" alt="img"></a></p></li><li><p>常量池</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150630.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150630.png" alt="img"></a></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150641.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150641.png" alt="img"></a></p></li><li><p>虚拟机中执行编译的方法（框内的是真正编译执行的内容，<strong>#号的内容需要在常量池中查找</strong>）</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150653.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150653.png" alt="img"></a></p></li></ul></li></ul><h4 id="运行时常量池" tabindex="-1"><a class="header-anchor" href="#运行时常量池"><span>运行时常量池</span></a></h4><ul><li>常量池 <ul><li>就是一张表（如上图中的constant pool），虚拟机指令根据这张常量表找到要执行的类名、方法名、参数类型、字面量信息</li></ul></li><li>运行时常量池 <ul><li>常量池是*.class文件中的，当该<strong>类被加载以后</strong>，它的常量池信息就会<strong>放入运行时常量池</strong>，并把里面的<strong>符号地址变为真实地址</strong></li></ul></li></ul><h4 id="常量池与串池的关系" tabindex="-1"><a class="header-anchor" href="#常量池与串池的关系"><span>常量池与串池的关系</span></a></h4><h5 id="串池stringtable" tabindex="-1"><a class="header-anchor" href="#串池stringtable"><span><strong>串池</strong>StringTable</span></a></h5><p><strong>特征</strong></p><ul><li>常量池中的字符串仅是符号，只有<strong>在被用到时才会转化为对象</strong></li><li>利用串池的机制，来避免重复创建字符串对象</li><li>字符串<strong>变量</strong>拼接的原理是<strong>StringBuilder</strong></li><li>字符串<strong>常量</strong>拼接的原理是<strong>编译器优化</strong></li><li>可以使用<strong>intern方法</strong>，主动将串池中还没有的字符串对象放入串池中</li><li><strong>注意</strong>：无论是串池还是堆里面的字符串，都是对象</li></ul><p>用来放字符串对象且里面的<strong>元素不重复</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringTableStudy</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">;</span> </span>\n<span class="line">\t\t<span class="token class-name">String</span> b <span class="token operator">=</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token class-name">String</span> ab <span class="token operator">=</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>常量池中的信息，都会被加载到运行时常量池中，但这是a b ab 仅是常量池中的符号，<strong>还没有成为java字符串</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token number">0</span><span class="token operator">:</span> ldc           #<span class="token number">2</span>                  <span class="token comment">// String a</span></span>\n<span class="line"><span class="token number">2</span><span class="token operator">:</span> astore_1</span>\n<span class="line"><span class="token number">3</span><span class="token operator">:</span> ldc           #<span class="token number">3</span>                  <span class="token comment">// String b</span></span>\n<span class="line"><span class="token number">5</span><span class="token operator">:</span> astore_2</span>\n<span class="line"><span class="token number">6</span><span class="token operator">:</span> ldc           #<span class="token number">4</span>                  <span class="token comment">// String ab</span></span>\n<span class="line"><span class="token number">8</span><span class="token operator">:</span> astore_3</span>\n<span class="line"><span class="token number">9</span><span class="token operator">:</span> <span class="token keyword">return</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当执行到 ldc #2 时，会把符号 a 变为 “a” 字符串对象，<strong>并放入串池中</strong>（hashtable结构 不可扩容）</p><p>当执行到 ldc #3 时，会把符号 b 变为 “b” 字符串对象，并放入串池中</p><p>当执行到 ldc #4 时，会把符号 ab 变为 “ab” 字符串对象，并放入串池中</p><p>最终<strong>StringTable [“a”, “b”, “ab”]</strong></p><p><strong>注意</strong>：字符串对象的创建都是<strong>懒惰的</strong>，只有当运行到那一行字符串且在串池中不存在的时候（如 ldc #2）时，该字符串才会被创建并放入串池中。</p><p>使用拼接<strong>字符串变量对象</strong>创建字符串的过程</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringTableStudy</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token class-name">String</span> b <span class="token operator">=</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token class-name">String</span> ab <span class="token operator">=</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token comment">//拼接字符串对象来创建新的字符串</span></span>\n<span class="line">\t\t<span class="token class-name">String</span> ab2 <span class="token operator">=</span> a<span class="token operator">+</span>b<span class="token punctuation">;</span> </span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>反编译后的结果</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line">\t <span class="token class-name">Code</span><span class="token operator">:</span></span>\n<span class="line">      stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span></span>\n<span class="line">         <span class="token number">0</span><span class="token operator">:</span> ldc           #<span class="token number">2</span>                  <span class="token comment">// String a</span></span>\n<span class="line">         <span class="token number">2</span><span class="token operator">:</span> astore_1</span>\n<span class="line">         <span class="token number">3</span><span class="token operator">:</span> ldc           #<span class="token number">3</span>                  <span class="token comment">// String b</span></span>\n<span class="line">         <span class="token number">5</span><span class="token operator">:</span> astore_2</span>\n<span class="line">         <span class="token number">6</span><span class="token operator">:</span> ldc           #<span class="token number">4</span>                  <span class="token comment">// String ab</span></span>\n<span class="line">         <span class="token number">8</span><span class="token operator">:</span> astore_3</span>\n<span class="line">         <span class="token number">9</span><span class="token operator">:</span> <span class="token keyword">new</span>           #<span class="token number">5</span>                  <span class="token comment">// class java/lang/StringBuilder</span></span>\n<span class="line">        <span class="token number">12</span><span class="token operator">:</span> dup</span>\n<span class="line">        <span class="token number">13</span><span class="token operator">:</span> invokespecial #<span class="token number">6</span>                  <span class="token comment">// Method java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:()V</span></span>\n<span class="line">        <span class="token number">16</span><span class="token operator">:</span> aload_1</span>\n<span class="line">        <span class="token number">17</span><span class="token operator">:</span> invokevirtual #<span class="token number">7</span>                  <span class="token comment">// Method java/lang/StringBuilder.append:(Ljava/lang/String</span></span>\n<span class="line"><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">StringBuilder</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token number">20</span><span class="token operator">:</span> aload_2</span>\n<span class="line">        <span class="token number">21</span><span class="token operator">:</span> invokevirtual #<span class="token number">7</span>                  <span class="token comment">// Method java/lang/StringBuilder.append:(Ljava/lang/String</span></span>\n<span class="line"><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">StringBuilder</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token number">24</span><span class="token operator">:</span> invokevirtual #<span class="token number">8</span>                  <span class="token comment">// Method java/lang/StringBuilder.toString:()Ljava/lang/Str</span></span>\n<span class="line">ing<span class="token punctuation">;</span></span>\n<span class="line">        <span class="token number">27</span><span class="token operator">:</span> astore        <span class="token number">4</span></span>\n<span class="line">        <span class="token number">29</span><span class="token operator">:</span> <span class="token keyword">return</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过拼接的方式来创建字符串的<strong>过程</strong>是：StringBuilder().append(“a”).append(“b”).toString()</p><p>最后的toString方法的返回值是一个<strong>新的字符串</strong>，但字符串的<strong>值</strong>和拼接的字符串一致，但是两个不同的字符串，<strong>一个存在于串池之中，一个存在于堆内存之中</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token class-name">String</span> ab <span class="token operator">=</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token class-name">String</span> ab2 <span class="token operator">=</span> a<span class="token operator">+</span>b<span class="token punctuation">;</span></span>\n<span class="line"><span class="token comment">//结果为false,因为ab是存在于串池之中，ab2是由StringBuffer的toString方法所返回的一个对象，存在于堆内存之中</span></span>\n<span class="line"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ab <span class="token operator">==</span> ab2<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用<strong>拼接字符串常量对象</strong>的方法创建字符串</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringTableStudy</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token class-name">String</span> b <span class="token operator">=</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token class-name">String</span> ab <span class="token operator">=</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token class-name">String</span> ab2 <span class="token operator">=</span> a<span class="token operator">+</span>b<span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token comment">//使用拼接字符串的方法创建字符串</span></span>\n<span class="line">\t\t<span class="token class-name">String</span> ab3 <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>反编译后的结果</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"> \t  <span class="token class-name">Code</span><span class="token operator">:</span></span>\n<span class="line">      stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span></span>\n<span class="line">         <span class="token number">0</span><span class="token operator">:</span> ldc           #<span class="token number">2</span>                  <span class="token comment">// String a</span></span>\n<span class="line">         <span class="token number">2</span><span class="token operator">:</span> astore_1</span>\n<span class="line">         <span class="token number">3</span><span class="token operator">:</span> ldc           #<span class="token number">3</span>                  <span class="token comment">// String b</span></span>\n<span class="line">         <span class="token number">5</span><span class="token operator">:</span> astore_2</span>\n<span class="line">         <span class="token number">6</span><span class="token operator">:</span> ldc           #<span class="token number">4</span>                  <span class="token comment">// String ab</span></span>\n<span class="line">         <span class="token number">8</span><span class="token operator">:</span> astore_3</span>\n<span class="line">         <span class="token number">9</span><span class="token operator">:</span> <span class="token keyword">new</span>           #<span class="token number">5</span>                  <span class="token comment">// class java/lang/StringBuilder</span></span>\n<span class="line">        <span class="token number">12</span><span class="token operator">:</span> dup</span>\n<span class="line">        <span class="token number">13</span><span class="token operator">:</span> invokespecial #<span class="token number">6</span>                  <span class="token comment">// Method java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:()V</span></span>\n<span class="line">        <span class="token number">16</span><span class="token operator">:</span> aload_1</span>\n<span class="line">        <span class="token number">17</span><span class="token operator">:</span> invokevirtual #<span class="token number">7</span>                  <span class="token comment">// Method java/lang/StringBuilder.append:(Ljava/lang/String</span></span>\n<span class="line"><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">StringBuilder</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token number">20</span><span class="token operator">:</span> aload_2</span>\n<span class="line">        <span class="token number">21</span><span class="token operator">:</span> invokevirtual #<span class="token number">7</span>                  <span class="token comment">// Method java/lang/StringBuilder.append:(Ljava/lang/String</span></span>\n<span class="line"><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">StringBuilder</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token number">24</span><span class="token operator">:</span> invokevirtual #<span class="token number">8</span>                  <span class="token comment">// Method java/lang/StringBuilder.toString:()Ljava/lang/Str</span></span>\n<span class="line">ing<span class="token punctuation">;</span></span>\n<span class="line">        <span class="token number">27</span><span class="token operator">:</span> astore        <span class="token number">4</span></span>\n<span class="line">        <span class="token comment">//ab3初始化时直接从串池中获取字符串</span></span>\n<span class="line">        <span class="token number">29</span><span class="token operator">:</span> ldc           #<span class="token number">4</span>                  <span class="token comment">// String ab</span></span>\n<span class="line">        <span class="token number">31</span><span class="token operator">:</span> astore        <span class="token number">5</span></span>\n<span class="line">        <span class="token number">33</span><span class="token operator">:</span> <span class="token keyword">return</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>使用<strong>拼接字符串常量</strong>的方法来创建新的字符串时，因为<strong>内容是常量，javac在编译期会进行优化，结果已在编译期确定为ab</strong>，而创建ab的时候已经在串池中放入了“ab”，所以ab3直接从串池中获取值，所以进行的操作和 ab = “ab” 一致。</li><li>使用<strong>拼接字符串变量</strong>的方法来创建新的字符串时，因为内容是变量，只能<strong>在运行期确定它的值，所以需要使用StringBuilder来创建</strong></li></ul><h5 id="intern方法-1-8" tabindex="-1"><a class="header-anchor" href="#intern方法-1-8"><span>intern方法 1.8</span></a></h5><p>调用字符串对象的intern方法，会将该字符串对象尝试放入到串池中</p><ul><li>如果串池中没有该字符串对象，则放入成功</li><li>如果有该字符串对象，则放入失败</li></ul><p>无论放入是否成功，都会返回<strong>串池中</strong>的字符串对象</p><p><strong>注意</strong>：此时如果调用intern方法成功，堆内存与串池中的字符串对象是同一个对象；如果失败，则不是同一个对象</p><p><strong>例1</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token comment">//&quot;a&quot; &quot;b&quot; 被放入串池中，str则存在于堆内存之中</span></span>\n<span class="line">\t\t<span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token comment">//调用str的intern方法，这时串池中没有&quot;ab&quot;，则会将该字符串对象放入到串池中，此时堆内存与串池中的&quot;ab&quot;是同一个对象</span></span>\n<span class="line">\t\t<span class="token class-name">String</span> st2 <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token comment">//给str3赋值，因为此时串池中已有&quot;ab&quot;，则直接将串池中的内容返回</span></span>\n<span class="line">\t\t<span class="token class-name">String</span> str3 <span class="token operator">=</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token comment">//因为堆内存与串池中的&quot;ab&quot;是同一个对象，所以以下两条语句打印的都为true</span></span>\n<span class="line">\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str <span class="token operator">==</span> st2<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str <span class="token operator">==</span> str3<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>例2</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token comment">//此处创建字符串对象&quot;ab&quot;，因为串池中还没有&quot;ab&quot;，所以将其放入串池中</span></span>\n<span class="line">\t\t<span class="token class-name">String</span> str3 <span class="token operator">=</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token comment">//&quot;a&quot; &quot;b&quot; 被放入串池中，str则存在于堆内存之中</span></span>\n<span class="line">\t\t<span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token comment">//此时因为在创建str3时，&quot;ab&quot;已存在与串池中，所以放入失败，但是会返回串池中的&quot;ab&quot;</span></span>\n<span class="line">\t\t<span class="token class-name">String</span> str2 <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token comment">//false</span></span>\n<span class="line">\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str <span class="token operator">==</span> str2<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token comment">//false</span></span>\n<span class="line">\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str <span class="token operator">==</span> str3<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token comment">//true</span></span>\n<span class="line">\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str2 <span class="token operator">==</span> str3<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="intern方法-1-6" tabindex="-1"><a class="header-anchor" href="#intern方法-1-6"><span>intern方法 1.6</span></a></h5><p>调用字符串对象的intern方法，会将该字符串对象尝试放入到串池中</p><ul><li>如果串池中没有该字符串对象，会将该字符串对象复制一份，再放入到串池中</li><li>如果有该字符串对象，则放入失败</li></ul><p>无论放入是否成功，都会返回<strong>串池中</strong>的字符串对象</p><p><strong>注意</strong>：此时无论调用intern方法成功与否，串池中的字符串对象和堆内存中的字符串对象<strong>都不是同一个对象</strong></p><h4 id="stringtable-垃圾回收" tabindex="-1"><a class="header-anchor" href="#stringtable-垃圾回收"><span>StringTable 垃圾回收</span></a></h4><p>StringTable在内存紧张时，会发生垃圾回收</p><h4 id="stringtable调优" tabindex="-1"><a class="header-anchor" href="#stringtable调优"><span>StringTable调优</span></a></h4><ul><li><p>因为StringTable是由HashTable实现的，所以可以<strong>适当增加HashTable桶的个数</strong>，来减少字符串放入串池所需要的时间</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token parameter variable">-XX:StringTableSize</span><span class="token operator">=</span>xxxx</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>考虑是否需要将字符串对象入池</p><p>可以通过<strong>intern方法减少重复入池</strong></p></li></ul><h2 id="直接内存" tabindex="-1"><a class="header-anchor" href="#直接内存"><span>直接内存</span></a></h2><ul><li>属于操作系统，常见于NIO操作时，<strong>用于数据缓冲区</strong></li><li>分配回收成本较高，但读写性能高</li><li>不受JVM内存回收管理</li></ul><h4 id="文件读写流程" tabindex="-1"><a class="header-anchor" href="#文件读写流程"><span>文件读写流程</span></a></h4><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150715.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150715.png" alt="img"></a></p><p><strong>使用了DirectBuffer</strong></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150736.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150736.png" alt="img"></a></p><p>直接内存是操作系统和Java代码<strong>都可以访问的一块区域</strong>，无需将代码从系统内存复制到Java堆内存，从而提高了效率</p><h4 id="释放原理" tabindex="-1"><a class="header-anchor" href="#释放原理"><span>释放原理</span></a></h4><p>直接内存的回收不是通过JVM的垃圾回收来释放的，而是通过<strong>unsafe.freeMemory</strong>来手动释放</p><p>通过</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token comment">//通过ByteBuffer申请1M的直接内存</span></span>\n<span class="line"><span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span>_1M<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>申请直接内存，但JVM并不能回收直接内存中的内容，它是如何实现回收的呢？</p><p><strong>allocateDirect的实现</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ByteBuffer</span> <span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectByteBuffer</span><span class="token punctuation">(</span>capacity<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>DirectByteBuffer类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token class-name">DirectByteBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> cap<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// package-private</span></span>\n<span class="line">   </span>\n<span class="line">    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cap<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">boolean</span> pa <span class="token operator">=</span> <span class="token constant">VM</span><span class="token punctuation">.</span><span class="token function">isDirectMemoryPageAligned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">int</span> ps <span class="token operator">=</span> <span class="token class-name">Bits</span><span class="token punctuation">.</span><span class="token function">pageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">long</span> size <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>cap <span class="token operator">+</span> <span class="token punctuation">(</span>pa <span class="token operator">?</span> ps <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token class-name">Bits</span><span class="token punctuation">.</span><span class="token function">reserveMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">long</span> base <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">        base <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">allocateMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//申请内存</span></span>\n<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OutOfMemoryError</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token class-name">Bits</span><span class="token punctuation">.</span><span class="token function">unreserveMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token keyword">throw</span> x<span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">    unsafe<span class="token punctuation">.</span><span class="token function">setMemory</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>pa <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>base <span class="token operator">%</span> ps <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token comment">// Round up to page boundary</span></span>\n<span class="line">        address <span class="token operator">=</span> base <span class="token operator">+</span> ps <span class="token operator">-</span> <span class="token punctuation">(</span>base <span class="token operator">&amp;</span> <span class="token punctuation">(</span>ps <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>\n<span class="line">        address <span class="token operator">=</span> base<span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token comment">//通过虚引用，来实现直接内存的释放，this为虚引用的实际对象</span></span>\n<span class="line">    cleaner <span class="token operator">=</span> <span class="token class-name">Cleaner</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Deallocator</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> size<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>\n<span class="line">    att <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里调用了一个Cleaner的create方法，且后台线程还会对虚引用的对象监测，如果虚引用的实际对象（这里是DirectByteBuffer）被回收以后，就会调用Cleaner的clean方法，来清除直接内存中占用的内存</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">           <span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">               <span class="token keyword">this</span><span class="token punctuation">.</span>thunk<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用run方法</span></span>\n<span class="line">           <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Throwable</span> var2<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">               <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                   <span class="token keyword">public</span> <span class="token class-name">Void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                           <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Cleaner terminated abnormally&quot;</span><span class="token punctuation">,</span> var2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                       <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">                       <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                       <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>\n<span class="line">                   <span class="token punctuation">}</span></span>\n<span class="line">               <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">           <span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应对象的run方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>address <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token comment">// Paranoia</span></span>\n<span class="line">        <span class="token keyword">return</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">    unsafe<span class="token punctuation">.</span><span class="token function">freeMemory</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//释放直接内存中占用的内存</span></span>\n<span class="line">    address <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token class-name">Bits</span><span class="token punctuation">.</span><span class="token function">unreserveMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> capacity<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="直接内存的回收机制总结" tabindex="-1"><a class="header-anchor" href="#直接内存的回收机制总结"><span>直接内存的回收机制总结</span></a></h5><ul><li>使用了Unsafe类来完成直接内存的分配回收，回收需要主动调用freeMemory方法</li><li>ByteBuffer的实现内部使用了Cleaner（虚引用）来检测ByteBuffer。一旦ByteBuffer被垃圾回收，那么会由ReferenceHandler来调用Cleaner的clean方法调用freeMemory来释放内存</li></ul><h2 id="垃圾回收" tabindex="-1"><a class="header-anchor" href="#垃圾回收"><span>垃圾回收</span></a></h2><h3 id="_1、如何判断对象可以回收" tabindex="-1"><a class="header-anchor" href="#_1、如何判断对象可以回收"><span>1、如何判断对象可以回收</span></a></h3><h4 id="引用计数法" tabindex="-1"><a class="header-anchor" href="#引用计数法"><span>引用计数法</span></a></h4><p>弊端：循环引用时，两个对象的计数都为1，导致两个对象都无法被释放</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150750.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150750.png" alt="img"></a></p><h4 id="可达性分析算法" tabindex="-1"><a class="header-anchor" href="#可达性分析算法"><span>可达性分析算法</span></a></h4><ul><li>JVM中的垃圾回收器通过<strong>可达性分析</strong>来探索所有存活的对象</li><li>扫描堆中的对象，看能否沿着GC Root对象为起点的引用链找到该对象，如果<strong>找不到，则表示可以回收</strong></li><li>可以作为GC Root的对象 <ul><li>虚拟机栈（栈帧中的本地变量表）中引用的对象。</li><li>方法区中类静态属性引用的对象</li><li>方法区中常量引用的对象</li><li>本地方法栈中JNI（即一般说的Native方法）引用的对象</li></ul></li></ul><h4 id="五种引用" tabindex="-1"><a class="header-anchor" href="#五种引用"><span>五种引用</span></a></h4><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150800.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150800.png" alt="img"></a></p><h5 id="强引用" tabindex="-1"><a class="header-anchor" href="#强引用"><span>强引用</span></a></h5><p>只有GC Root<strong>都不引用</strong>该对象时，才会回收<strong>强引用</strong>对象</p><p><img src="/img/9.png" alt="image-20220104181028794"></p><ul><li>如上图B、C对象都不引用A1对象时，A1对象才会被回收</li></ul><h5 id="软引用" tabindex="-1"><a class="header-anchor" href="#软引用"><span>软引用</span></a></h5><p>当GC Root指向软引用对象时，在<strong>内存不足时</strong>，会<strong>回收软引用所引用的对象</strong></p><p><img src="/img/10.png" alt="image-20220104181306315"></p><ul><li>如上图如果B对象不再引用A2对象且内存不足时，软引用所引用的A2对象就会被回收</li></ul><h6 id="软引用的使用" tabindex="-1"><a class="header-anchor" href="#软引用的使用"><span>软引用的使用</span></a></h6><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token keyword">final</span> <span class="token keyword">int</span> _4M <span class="token operator">=</span> <span class="token number">4</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token comment">//使用软引用对象 list和SoftReference是强引用，而SoftReference和byte数组则是软引用</span></span>\n<span class="line">\t\t<span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">SoftReference</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token class-name">SoftReference</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> ref<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoftReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>_4M<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果在垃圾回收时发现内存不足，在回收软引用所指向的对象时，<strong>软引用本身不会被清理</strong></p><p>如果想要<strong>清理软引用</strong>，需要使<strong>用引用队列</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token keyword">final</span> <span class="token keyword">int</span> _4M <span class="token operator">=</span> <span class="token number">4</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token comment">//使用引用队列，用于移除引用为空的软引用对象</span></span>\n<span class="line">\t\t<span class="token class-name">ReferenceQueue</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token comment">//使用软引用对象 list和SoftReference是强引用，而SoftReference和byte数组则是软引用</span></span>\n<span class="line">\t\t<span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">SoftReference</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token class-name">SoftReference</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> ref<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoftReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>_4M<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">\t\t<span class="token comment">//遍历引用队列，如果有元素，则移除</span></span>\n<span class="line">\t\t<span class="token class-name">Reference</span><span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> poll <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token keyword">while</span><span class="token punctuation">(</span>poll <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t<span class="token comment">//引用队列不为空，则从集合中移除该元素</span></span>\n<span class="line">\t\t\tlist<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>poll<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t<span class="token comment">//移动到引用队列中的下一个元素</span></span>\n<span class="line">\t\t\tpoll <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**大概思路为：**查看引用队列中有无软引用，如果有，则将该软引用从存放它的集合中移除（这里为一个list集合）</p><h5 id="弱引用" tabindex="-1"><a class="header-anchor" href="#弱引用"><span>弱引用</span></a></h5><p>只有弱引用引用该对象时，在垃圾回收时，<strong>无论内存是否充足</strong>，都会回收弱引用所引用的对象</p><p><img src="/img/11.png" alt="image-20220104181807555"></p><ul><li>如上图如果B对象不再引用A3对象，则A3对象会被回收</li></ul><p><strong>弱引用的使用和软引用类似</strong>，只是将 <strong>SoftReference 换为了 WeakReference</strong></p><h5 id="虚引用" tabindex="-1"><a class="header-anchor" href="#虚引用"><span><strong>虚引用</strong></span></a></h5><p>当虚引用（引用）所引用的对象（对象）被回收以后，虚引用对象就会被放入引用队列中，调用虚引用的方法</p><ul><li>虚引用的一个体现是<strong>释放直接内存所分配的内存</strong>，当引用的对象ByteBuffer被垃圾回收以后，虚引用对象Cleaner就会被放入引用队列中，然后调用Cleaner的clean方法来释放直接内存</li><li>如上图，B对象不再引用ByteBuffer对象，ByteBuffer就会被回收。但是直接内存中的内存还未被回收。这时需要将虚引用对象Cleaner放入引用队列中，然后调用它的clean方法来释放直接内存</li></ul><h5 id="终结器引用" tabindex="-1"><a class="header-anchor" href="#终结器引用"><span>终结器引用</span></a></h5><p>所有的类都继承自Object类，Object类有一个finalize方法。当某个对象不再被其他的对象所引用时，会先将终结器引用对象放入引用队列中，然后根据终结器引用对象找到它所引用的对象，然后调用该对象的finalize方法。调用以后，该对象就可以被垃圾回收了</p><ul><li>如上图，B对象不再引用A4对象。这时终结器对象就会被放入引用队列中，引用队列会根据它，找到它所引用的对象。然后调用被引用对象的finalize方法。调用以后，该对象就可以被垃圾回收了</li></ul><h5 id="引用队列" tabindex="-1"><a class="header-anchor" href="#引用队列"><span>引用队列</span></a></h5><ul><li>软引用和弱引用<strong>可以配合</strong>引用队列 <ul><li>在<strong>软引用</strong>和<strong>弱引用</strong>所引用的对象被回收以后，会将这些引用放入引用队列中，方便一起回收这些软/弱引用对象</li></ul></li><li>虚引用和终结器引用<strong>必须配合</strong>引用队列 <ul><li>虚引用和终结器引用在使用时会关联一个引用队列</li></ul></li></ul><h3 id="_2、垃圾回收算法" tabindex="-1"><a class="header-anchor" href="#_2、垃圾回收算法"><span>2、垃圾回收算法</span></a></h3><h4 id="标记-清除" tabindex="-1"><a class="header-anchor" href="#标记-清除"><span>标记-清除</span></a></h4><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150813.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150813.png" alt="img"></a></p><p><strong>定义</strong>：标记清除算法顾名思义，是指在虚拟机执行垃圾回收的过程中，先采用标记算法确定可回收对象，然后垃圾收集器根据标识清除相应的内容，给堆内存腾出相应的空间</p><ul><li>这里的腾出内存空间并不是将内存空间的字节清0，而是记录下这段内存的起始结束地址，下次分配内存的时候，会直接<strong>覆盖</strong>这段内存</li></ul><p><strong>缺点</strong>：<strong>容易产生大量的内存碎片</strong>，可能无法满足大对象的内存分配，一旦导致无法分配对象，那就会导致jvm启动gc，一旦启动gc，我们的应用程序就会暂停，这就导致应用的响应速度变慢</p><h4 id="标记-整理" tabindex="-1"><a class="header-anchor" href="#标记-整理"><span>标记-整理</span></a></h4><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150827.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150827.png" alt="img"></a></p><p>标记-整理 会将不被GC Root引用的对象回收，清除其占用的内存空间。然后整理剩余的对象，可以有效避免因内存碎片而导致的问题，但是因为整体需要消耗一定的时间，所以效率较低</p><h4 id="复制" tabindex="-1"><a class="header-anchor" href="#复制"><span>复制</span></a></h4><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150842.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150842.png" alt="img"></a></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150856.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150856.png" alt="img"></a></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150907.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150907.png" alt="img"></a></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150919.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150919.png" alt="img"></a></p><p>将内存分为等大小的两个区域，FROM和TO（TO中为空）。先将被GC Root引用的对象从FROM放入TO中，再回收不被GC Root引用的对象。然后交换FROM和TO。这样也可以避免内存碎片的问题，但是会占用双倍的内存空间。</p><h3 id="_3、分代回收" tabindex="-1"><a class="header-anchor" href="#_3、分代回收"><span>3、分代回收</span></a></h3><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150931.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150931.png" alt="img"></a></p><h4 id="回收流程" tabindex="-1"><a class="header-anchor" href="#回收流程"><span>回收流程</span></a></h4><p>新创建的对象都被放在了<strong>新生代的伊甸园</strong>中</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150939.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150939.png" alt="img"></a></p><p>当伊甸园中的内存不足时，就会进行一次垃圾回收，这时的回收叫做 <strong>Minor GC</strong></p><p>Minor GC 会将<strong>伊甸园和幸存区FROM</strong>存活的对象<strong>先</strong>复制到 <strong>幸存区 TO</strong>中， 并让其<strong>寿命加1</strong>，再<strong>交换两个幸存区</strong></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150946.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150946.png" alt="img"></a></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150955.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150955.png" alt="img"></a></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151002.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151002.png" alt="img"></a></p><p>再次创建对象，若新生代的伊甸园又满了，则会<strong>再次触发 Minor GC</strong>（会触发 <strong>stop the world</strong>， 暂停其他用户线程，只让垃圾回收线程工作），这时不仅会回收伊甸园中的垃圾，<strong>还会回收幸存区中的垃圾</strong>，再将活跃对象复制到幸存区TO中。回收以后会交换两个幸存区，并让幸存区中的对象<strong>寿命加1</strong></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151010.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151010.png" alt="img"></a></p><p>如果幸存区中的对象的<strong>寿命超过某个阈值</strong>（最大为15，4bit），就会被<strong>放入老年代</strong>中</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151018.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151018.png" alt="img"></a></p><p>如果新生代老年代中的内存都满了，就会先触发Minor GC，再触发<strong>Full GC</strong>，扫描<strong>新生代和老年代中</strong>所有不再使用的对象并回收。</p><p><img src="/img/12.png" alt="img"></p><h4 id="gc-分析" tabindex="-1"><a class="header-anchor" href="#gc-分析"><span>GC 分析</span></a></h4><h5 id="大对象处理策略" tabindex="-1"><a class="header-anchor" href="#大对象处理策略"><span>大对象处理策略</span></a></h5><p>当遇到一个<strong>较大的对象</strong>时，就算新生代的<strong>伊甸园</strong>为空，也<strong>无法容纳该对象</strong>时，会将该对象<strong>直接晋升为老年代</strong></p><h5 id="线程内存溢出" tabindex="-1"><a class="header-anchor" href="#线程内存溢出"><span>线程内存溢出</span></a></h5><p>某个线程的内存溢出了而抛异常（out of memory），不会让其他的线程结束运行</p><p>这是因为当一个线程<strong>抛出OOM异常后</strong>，<strong>它所占据的内存资源会全部被释放掉</strong>，从而不会影响其他线程的运行，<strong>进程依然正常</strong></p><h3 id="_4、垃圾回收器" tabindex="-1"><a class="header-anchor" href="#_4、垃圾回收器"><span>4、垃圾回收器</span></a></h3><h4 id="相关概念" tabindex="-1"><a class="header-anchor" href="#相关概念"><span>相关概念</span></a></h4><p><strong>并行收集</strong>：指多条垃圾收集线程并行工作，但此时<strong>用户线程仍处于等待状态</strong>。</p><p><strong>并发收集</strong>：指用户线程与垃圾收集线程<strong>同时工作</strong>（不一定是并行的可能会交替执行）。<strong>用户程序在继续运行</strong>，而垃圾收集程序运行在另一个CPU上</p><p><strong>吞吐量</strong>：即CPU用于<strong>运行用户代码的时间</strong>与CPU<strong>总消耗时间</strong>的比值（吞吐量 = 运行用户代码时间 / ( 运行用户代码时间 + 垃圾收集时间 )），也就是。例如：虚拟机共运行100分钟，垃圾收集器花掉1分钟，那么吞吐量就是99%</p><h4 id="串行" tabindex="-1"><a class="header-anchor" href="#串行"><span>串行</span></a></h4><ul><li>单线程</li><li>内存较小，个人电脑（CPU核数较少）</li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151027.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151027.png" alt="img"></a></p><p><strong>安全点</strong>：让其他线程都在这个点停下来，以免垃圾回收时移动对象地址，使得其他线程找不到被移动的对象</p><p>因为是串行的，所以只有一个垃圾回收线程。且在该线程执行回收工作时，其他线程进入<strong>阻塞</strong>状态</p><h5 id="serial-收集器" tabindex="-1"><a class="header-anchor" href="#serial-收集器"><span>Serial 收集器</span></a></h5><p>Serial收集器是最基本的、发展历史最悠久的收集器</p><p><strong>特点：<strong>单线程、简单高效（与其他收集器的单线程相比），采用</strong>复制算法</strong>。对于限定单个CPU的环境来说，Serial收集器由于没有线程交互的开销，专心做垃圾收集自然可以获得最高的单线程收集效率。收集器进行垃圾回收时，必须暂停其他所有的工作线程，直到它结束（Stop The World）</p><h5 id="parnew-收集器" tabindex="-1"><a class="header-anchor" href="#parnew-收集器"><span>ParNew 收集器</span></a></h5><p>ParNew收集器其实就是Serial收集器的多线程版本</p><p><strong>特点</strong>：多线程、ParNew收集器默认开启的收集线程数与CPU的数量相同，在CPU非常多的环境中，可以使用-XX:ParallelGCThreads参数来限制垃圾收集的线程数。和Serial收集器一样存在Stop The World问题</p><h5 id="serial-old-收集器" tabindex="-1"><a class="header-anchor" href="#serial-old-收集器"><span>Serial Old 收集器</span></a></h5><p>Serial Old是Serial收集器的老年代版本</p><p><strong>特点</strong>：同样是单线程收集器，采用<strong>标记-整理算法</strong></p><h4 id="吞吐量优先" tabindex="-1"><a class="header-anchor" href="#吞吐量优先"><span>吞吐量优先</span></a></h4><ul><li>多线程</li><li>堆内存较大，多核CPU</li><li>单位时间内，STW（stop the world，停掉其他所有工作线程）时间最短</li><li><strong>JDK1.8默认使用</strong>的垃圾回收器</li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151039.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151039.png" alt="img"></a></p><h5 id="parallel-scavenge-收集器" tabindex="-1"><a class="header-anchor" href="#parallel-scavenge-收集器"><span>Parallel Scavenge 收集器</span></a></h5><p>与吞吐量关系密切，故也称为吞吐量优先收集器</p><p><strong>特点</strong>：属于新生代收集器也是采用<strong>复制算法</strong>的收集器（用到了新生代的幸存区），又是并行的多线程收集器（与ParNew收集器类似）</p><p>该收集器的目标是达到一个可控制的吞吐量。还有一个值得关注的点是：<strong>GC自适应调节策略</strong>（与ParNew收集器最重要的一个区别）</p><p><strong>GC自适应调节策略</strong>：Parallel Scavenge收集器可设置-XX:+UseAdptiveSizePolicy参数。当开关打开时<strong>不需要</strong>手动指定新生代的大小（-Xmn）、Eden与Survivor区的比例（-XX:SurvivorRation）、晋升老年代的对象年龄（-XX:PretenureSizeThreshold）等，虚拟机会根据系统的运行状况收集性能监控信息，动态设置这些参数以提供最优的停顿时间和最高的吞吐量，这种调节方式称为GC的自适应调节策略。</p><p>Parallel Scavenge收集器使用两个参数控制吞吐量：</p><ul><li>XX:MaxGCPauseMillis 控制最大的垃圾收集停顿时间</li><li>XX:GCRatio 直接设置吞吐量的大小</li></ul><h5 id="parallel-old-收集器" tabindex="-1"><a class="header-anchor" href="#parallel-old-收集器"><span><strong>Parallel Old 收集器</strong></span></a></h5><p>是Parallel Scavenge收集器的老年代版本</p><p><strong>特点</strong>：多线程，采用<strong>标记-整理算法</strong>（老年代没有幸存区）</p><h4 id="响应时间优先" tabindex="-1"><a class="header-anchor" href="#响应时间优先"><span>响应时间优先</span></a></h4><ul><li>多线程</li><li>堆内存较大，多核CPU</li><li>尽可能让单次STW时间变短（尽量不影响其他线程运行）</li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151052.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151052.png" alt="img"></a></p><h5 id="cms-收集器" tabindex="-1"><a class="header-anchor" href="#cms-收集器"><span>CMS 收集器</span></a></h5><p>Concurrent Mark Sweep，一种以获取<strong>最短回收停顿时间</strong>为目标的<strong>老年代</strong>收集器</p><p><strong>特点</strong>：基于<strong>标记-清除算法</strong>实现。并发收集、低停顿，但是会产生内存碎片</p><p><strong>应用场景</strong>：适用于注重服务的响应速度，希望系统停顿时间最短，给用户带来更好的体验等场景下。如web程序、b/s服务</p><p><strong>CMS收集器的运行过程分为下列4步：</strong></p><p><strong>初始标记</strong>：标记GC Roots能直接到的对象。速度很快但是<strong>仍存在Stop The World问题</strong></p><p><strong>并发标记</strong>：进行GC Roots Tracing 的过程，找出存活对象且用户线程可并发执行</p><p><strong>重新标记</strong>：为了<strong>修正并发标记期间</strong>因用户程序继续运行而导致标记产生变动的那一部分对象的标记记录。仍然存在Stop The World问题</p><p><strong>并发清除</strong>：对标记的对象进行清除回收</p><p>CMS收集器的内存回收过程是与用户线程一起<strong>并发执行</strong>的</p><h4 id="g1" tabindex="-1"><a class="header-anchor" href="#g1"><span>G1</span></a></h4><h5 id="定义-3" tabindex="-1"><a class="header-anchor" href="#定义-3"><span><strong>定义</strong>：</span></a></h5><p>Garbage One</p><p>JDK 9以后默认使用，而且替代了CMS 收集器</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200909201212.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200909201212.png" alt="img"></a></p><h5 id="适用场景" tabindex="-1"><a class="header-anchor" href="#适用场景"><span>适用场景</span></a></h5><ul><li>同时注重吞吐量和低延迟（响应时间）</li><li>超大堆内存（内存大的），会将堆内存划分为多个<strong>大小相等</strong>的区域</li><li>整体上是<strong>标记-整理</strong>算法，两个区域之间是<strong>复制</strong>算法</li></ul><p><strong>相关参数</strong>：JDK8 并不是默认开启的，所需要参数开启</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151100.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151100.png" alt="img"></a></p><h5 id="g1垃圾回收阶段" tabindex="-1"><a class="header-anchor" href="#g1垃圾回收阶段"><span>G1垃圾回收阶段</span></a></h5><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151109.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151109.png" alt="img"></a></p><p>新生代伊甸园垃圾回收—–&gt;内存不足，新生代回收+并发标记—–&gt;回收新生代伊甸园、幸存区、老年代内存——&gt;新生代伊甸园垃圾回收(重新开始)</p><h5 id="young-collection" tabindex="-1"><a class="header-anchor" href="#young-collection"><span>Young Collection</span></a></h5><p><strong>分区算法region</strong></p><p>分代是按对象的生命周期划分，分区则是将堆空间划分连续几个不同小区间，每一个小区间独立回收，可以控制一次回收多少个小区间，方便控制 GC 产生的停顿时间</p><p>E：伊甸园 S：幸存区 O：老年代</p><ul><li>会STW</li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151119.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151119.png" alt="img"></a></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151129.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151129.png" alt="img"></a></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151140.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151140.png" alt="img"></a></p><h5 id="young-collection-cm" tabindex="-1"><a class="header-anchor" href="#young-collection-cm"><span>Young Collection + CM</span></a></h5><p>CM：并发标记</p><ul><li>在 Young GC 时会<strong>对 GC Root 进行初始标记</strong></li><li>在老年代<strong>占用堆内存的比例</strong>达到阈值时，会进行并发标记（不会STW），阈值可以根据用户来进行设定</li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151150.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151150.png" alt="img"></a></p><h5 id="mixed-collection" tabindex="-1"><a class="header-anchor" href="#mixed-collection"><span>Mixed Collection</span></a></h5><p>会对E S O 进行<strong>全面的回收</strong></p><ul><li>最终标记</li><li><strong>拷贝</strong>存活</li></ul><p>-XX:MaxGCPauseMills:xxx 用于指定最长的停顿时间</p><p><strong>问</strong>：为什么有的老年代被拷贝了，有的没拷贝？</p><p>因为指定了最大停顿时间，如果对所有老年代都进行回收，耗时可能过高。为了保证时间不超过设定的停顿时间，会<strong>回收最有价值的老年代</strong>（回收后，能够得到更多内存）</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151201.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151201.png" alt="img"></a></p><h5 id="full-gc" tabindex="-1"><a class="header-anchor" href="#full-gc"><span>Full GC</span></a></h5><p>G1在老年代内存不足时（老年代所占内存超过阈值）</p><ul><li>如果垃圾产生速度慢于垃圾回收速度，不会触发Full GC，还是并发地进行清理</li><li>如果垃圾产生速度快于垃圾回收速度，便会触发Full GC</li></ul><h5 id="young-collection-跨代引用" tabindex="-1"><a class="header-anchor" href="#young-collection-跨代引用"><span>Young Collection 跨代引用</span></a></h5><ul><li>新生代回收的跨代引用（老年代引用新生代）问题</li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151211.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151211.png" alt="img"></a></p><ul><li>卡表与Remembered Set <ul><li>Remembered Set 存在于E中，用于保存新生代对象对应的脏卡 <ul><li>脏卡：O被划分为多个区域（一个区域512K），如果该区域引用了新生代对象，则该区域被称为脏卡</li></ul></li></ul></li><li>在引用变更时通过post-write barried + dirty card queue</li><li>concurrent refinement threads 更新 Remembered Set</li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151222.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151222.png" alt="img"></a></p><h5 id="remark" tabindex="-1"><a class="header-anchor" href="#remark"><span>Remark</span></a></h5><p>重新标记阶段</p><p>在垃圾回收时，收集器处理对象的过程中</p><p>黑色：已被处理，需要保留的 灰色：正在处理中的 白色：还未处理的</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151229.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151229.png" alt="img"></a></p><p>但是在<strong>并发标记过程中</strong>，有可能A被处理了以后未引用C，但该处理过程还未结束，在处理过程结束之前A引用了C，这时就会用到remark</p><p>过程如下</p><ul><li>之前C未被引用，这时A引用了C，就会给C加一个写屏障，写屏障的指令会被执行，将C放入一个队列当中，并将C变为 处理中 状态</li><li>在<strong>并发标记</strong>阶段结束以后，重新标记阶段会STW，然后将放在该队列中的对象重新处理，发现有强引用引用它，就会处理它</li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151239.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151239.png" alt="img"></a></p><h5 id="jdk-8u20-字符串去重" tabindex="-1"><a class="header-anchor" href="#jdk-8u20-字符串去重"><span>JDK 8u20 字符串去重</span></a></h5><p>过程</p><ul><li>将所有新分配的字符串（底层是char[]）放入一个队列</li><li>当新生代回收时，G1并发检查是否有重复的字符串</li><li>如果字符串的值一样，就让他们<strong>引用同一个字符串对象</strong></li><li>注意，其与String.intern的区别 <ul><li>intern关注的是字符串对象</li><li>字符串去重关注的是char[]</li><li>在JVM内部，使用了不同的字符串标</li></ul></li></ul><p>优点与缺点</p><ul><li>节省了大量内存</li><li>新生代回收时间略微增加，导致略微多占用CPU</li></ul><h5 id="jdk-8u40-并发标记类卸载" tabindex="-1"><a class="header-anchor" href="#jdk-8u40-并发标记类卸载"><span>JDK 8u40 并发标记类卸载</span></a></h5><p>在并发标记阶段结束以后，就能知道哪些类不再被使用。如果一个类加载器的所有类都不在使用，则卸载它所加载的所有类</p><h5 id="jdk-8u60-回收巨型对象" tabindex="-1"><a class="header-anchor" href="#jdk-8u60-回收巨型对象"><span>JDK 8u60 回收巨型对象</span></a></h5><ul><li>一个对象大于region的一半时，就称为巨型对象</li><li>G1不会对巨型对象进行拷贝</li><li>回收时被优先考虑</li><li>G1会跟踪老年代所有incoming引用，如果老年代incoming引用为0的巨型对象就可以在新生代垃圾回收时处理掉</li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151249.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151249.png" alt="img"></a></p><h3 id="_5、gc-调优" tabindex="-1"><a class="header-anchor" href="#_5、gc-调优"><span>5、GC 调优</span></a></h3><p>查看虚拟机参数命令</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token string">&quot;F:\\JAVA\\JDK8.0<span class="token entity" title="\\b">\\b</span>in\\java&quot;</span> <span class="token parameter variable">-XX:+PrintFlagsFinal</span> <span class="token parameter variable">-version</span> <span class="token operator">|</span> findstr <span class="token string">&quot;GC&quot;</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>可以根据参数去查询具体的信息</p><h4 id="调优领域" tabindex="-1"><a class="header-anchor" href="#调优领域"><span>调优领域</span></a></h4><ul><li>内存</li><li>锁竞争</li><li>CPU占用</li><li>IO</li><li>GC</li></ul><h4 id="确定目标" tabindex="-1"><a class="header-anchor" href="#确定目标"><span>确定目标</span></a></h4><p>低延迟/高吞吐量？ 选择合适的GC</p><ul><li>CMS G1 ZGC</li><li>ParallelGC</li><li>Zing</li></ul><h4 id="最快的gc是不发生gc" tabindex="-1"><a class="header-anchor" href="#最快的gc是不发生gc"><span>最快的GC是不发生GC</span></a></h4><p>首先排除减少因为自身编写的代码而引发的内存问题</p><ul><li>查看Full GC前后的内存占用，考虑以下几个问题 <ul><li>数据是不是太多？</li><li>数据表示是否太臃肿 <ul><li>对象图</li><li>对象大小</li></ul></li><li>是否存在内存泄漏</li></ul></li></ul><h4 id="新生代调优" tabindex="-1"><a class="header-anchor" href="#新生代调优"><span>新生代调优</span></a></h4><ul><li>新生代的特点 <ul><li>所有的new操作分配内存都是非常廉价的 <ul><li>TLAB</li></ul></li><li>死亡对象回收零代价</li><li>大部分对象用过即死（朝生夕死）</li><li>MInor GC 所用时间远小于Full GC</li></ul></li><li>新生代内存越大越好么？ <ul><li>不是 <ul><li>新生代内存太小：频繁触发Minor GC，会STW，会使得吞吐量下降</li><li>新生代内存太大：老年代内存占比有所降低，会更频繁地触发Full GC。而且触发Minor GC时，清理新生代所花费的时间会更长</li></ul></li><li>新生代内存设置为内容纳[并发量*(请求-响应)]的数据为宜</li></ul></li></ul><h4 id="幸存区调优" tabindex="-1"><a class="header-anchor" href="#幸存区调优"><span>幸存区调优</span></a></h4><ul><li>幸存区需要能够保存 <strong>当前活跃对象</strong>+<strong>需要晋升的对象</strong></li><li>晋升阈值配置得当，让长时间存活的对象尽快晋升</li></ul><h4 id="老年代调优" tabindex="-1"><a class="header-anchor" href="#老年代调优"><span>老年代调优</span></a></h4><h2 id="类加载与字节码技术" tabindex="-1"><a class="header-anchor" href="#类加载与字节码技术"><span>类加载与字节码技术</span></a></h2><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151300.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151300.png" alt="img"></a></p><h3 id="_1、类文件结构" tabindex="-1"><a class="header-anchor" href="#_1、类文件结构"><span>1、类文件结构</span></a></h3><p>首先获得.class字节码文件</p><p>方法：</p><ul><li>在文本文档里写入java代码（文件名与类名一致），将文件类型改为.java</li><li>java终端中，执行javac X:...\\XXX.java</li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200910155135.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200910155135.png" alt="img"></a></p><p>以下是字节码文件</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">0000000 ca fe ba be 00 00 00 <span class="token number">34</span> 00 <span class="token number">23</span> 0a 00 06 00 <span class="token number">15</span> 09 </span>\n<span class="line">0000020 00 <span class="token number">16</span> 00 <span class="token number">17</span> 08 00 <span class="token number">18</span> 0a 00 <span class="token number">19</span> 00 1a 07 00 1b 07 </span>\n<span class="line">0000040 00 1c 01 00 06 3c <span class="token number">69</span> 6e <span class="token number">69</span> <span class="token number">74</span> 3e 01 00 03 <span class="token number">28</span> <span class="token number">29</span> </span>\n<span class="line">0000060 <span class="token number">56</span> 01 00 04 <span class="token number">43</span> 6f <span class="token number">64</span> <span class="token number">65</span> 01 00 0f 4c <span class="token number">69</span> 6e <span class="token number">65</span> 4e </span>\n<span class="line">0000100 <span class="token number">75</span> 6d <span class="token number">62</span> <span class="token number">65</span> <span class="token number">72</span> <span class="token number">54</span> <span class="token number">61</span> <span class="token number">62</span> 6c <span class="token number">65</span> 01 00 <span class="token number">12</span> 4c 6f <span class="token number">63</span> </span>\n<span class="line">0000120 <span class="token number">61</span> 6c <span class="token number">56</span> <span class="token number">61</span> <span class="token number">72</span> <span class="token number">69</span> <span class="token number">61</span> <span class="token number">62</span> 6c <span class="token number">65</span> <span class="token number">54</span> <span class="token number">61</span> <span class="token number">62</span> 6c <span class="token number">65</span> 01 </span>\n<span class="line">0000140 00 04 <span class="token number">74</span> <span class="token number">68</span> <span class="token number">69</span> <span class="token number">73</span> 01 00 1d 4c <span class="token number">63</span> 6e 2f <span class="token number">69</span> <span class="token number">74</span> <span class="token number">63</span> </span>\n<span class="line">0000160 <span class="token number">61</span> <span class="token number">73</span> <span class="token number">74</span> 2f 6a <span class="token number">76</span> 6d 2f <span class="token number">74</span> <span class="token number">35</span> 2f <span class="token number">48</span> <span class="token number">65</span> 6c 6c 6f </span>\n<span class="line">0000200 <span class="token number">57</span> 6f <span class="token number">72</span> 6c <span class="token number">64</span> 3b 01 00 04 6d <span class="token number">61</span> <span class="token number">69</span> 6e 01 00 <span class="token number">16</span> </span>\n<span class="line">0000220 <span class="token number">28</span> 5b 4c 6a <span class="token number">61</span> <span class="token number">76</span> <span class="token number">61</span> 2f 6c <span class="token number">61</span> 6e <span class="token number">67</span> 2f <span class="token number">53</span> <span class="token number">74</span> <span class="token number">72</span> </span>\n<span class="line">0000240 <span class="token number">69</span> 6e <span class="token number">67</span> 3b <span class="token number">29</span> <span class="token number">56</span> 01 00 04 <span class="token number">61</span> <span class="token number">72</span> <span class="token number">67</span> <span class="token number">73</span> 01 00 <span class="token number">13</span> </span>\n<span class="line">0000260 5b 4c 6a <span class="token number">61</span> <span class="token number">76</span> <span class="token number">61</span> 2f 6c <span class="token number">61</span> 6e <span class="token number">67</span> 2f <span class="token number">53</span> <span class="token number">74</span> <span class="token number">72</span> <span class="token number">69</span> </span>\n<span class="line">0000300 6e <span class="token number">67</span> 3b 01 00 <span class="token number">10</span> 4d <span class="token number">65</span> <span class="token number">74</span> <span class="token number">68</span> 6f <span class="token number">64</span> <span class="token number">50</span> <span class="token number">61</span> <span class="token number">72</span> <span class="token number">61</span> </span>\n<span class="line">0000320 6d <span class="token number">65</span> <span class="token number">74</span> <span class="token number">65</span> <span class="token number">72</span> <span class="token number">73</span> 01 00 0a <span class="token number">53</span> 6f <span class="token number">75</span> <span class="token number">72</span> <span class="token number">63</span> <span class="token number">65</span> <span class="token number">46</span> </span>\n<span class="line">0000340 <span class="token number">69</span> 6c <span class="token number">65</span> 01 00 0f <span class="token number">48</span> <span class="token number">65</span> 6c 6c 6f <span class="token number">57</span> 6f <span class="token number">72</span> 6c <span class="token number">64</span></span>\n<span class="line">0000360 2e 6a <span class="token number">61</span> <span class="token number">76</span> <span class="token number">61</span> 0c 00 07 00 08 07 00 1d 0c 00 1e </span>\n<span class="line">0000400 00 1f 01 00 0b <span class="token number">68</span> <span class="token number">65</span> 6c 6c 6f <span class="token number">20</span> <span class="token number">77</span> 6f <span class="token number">72</span> 6c <span class="token number">64</span> </span>\n<span class="line">0000420 07 00 <span class="token number">20</span> 0c 00 <span class="token number">21</span> 00 <span class="token number">22</span> 01 00 1b <span class="token number">63</span> 6e 2f <span class="token number">69</span> <span class="token number">74</span> </span>\n<span class="line">0000440 <span class="token number">63</span> <span class="token number">61</span> <span class="token number">73</span> <span class="token number">74</span> 2f 6a <span class="token number">76</span> 6d 2f <span class="token number">74</span> <span class="token number">35</span> 2f <span class="token number">48</span> <span class="token number">65</span> 6c 6c </span>\n<span class="line">0000460 6f <span class="token number">57</span> 6f <span class="token number">72</span> 6c <span class="token number">64</span> 01 00 <span class="token number">10</span> 6a <span class="token number">61</span> <span class="token number">76</span> <span class="token number">61</span> 2f 6c <span class="token number">61</span> </span>\n<span class="line">0000500 6e <span class="token number">67</span> 2f 4f <span class="token number">62</span> 6a <span class="token number">65</span> <span class="token number">63</span> <span class="token number">74</span> 01 00 <span class="token number">10</span> 6a <span class="token number">61</span> <span class="token number">76</span> <span class="token number">61</span> </span>\n<span class="line">0000520 2f 6c <span class="token number">61</span> 6e <span class="token number">67</span> 2f <span class="token number">53</span> <span class="token number">79</span> <span class="token number">73</span> <span class="token number">74</span> <span class="token number">65</span> 6d 01 00 03 6f </span>\n<span class="line">0000540 <span class="token number">75</span> <span class="token number">74</span> 01 00 <span class="token number">15</span> 4c 6a <span class="token number">61</span> <span class="token number">76</span> <span class="token number">61</span> 2f <span class="token number">69</span> 6f 2f <span class="token number">50</span> <span class="token number">72</span> </span>\n<span class="line">0000560 <span class="token number">69</span> 6e <span class="token number">74</span> <span class="token number">53</span> <span class="token number">74</span> <span class="token number">72</span> <span class="token number">65</span> <span class="token number">61</span> 6d 3b 01 00 <span class="token number">13</span> 6a <span class="token number">61</span> <span class="token number">76</span> </span>\n<span class="line">0000600 <span class="token number">61</span> 2f <span class="token number">69</span> 6f 2f <span class="token number">50</span> <span class="token number">72</span> <span class="token number">69</span> 6e <span class="token number">74</span> <span class="token number">53</span> <span class="token number">74</span> <span class="token number">72</span> <span class="token number">65</span> <span class="token number">61</span> 6d </span>\n<span class="line">0000620 01 00 07 <span class="token number">70</span> <span class="token number">72</span> <span class="token number">69</span> 6e <span class="token number">74</span> 6c 6e 01 00 <span class="token number">15</span> <span class="token number">28</span> 4c 6a </span>\n<span class="line">0000640 <span class="token number">61</span> <span class="token number">76</span> <span class="token number">61</span> 2f 6c <span class="token number">61</span> 6e <span class="token number">67</span> 2f <span class="token number">53</span> <span class="token number">74</span> <span class="token number">72</span> <span class="token number">69</span> 6e <span class="token number">67</span> 3b </span>\n<span class="line">0000660 <span class="token number">29</span> <span class="token number">56</span> 00 <span class="token number">21</span> 00 05 00 06 00 00 00 00 00 02 00 01 </span>\n<span class="line">0000700 00 07 00 08 00 01 00 09 00 00 00 2f 00 01 00 01 </span>\n<span class="line">0000720 00 00 00 05 2a b7 00 01 b1 00 00 00 02 00 0a 00 </span>\n<span class="line">0000740 00 00 06 00 01 00 00 00 04 00 0b 00 00 00 0c 00 </span>\n<span class="line">0000760 01 00 00 00 05 00 0c 00 0d 00 00 00 09 00 0e 00 </span>\n<span class="line">0001000 0f 00 02 00 09 00 00 00 <span class="token number">37</span> 00 02 00 01 00 00 00 </span>\n<span class="line">0001020 09 b2 00 02 <span class="token number">12</span> 03 b6 00 04 b1 00 00 00 02 00 0a </span>\n<span class="line">0001040 00 00 00 0a 00 02 00 00 00 06 00 08 00 07 00 0b </span>\n<span class="line">0001060 00 00 00 0c 00 01 00 00 00 09 00 <span class="token number">10</span> 00 <span class="token number">11</span> 00 00 </span>\n<span class="line">0001100 00 <span class="token number">12</span> 00 00 00 05 01 00 <span class="token number">10</span> 00 00 00 01 00 <span class="token number">13</span> 00 </span>\n<span class="line">0001120 00 00 02 00 <span class="token number">14</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据 JVM 规范，<strong>类文件结构</strong>如下</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">u4 \t\t\t magic</span>\n<span class="line">u2             minor_version<span class="token punctuation">;</span>    </span>\n<span class="line">u2             major_version<span class="token punctuation">;</span>    </span>\n<span class="line">u2             constant_pool_count<span class="token punctuation">;</span>    </span>\n<span class="line">cp_info        constant_pool<span class="token punctuation">[</span>constant_pool_count-1<span class="token punctuation">]</span><span class="token punctuation">;</span>    </span>\n<span class="line">u2             access_flags<span class="token punctuation">;</span>    </span>\n<span class="line">u2             this_class<span class="token punctuation">;</span>    </span>\n<span class="line">u2             super_class<span class="token punctuation">;</span>   </span>\n<span class="line">u2             interfaces_count<span class="token punctuation">;</span>    </span>\n<span class="line">u2             interfaces<span class="token punctuation">[</span>interfaces_count<span class="token punctuation">]</span><span class="token punctuation">;</span>   </span>\n<span class="line">u2             fields_count<span class="token punctuation">;</span>    </span>\n<span class="line">field_info     fields<span class="token punctuation">[</span>fields_count<span class="token punctuation">]</span><span class="token punctuation">;</span>   </span>\n<span class="line">u2             methods_count<span class="token punctuation">;</span>    </span>\n<span class="line">method_info    methods<span class="token punctuation">[</span>methods_count<span class="token punctuation">]</span><span class="token punctuation">;</span>    </span>\n<span class="line">u2             attributes_count<span class="token punctuation">;</span>    </span>\n<span class="line">attribute_info attributes<span class="token punctuation">[</span>attributes_count<span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="魔数" tabindex="-1"><a class="header-anchor" href="#魔数"><span>魔数</span></a></h4><p>u4 magic</p><p>对应字节码文件的0~3个字节</p><p>0000000 <strong>ca fe ba be</strong> 00 00 00 34 00 23 0a 00 06 00 15 09</p><h4 id="版本" tabindex="-1"><a class="header-anchor" href="#版本"><span>版本</span></a></h4><p>u2 minor_version;</p><p>u2 major_version;</p><p>0000000 ca fe ba be <strong>00 00 00 34</strong> 00 23 0a 00 06 00 15 09</p><p>34H = 52，代表JDK8</p><h4 id="常量池-1" tabindex="-1"><a class="header-anchor" href="#常量池-1"><span>常量池</span></a></h4><p>见资料文件</p><p>…略</p><h3 id="_2、字节码指令" tabindex="-1"><a class="header-anchor" href="#_2、字节码指令"><span>2、字节码指令</span></a></h3><p>可参考</p><p>https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5</p><h4 id="javap工具" tabindex="-1"><a class="header-anchor" href="#javap工具"><span>javap工具</span></a></h4><p>Oracle 提供了 <strong>javap</strong> 工具来反编译 class 文件</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">javap -v F:\\Thread_study\\src\\com\\nyima\\JVM\\day01\\Main.class</span>\n<span class="line">F:\\Thread_study&gt;javap -v F:\\Thread_study\\src\\com\\nyima\\JVM\\day5\\Demo1.class</span>\n<span class="line">Classfile /F:/Thread_study/src/com/nyima/JVM/day5/Demo1.class</span>\n<span class="line">  Last modified 2020-6-6; size 434 bytes</span>\n<span class="line">  MD5 checksum df1dce65bf6fb0b4c1de318051f4a67e</span>\n<span class="line">  Compiled from &quot;Demo1.java&quot;</span>\n<span class="line">public class com.nyima.JVM.day5.Demo1</span>\n<span class="line">  minor version: 0</span>\n<span class="line">  major version: 52</span>\n<span class="line">  flags: ACC_PUBLIC, ACC_SUPER</span>\n<span class="line">Constant pool:</span>\n<span class="line">   #1 = Methodref          #6.#15         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span>\n<span class="line">   #2 = Fieldref           #16.#17        // java/lang/System.out:Ljava/io/PrintStream;</span>\n<span class="line">   #3 = String             #18            // hello world</span>\n<span class="line">   #4 = Methodref          #19.#20        // java/io/PrintStream.println:(Ljava/lang/String;)V</span>\n<span class="line">   #5 = Class              #21            // com/nyima/JVM/day5/Demo1</span>\n<span class="line">   #6 = Class              #22            // java/lang/Object</span>\n<span class="line">   #7 = Utf8               &lt;init&gt;</span>\n<span class="line">   #8 = Utf8               ()V</span>\n<span class="line">   #9 = Utf8               Code</span>\n<span class="line">  #10 = Utf8               LineNumberTable</span>\n<span class="line">  #11 = Utf8               main</span>\n<span class="line">  #12 = Utf8               ([Ljava/lang/String;)V</span>\n<span class="line">  #13 = Utf8               SourceFile</span>\n<span class="line">  #14 = Utf8               Demo1.java</span>\n<span class="line">  #15 = NameAndType        #7:#8          // &quot;&lt;init&gt;&quot;:()V</span>\n<span class="line">  #16 = Class              #23            // java/lang/System</span>\n<span class="line">  #17 = NameAndType        #24:#25        // out:Ljava/io/PrintStream;</span>\n<span class="line">  #18 = Utf8               hello world</span>\n<span class="line">  #19 = Class              #26            // java/io/PrintStream</span>\n<span class="line">  #20 = NameAndType        #27:#28        // println:(Ljava/lang/String;)V</span>\n<span class="line">  #21 = Utf8               com/nyima/JVM/day5/Demo1</span>\n<span class="line">  #22 = Utf8               java/lang/Object</span>\n<span class="line">  #23 = Utf8               java/lang/System</span>\n<span class="line">  #24 = Utf8               out</span>\n<span class="line">  #25 = Utf8               Ljava/io/PrintStream;</span>\n<span class="line">  #26 = Utf8               java/io/PrintStream</span>\n<span class="line">  #27 = Utf8               println</span>\n<span class="line">  #28 = Utf8               (Ljava/lang/String;)V</span>\n<span class="line">{</span>\n<span class="line">  public com.nyima.JVM.day5.Demo1();</span>\n<span class="line">    descriptor: ()V</span>\n<span class="line">    flags: ACC_PUBLIC</span>\n<span class="line">    Code:</span>\n<span class="line">      stack=1, locals=1, args_size=1</span>\n<span class="line">         0: aload_0</span>\n<span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span>\n<span class="line">         4: return</span>\n<span class="line">      LineNumberTable:</span>\n<span class="line">        line 7: 0</span>\n<span class="line"></span>\n<span class="line">  public static void main(java.lang.String[]);</span>\n<span class="line">    descriptor: ([Ljava/lang/String;)V</span>\n<span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span>\n<span class="line">    Code:</span>\n<span class="line">      stack=2, locals=1, args_size=1</span>\n<span class="line">         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span>\n<span class="line">         3: ldc           #3                  // String hello world</span>\n<span class="line">         5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>\n<span class="line"></span>\n<span class="line">         8: return</span>\n<span class="line">      LineNumberTable:</span>\n<span class="line">        line 9: 0</span>\n<span class="line">        line 10: 8</span>\n<span class="line">}</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="图解方法执行流程" tabindex="-1"><a class="header-anchor" href="#图解方法执行流程"><span>图解方法执行流程</span></a></h4><p>代码</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3_1</span> <span class="token punctuation">{</span>    </span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        </span>\n<span class="line">\t\t<span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>        </span>\n<span class="line">\t\t<span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token class-name">Short</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        </span>\n<span class="line">\t\t<span class="token keyword">int</span> c <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>        </span>\n<span class="line">\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>   </span>\n<span class="line">    <span class="token punctuation">}</span> </span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>常量池载入运行时常量池</strong></p><p>常量池也属于方法区，只不过这里单独提出来了</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151317.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151317.png" alt="img"></a></p><p><strong>方法字节码载入方法区</strong></p><p>（stack=2，locals=4） 对应操作数栈有2个空间（每个空间4个字节），局部变量表中有4个槽位</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151325.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151325.png" alt="img"></a></p><p><strong>执行引擎开始执行字节码</strong></p><p><strong>bipush 10</strong></p><ul><li><p>将一个 byte 压入操作数栈</p><p>（其长度会补齐 4 个字节），类似的指令还有</p><ul><li>sipush 将一个 short 压入操作数栈（其长度会补齐 4 个字节）</li><li>ldc 将一个 int 压入操作数栈</li><li>ldc2_w 将一个 long 压入操作数栈（<strong>分两次压入</strong>，因为 long 是 8 个字节）</li><li>这里小的数字都是和字节码指令存在一起，<strong>超过 short 范围的数字存入了常量池</strong></li></ul></li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151336.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151336.png" alt="img"></a></p><p><strong>istore 1</strong></p><p>将操作数栈栈顶元素弹出，放入局部变量表的slot 1中</p><p>对应代码中的</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">a = 10</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151346.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151346.png" alt="img"></a></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151412.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151412.png" alt="img"></a></p><p><strong>ldc #3</strong></p><p>读取运行时常量池中#3，即32768(超过short最大值范围的数会被放到运行时常量池中)，将其加载到操作数栈中</p><p>注意 Short.MAX_VALUE 是 32767，所以 32768 = Short.MAX_VALUE + 1 实际是在编译期间计算好的</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151421.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151421.png" alt="img"></a></p><p><strong>istore 2</strong></p><p>将操作数栈中的元素弹出，放到局部变量表的2号位置</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151432.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151432.png" alt="img"></a></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151441.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151441.png" alt="img"></a></p><p><strong>iload1 iload2</strong></p><p>将局部变量表中1号位置和2号位置的元素放入操作数栈中</p><ul><li>因为只能在操作数栈中执行运算操作</li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151450.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151450.png" alt="img"></a></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151459.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151459.png" alt="img"></a></p><p><strong>iadd</strong></p><p>将操作数栈中的两个元素<strong>弹出栈</strong>并相加，结果在压入操作数栈中</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151508.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151508.png" alt="img"></a></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151523.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151523.png" alt="img"></a></p><p><strong>istore 3</strong></p><p>将操作数栈中的元素弹出，放入局部变量表的3号位置</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151547.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151547.png" alt="img"></a></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151555.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151555.png" alt="img"></a></p><p><strong>getstatic #4</strong></p><p>在运行时常量池中找到#4，发现是一个对象</p><p>在堆内存中找到该对象，并将其<strong>引用</strong>放入操作数栈中</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151605.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151605.png" alt="img"></a></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151613.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151613.png" alt="img"></a></p><p><strong>iload 3</strong></p><p>将局部变量表中3号位置的元素压入操作数栈中</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151624.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151624.png" alt="img"></a></p><p><strong>invokevirtual 5</strong></p><p>找到常量池 #5 项，定位到方法区 java/io/PrintStream.println:(I)V 方法</p><p>生成新的栈帧（分配 locals、stack等）</p><p>传递参数，执行新栈帧中的字节码</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151632.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151632.png" alt="img"></a></p><p>执行完毕，弹出栈帧</p><p>清除 main 操作数栈内容</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151640.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151640.png" alt="img"></a></p><p><strong>return</strong> 完成 main 方法调用，弹出 main 栈帧，程序结束</p><h4 id="通过字节码指令来分析问题" tabindex="-1"><a class="header-anchor" href="#通过字节码指令来分析问题"><span>通过字节码指令来分析问题</span></a></h4><p>代码</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo2</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token keyword">int</span> x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\tx <span class="token operator">=</span> x<span class="token operator">++</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\ti<span class="token operator">++</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//结果为0</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为什么最终的x结果为0呢？ 通过分析字节码指令即可知晓</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token class-name">Code</span><span class="token operator">:</span></span>\n<span class="line">     stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>\t<span class="token comment">//操作数栈分配2个空间，局部变量表分配3个空间</span></span>\n<span class="line">        <span class="token number">0</span><span class="token operator">:</span> iconst_0\t<span class="token comment">//准备一个常数0</span></span>\n<span class="line">        <span class="token number">1</span><span class="token operator">:</span> istore_1\t<span class="token comment">//将常数0放入局部变量表的1号槽位 i=0</span></span>\n<span class="line">        <span class="token number">2</span><span class="token operator">:</span> iconst_0\t<span class="token comment">//准备一个常数0</span></span>\n<span class="line">        <span class="token number">3</span><span class="token operator">:</span> istore_2\t<span class="token comment">//将常数0放入局部变量的2号槽位 x=0\t</span></span>\n<span class="line">        <span class="token number">4</span><span class="token operator">:</span> iload_1\t\t<span class="token comment">//将局部变量表1号槽位的数放入操作数栈中</span></span>\n<span class="line">        <span class="token number">5</span><span class="token operator">:</span> bipush        <span class="token number">10</span>\t<span class="token comment">//将数字10放入操作数栈中，此时操作数栈中有2个数</span></span>\n<span class="line">        <span class="token number">7</span><span class="token operator">:</span> if_icmpge     <span class="token number">21</span>\t<span class="token comment">//比较操作数栈中的两个数，如果下面的数大于上面的数，就跳转到21。这里的比较是将两个数做减法。因为涉及运算操作，所以会将两个数弹出操作数栈来进行运算。运算结束后操作数栈为空</span></span>\n<span class="line">       <span class="token number">10</span><span class="token operator">:</span> iload_2\t\t<span class="token comment">//将局部变量2号槽位的数放入操作数栈中，放入的值是0</span></span>\n<span class="line">       <span class="token number">11</span><span class="token operator">:</span> iinc          <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span>\t<span class="token comment">//将局部变量2号槽位的数加1，自增后，槽位中的值为1</span></span>\n<span class="line">       <span class="token number">14</span><span class="token operator">:</span> istore_2\t<span class="token comment">//将操作数栈中的数放入到局部变量表的2号槽位，2号槽位的值又变为了0</span></span>\n<span class="line">       <span class="token number">15</span><span class="token operator">:</span> iinc          <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">//1号槽位的值自增1</span></span>\n<span class="line">       <span class="token number">18</span><span class="token operator">:</span> <span class="token keyword">goto</span>          <span class="token number">4</span> <span class="token comment">//跳转到第4条指令</span></span>\n<span class="line">       <span class="token number">21</span><span class="token operator">:</span> getstatic     #<span class="token number">2</span>                  <span class="token comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span></span>\n<span class="line">       <span class="token number">24</span><span class="token operator">:</span> iload_2</span>\n<span class="line">       <span class="token number">25</span><span class="token operator">:</span> invokevirtual #<span class="token number">3</span>                  <span class="token comment">// Method java/io/PrintStream.println:(I)V</span></span>\n<span class="line">       <span class="token number">28</span><span class="token operator">:</span> <span class="token keyword">return</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="构造方法" tabindex="-1"><a class="header-anchor" href="#构造方法"><span>构造方法</span></a></h4><h5 id="cinit-v" tabindex="-1"><a class="header-anchor" href="#cinit-v"><span>cinit()V</span></a></h5><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">static</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token keyword">static</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\ti <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token keyword">static</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\ti <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//结果为30</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译器会按<strong>从上至下</strong>的顺序，收集所有 static 静态代码块和静态成员赋值的代码，<strong>合并</strong>为一个特殊的方法 cinit()V ：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">stack=1, locals=0, args_size=0</span>\n<span class="line">         0: bipush        10</span>\n<span class="line">         2: putstatic     #3                  // Field i:I</span>\n<span class="line">         5: bipush        20</span>\n<span class="line">         7: putstatic     #3                  // Field i:I</span>\n<span class="line">        10: bipush        30</span>\n<span class="line">        12: putstatic     #3                  // Field i:I</span>\n<span class="line">        15: return</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="init-v" tabindex="-1"><a class="header-anchor" href="#init-v"><span>init()V</span></a></h5><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo4</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">private</span> <span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token string">&quot;s1&quot;</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token punctuation">{</span></span>\n<span class="line">\t\tb <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token keyword">private</span> <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token punctuation">{</span></span>\n<span class="line">\t\ta <span class="token operator">=</span> <span class="token string">&quot;s2&quot;</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token class-name">Demo4</span><span class="token punctuation">(</span><span class="token class-name">String</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> a<span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token keyword">this</span><span class="token punctuation">.</span>b <span class="token operator">=</span> b<span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token class-name">Demo4</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Demo4</span><span class="token punctuation">(</span><span class="token string">&quot;s3&quot;</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译器会按<strong>从上至下</strong>的顺序，收集所有 {} 代码块和成员变量赋值的代码，<strong>形成新的构造方法</strong>，但<strong>原始构造方法</strong>内的代码<strong>总是在后</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Code:</span>\n<span class="line">     stack=2, locals=3, args_size=3</span>\n<span class="line">        0: aload_0</span>\n<span class="line">        1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span>\n<span class="line">        4: aload_0</span>\n<span class="line">        5: ldc           #2                  // String s1</span>\n<span class="line">        7: putfield      #3                  // Field a:Ljava/lang/String;</span>\n<span class="line">       10: aload_0</span>\n<span class="line">       11: bipush        20</span>\n<span class="line">       13: putfield      #4                  // Field b:I</span>\n<span class="line">       16: aload_0</span>\n<span class="line">       17: bipush        10</span>\n<span class="line">       19: putfield      #4                  // Field b:I</span>\n<span class="line">       22: aload_0</span>\n<span class="line">       23: ldc           #5                  // String s2</span>\n<span class="line">       25: putfield      #3                  // Field a:Ljava/lang/String;</span>\n<span class="line">       //原始构造方法在最后执行</span>\n<span class="line">       28: aload_0</span>\n<span class="line">       29: aload_1</span>\n<span class="line">       30: putfield      #3                  // Field a:Ljava/lang/String;</span>\n<span class="line">       33: aload_0</span>\n<span class="line">       34: iload_2</span>\n<span class="line">       35: putfield      #4                  // Field b:I</span>\n<span class="line">       38: return</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="方法调用" tabindex="-1"><a class="header-anchor" href="#方法调用"><span>方法调用</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo5</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token class-name">Demo5</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token class-name">Demo5</span> demo5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Demo5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\tdemo5<span class="token punctuation">.</span><span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\tdemo5<span class="token punctuation">.</span><span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\tdemo5<span class="token punctuation">.</span><span class="token function">test3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token class-name">Demo5</span><span class="token punctuation">.</span><span class="token function">test4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>不同方法在调用时，对应的虚拟机指令有所区别</p><ul><li>私有、构造、被final修饰的方法，在调用时都使用<strong>invokespecial</strong>指令</li><li>普通成员方法在调用时，使用invokespecial指令。因为编译期间无法确定该方法的内容，只有在运行期间才能确定</li><li>静态方法在调用时使用invokestatic指令</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Code:</span>\n<span class="line">      stack=2, locals=2, args_size=1</span>\n<span class="line">         0: new           #2                  // class com/nyima/JVM/day5/Demo5 </span>\n<span class="line">         3: dup</span>\n<span class="line">         4: invokespecial #3                  // Method &quot;&lt;init&gt;&quot;:()V</span>\n<span class="line">         7: astore_1</span>\n<span class="line">         8: aload_1</span>\n<span class="line">         9: invokespecial #4                  // Method test1:()V</span>\n<span class="line">        12: aload_1</span>\n<span class="line">        13: invokespecial #5                  // Method test2:()V</span>\n<span class="line">        16: aload_1</span>\n<span class="line">        17: invokevirtual #6                  // Method test3:()V</span>\n<span class="line">        20: invokestatic  #7                  // Method test4:()V</span>\n<span class="line">        23: return</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>new 是创建【对象】，给对象分配堆内存，执行成功会将【<strong>对象引用</strong>】压入操作数栈</li><li>dup 是赋值操作数栈栈顶的内容，本例即为【<strong>对象引用</strong>】，为什么需要两份引用呢，一个是要配合 invokespecial 调用该对象的构造方法 “init”😦)V （会消耗掉栈顶一个引用），另一个要 配合 astore_1 赋值给局部变量</li><li>终方法（ﬁnal），私有方法（private），构造方法都是由 invokespecial 指令来调用，属于静态绑定</li><li>普通成员方法是由 invokevirtual 调用，属于<strong>动态绑定</strong>，即支持多态 成员方法与静态方法调用的另一个区别是，执行方法前是否需要【对象引用】</li></ul><h4 id="多态原理" tabindex="-1"><a class="header-anchor" href="#多态原理"><span>多态原理</span></a></h4><p>因为普通成员方法需要在运行时才能确定具体的内容，所以虚拟机需要调用<strong>invokevirtual</strong>指令</p><p>在执行invokevirtual指令时，经历了以下几个步骤</p><ul><li>先通过栈帧中对象的引用找到对象</li><li>分析对象头，找到对象实际的Class</li><li>Class结构中有<strong>vtable</strong>，它在类加载的链接阶段就已经根据方法的重写规则生成好了</li><li>查询vtable找到方法的具体地址</li><li>执行方法的字节码</li></ul><h4 id="异常处理" tabindex="-1"><a class="header-anchor" href="#异常处理"><span>异常处理</span></a></h4><h5 id="try-catch" tabindex="-1"><a class="header-anchor" href="#try-catch"><span>try-catch</span></a></h5><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\ti <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\ti <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应字节码指令</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Code:</span>\n<span class="line">     stack=1, locals=3, args_size=1</span>\n<span class="line">        0: iconst_0</span>\n<span class="line">        1: istore_1</span>\n<span class="line">        2: bipush        10</span>\n<span class="line">        4: istore_1</span>\n<span class="line">        5: goto          12</span>\n<span class="line">        8: astore_2</span>\n<span class="line">        9: bipush        20</span>\n<span class="line">       11: istore_1</span>\n<span class="line">       12: return</span>\n<span class="line">     //多出来一个异常表</span>\n<span class="line">     Exception table:</span>\n<span class="line">        from    to  target type</span>\n<span class="line">            2     5     8   Class java/lang/Exception</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>可以看到多出来一个 Exception table 的结构，[from, to) 是<strong>前闭后开</strong>（也就是检测2~4行）的检测范围，一旦这个范围内的字节码执行出现异常，则通过 type 匹配异常类型，如果一致，进入 target 所指示行号</li><li>8行的字节码指令 astore_2 是将异常对象引用存入局部变量表的2号位置（为e）</li></ul><h5 id="多个single-catch" tabindex="-1"><a class="header-anchor" href="#多个single-catch"><span>多个single-catch</span></a></h5><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\ti <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArithmeticException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\ti <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\ti <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的字节码</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Code:</span>\n<span class="line">     stack=1, locals=3, args_size=1</span>\n<span class="line">        0: iconst_0</span>\n<span class="line">        1: istore_1</span>\n<span class="line">        2: bipush        10</span>\n<span class="line">        4: istore_1</span>\n<span class="line">        5: goto          19</span>\n<span class="line">        8: astore_2</span>\n<span class="line">        9: bipush        20</span>\n<span class="line">       11: istore_1</span>\n<span class="line">       12: goto          19</span>\n<span class="line">       15: astore_2</span>\n<span class="line">       16: bipush        30</span>\n<span class="line">       18: istore_1</span>\n<span class="line">       19: return</span>\n<span class="line">     Exception table:</span>\n<span class="line">        from    to  target type</span>\n<span class="line">            2     5     8   Class java/lang/ArithmeticException</span>\n<span class="line">            2     5    15   Class java/lang/Exception</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>因为异常出现时，<strong>只能进入</strong> Exception table 中<strong>一个分支</strong>，所以局部变量表 slot 2 位置<strong>被共用</strong></li></ul><h5 id="finally" tabindex="-1"><a class="header-anchor" href="#finally"><span>finally</span></a></h5><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo2</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\ti <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\ti <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\ti <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应字节码</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token class-name">Code</span><span class="token operator">:</span></span>\n<span class="line">     stack<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span></span>\n<span class="line">        <span class="token number">0</span><span class="token operator">:</span> iconst_0</span>\n<span class="line">        <span class="token number">1</span><span class="token operator">:</span> istore_1</span>\n<span class="line">        <span class="token comment">//try块</span></span>\n<span class="line">        <span class="token number">2</span><span class="token operator">:</span> bipush        <span class="token number">10</span></span>\n<span class="line">        <span class="token number">4</span><span class="token operator">:</span> istore_1</span>\n<span class="line">        <span class="token comment">//try块执行完后，会执行finally    </span></span>\n<span class="line">        <span class="token number">5</span><span class="token operator">:</span> bipush        <span class="token number">30</span></span>\n<span class="line">        <span class="token number">7</span><span class="token operator">:</span> istore_1</span>\n<span class="line">        <span class="token number">8</span><span class="token operator">:</span> <span class="token keyword">goto</span>          <span class="token number">27</span></span>\n<span class="line">       <span class="token comment">//catch块     </span></span>\n<span class="line">       <span class="token number">11</span><span class="token operator">:</span> astore_2 <span class="token comment">//异常信息放入局部变量表的2号槽位</span></span>\n<span class="line">       <span class="token number">12</span><span class="token operator">:</span> bipush        <span class="token number">20</span></span>\n<span class="line">       <span class="token number">14</span><span class="token operator">:</span> istore_1</span>\n<span class="line">       <span class="token comment">//catch块执行完后，会执行finally        </span></span>\n<span class="line">       <span class="token number">15</span><span class="token operator">:</span> bipush        <span class="token number">30</span></span>\n<span class="line">       <span class="token number">17</span><span class="token operator">:</span> istore_1</span>\n<span class="line">       <span class="token number">18</span><span class="token operator">:</span> <span class="token keyword">goto</span>          <span class="token number">27</span></span>\n<span class="line">       <span class="token comment">//出现异常，但未被Exception捕获，会抛出其他异常，这时也需要执行finally块中的代码   </span></span>\n<span class="line">       <span class="token number">21</span><span class="token operator">:</span> astore_3</span>\n<span class="line">       <span class="token number">22</span><span class="token operator">:</span> bipush        <span class="token number">30</span></span>\n<span class="line">       <span class="token number">24</span><span class="token operator">:</span> istore_1</span>\n<span class="line">       <span class="token number">25</span><span class="token operator">:</span> aload_3</span>\n<span class="line">       <span class="token number">26</span><span class="token operator">:</span> athrow  <span class="token comment">//抛出异常</span></span>\n<span class="line">       <span class="token number">27</span><span class="token operator">:</span> <span class="token keyword">return</span></span>\n<span class="line">     <span class="token class-name">Exception</span> table<span class="token operator">:</span></span>\n<span class="line">        from    <span class="token keyword">to</span>  <span class="token namespace">target</span> type</span>\n<span class="line">            <span class="token number">2</span>     <span class="token number">5</span>    <span class="token number">11</span>   <span class="token class-name">Class</span> java<span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">Exception</span></span>\n<span class="line">            <span class="token number">2</span>     <span class="token number">5</span>    <span class="token number">21</span>   any</span>\n<span class="line">           <span class="token number">11</span>    <span class="token number">15</span>    <span class="token number">21</span>   any</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到 ﬁnally 中的代码被<strong>复制了 3 份</strong>，分别放入 try 流程，catch 流程以及 catch剩余的异常类型流程</p><p><strong>注意</strong>：虽然从字节码指令看来，每个块中都有finally块，但是finally块中的代码<strong>只会被执行一次</strong></p><h5 id="finally中的return" tabindex="-1"><a class="header-anchor" href="#finally中的return"><span>finally中的return</span></a></h5><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token class-name">Demo3</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token comment">//结果为20</span></span>\n<span class="line">\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token keyword">int</span> i<span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\ti <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t<span class="token keyword">return</span> i<span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\ti <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t<span class="token keyword">return</span> i<span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应字节码</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Code:</span>\n<span class="line">     stack=1, locals=3, args_size=0</span>\n<span class="line">        0: bipush        10</span>\n<span class="line">        2: istore_0</span>\n<span class="line">        3: iload_0</span>\n<span class="line">        4: istore_1  //暂存返回值</span>\n<span class="line">        5: bipush        20</span>\n<span class="line">        7: istore_0</span>\n<span class="line">        8: iload_0</span>\n<span class="line">        9: ireturn\t//ireturn会返回操作数栈顶的整型值20</span>\n<span class="line">       //如果出现异常，还是会执行finally块中的内容，没有抛出异常</span>\n<span class="line">       10: astore_2</span>\n<span class="line">       11: bipush        20</span>\n<span class="line">       13: istore_0</span>\n<span class="line">       14: iload_0</span>\n<span class="line">       15: ireturn\t//这里没有athrow了，也就是如果在finally块中如果有返回操作的话，且try块中出现异常，会吞掉异常！</span>\n<span class="line">     Exception table:</span>\n<span class="line">        from    to  target type</span>\n<span class="line">            0     5    10   any</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>由于 ﬁnally 中的 <strong>ireturn</strong> 被插入了所有可能的流程，因此返回结果肯定以ﬁnally的为准</li><li>至于字节码中第 2 行，似乎没啥用，且留个伏笔，看下个例子</li><li>跟上例中的 ﬁnally 相比，发现<strong>没有 athrow 了</strong>，这告诉我们：如果在 ﬁnally 中出现了 return，会<strong>吞掉异常</strong></li><li>所以<strong>不要在finally中进行返回操作</strong></li></ul><h5 id="被吞掉的异常" tabindex="-1"><a class="header-anchor" href="#被吞掉的异常"><span>被吞掉的异常</span></a></h5><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token class-name">Demo3</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token comment">//最终结果为20</span></span>\n<span class="line">      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token keyword">int</span> i<span class="token punctuation">;</span></span>\n<span class="line">      <span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">         i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></span>\n<span class="line">         <span class="token comment">//这里应该会抛出异常</span></span>\n<span class="line">         i <span class="token operator">=</span> i<span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span></span>\n<span class="line">         <span class="token keyword">return</span> i<span class="token punctuation">;</span></span>\n<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></span>\n<span class="line">         i <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span></span>\n<span class="line">         <span class="token keyword">return</span> i<span class="token punctuation">;</span></span>\n<span class="line">      <span class="token punctuation">}</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>会发现打印结果为20，并未抛出异常</p><h5 id="finally不带return" tabindex="-1"><a class="header-anchor" href="#finally不带return"><span>finally不带return</span></a></h5><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo4</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token class-name">Demo4</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t<span class="token keyword">return</span> i<span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\ti <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应字节码</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Code:</span>\n<span class="line">     stack=1, locals=3, args_size=0</span>\n<span class="line">        0: bipush        10</span>\n<span class="line">        2: istore_0 //赋值给i 10</span>\n<span class="line">        3: iload_0\t//加载到操作数栈顶</span>\n<span class="line">        4: istore_1 //加载到局部变量表的1号位置</span>\n<span class="line">        5: bipush        20</span>\n<span class="line">        7: istore_0 //赋值给i 20</span>\n<span class="line">        8: iload_1 //加载局部变量表1号位置的数10到操作数栈</span>\n<span class="line">        9: ireturn //返回操作数栈顶元素 10</span>\n<span class="line">       10: astore_2</span>\n<span class="line">       11: bipush        20</span>\n<span class="line">       13: istore_0</span>\n<span class="line">       14: aload_2 //加载异常</span>\n<span class="line">       15: athrow //抛出异常</span>\n<span class="line">     Exception table:</span>\n<span class="line">        from    to  target type</span>\n<span class="line">            3     5    10   any</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="synchronized" tabindex="-1"><a class="header-anchor" href="#synchronized"><span>Synchronized</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo5</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">class</span> <span class="token class-name">Lock</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应字节码</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token class-name">Code</span><span class="token operator">:</span></span>\n<span class="line">     stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span></span>\n<span class="line">        <span class="token number">0</span><span class="token operator">:</span> bipush        <span class="token number">10</span></span>\n<span class="line">        <span class="token number">2</span><span class="token operator">:</span> istore_1</span>\n<span class="line">        <span class="token number">3</span><span class="token operator">:</span> <span class="token keyword">new</span>           #<span class="token number">2</span>                  <span class="token comment">// class com/nyima/JVM/day06/Lock</span></span>\n<span class="line">        <span class="token number">6</span><span class="token operator">:</span> dup <span class="token comment">//复制一份，放到操作数栈顶，用于构造函数消耗</span></span>\n<span class="line">        <span class="token number">7</span><span class="token operator">:</span> invokespecial #<span class="token number">3</span>                  <span class="token comment">// Method com/nyima/JVM/day06/Lock.&quot;&lt;init&gt;&quot;:()V</span></span>\n<span class="line">       <span class="token number">10</span><span class="token operator">:</span> astore_2 <span class="token comment">//剩下的一份放到局部变量表的2号位置</span></span>\n<span class="line">       <span class="token number">11</span><span class="token operator">:</span> aload_2 <span class="token comment">//加载到操作数栈</span></span>\n<span class="line">       <span class="token number">12</span><span class="token operator">:</span> dup <span class="token comment">//复制一份，放到操作数栈，用于加锁时消耗</span></span>\n<span class="line">       <span class="token number">13</span><span class="token operator">:</span> astore_3 <span class="token comment">//将操作数栈顶元素弹出，暂存到局部变量表的三号槽位。这时操作数栈中有一份对象的引用</span></span>\n<span class="line">       <span class="token number">14</span><span class="token operator">:</span> monitorenter <span class="token comment">//加锁</span></span>\n<span class="line">       <span class="token comment">//锁住后代码块中的操作    </span></span>\n<span class="line">       <span class="token number">15</span><span class="token operator">:</span> getstatic     #<span class="token number">4</span>                  <span class="token comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span></span>\n<span class="line">       <span class="token number">18</span><span class="token operator">:</span> iload_1</span>\n<span class="line">       <span class="token number">19</span><span class="token operator">:</span> invokevirtual #<span class="token number">5</span>                  <span class="token comment">// Method java/io/PrintStream.println:(I)V</span></span>\n<span class="line">       <span class="token comment">//加载局部变量表中三号槽位对象的引用，用于解锁    </span></span>\n<span class="line">       <span class="token number">22</span><span class="token operator">:</span> aload_3    </span>\n<span class="line">       <span class="token number">23</span><span class="token operator">:</span> monitorexit <span class="token comment">//解锁</span></span>\n<span class="line">       <span class="token number">24</span><span class="token operator">:</span> <span class="token keyword">goto</span>          <span class="token number">34</span></span>\n<span class="line">       <span class="token comment">//异常操作    </span></span>\n<span class="line">       <span class="token number">27</span><span class="token operator">:</span> astore        <span class="token number">4</span></span>\n<span class="line">       <span class="token number">29</span><span class="token operator">:</span> aload_3</span>\n<span class="line">       <span class="token number">30</span><span class="token operator">:</span> monitorexit <span class="token comment">//解锁</span></span>\n<span class="line">       <span class="token number">31</span><span class="token operator">:</span> aload         <span class="token number">4</span></span>\n<span class="line">       <span class="token number">33</span><span class="token operator">:</span> athrow</span>\n<span class="line">       <span class="token number">34</span><span class="token operator">:</span> <span class="token keyword">return</span></span>\n<span class="line">     <span class="token comment">//可以看出，无论何时出现异常，都会跳转到27行，将异常放入局部变量中，并进行解锁操作，然后加载异常并抛出异常。      </span></span>\n<span class="line">     <span class="token class-name">Exception</span> table<span class="token operator">:</span></span>\n<span class="line">        from    <span class="token keyword">to</span>  <span class="token namespace">target</span> type</span>\n<span class="line">           <span class="token number">15</span>    <span class="token number">24</span>    <span class="token number">27</span>   any</span>\n<span class="line">           <span class="token number">27</span>    <span class="token number">31</span>    <span class="token number">27</span>   any</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3、编译期处理" tabindex="-1"><a class="header-anchor" href="#_3、编译期处理"><span>3、编译期处理</span></a></h3><p>所谓的 <strong>语法糖</strong> ，其实就是指 java 编译器把 *.java 源码编译为 *.class 字节码的过程中，<strong>自动生成</strong>和<strong>转换</strong>的一些代码，主要是为了减轻程序员的负担，算是 java 编译器给我们的一个额外福利</p><p><strong>注意</strong>，以下代码的分析，借助了 javap 工具，idea 的反编译功能，idea 插件 jclasslib 等工具。另外， 编译器转换的<strong>结果直接就是 class 字节码</strong>，只是为了便于阅读，给出了 几乎等价 的 java 源码方式，并不是编译器还会转换出中间的 java 源码，切记。</p><h4 id="默认构造函数" tabindex="-1"><a class="header-anchor" href="#默认构造函数"><span>默认构造函数</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy1</span> <span class="token punctuation">{</span></span>\n<span class="line"></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>经过编译期优化后</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy1</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token comment">//这个无参构造器是java编译器帮我们加上的</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token class-name">Candy1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token comment">//即调用父类 Object 的无参构造方法，即调用 java/lang/Object.&quot; &lt;init&gt;&quot;:()V</span></span>\n<span class="line">      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="自动拆装箱" tabindex="-1"><a class="header-anchor" href="#自动拆装箱"><span>自动拆装箱</span></a></h4><p>基本类型和其包装类型的相互转换过程，称为拆装箱</p><p>在JDK 5以后，它们的转换可以在编译期自动完成</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo2</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token class-name">Integer</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token keyword">int</span> y <span class="token operator">=</span> x<span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>转换过程如下</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo2</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token comment">//基本类型赋值给包装类型，称为装箱</span></span>\n<span class="line">      <span class="token class-name">Integer</span> x <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token comment">//包装类型赋值给基本类型，称谓拆箱</span></span>\n<span class="line">      <span class="token keyword">int</span> y <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="泛型集合取值" tabindex="-1"><a class="header-anchor" href="#泛型集合取值"><span>泛型集合取值</span></a></h4><p>泛型也是在 JDK 5 开始加入的特性，但 java 在<strong>编译泛型代码后</strong>会执行 <strong>泛型擦除</strong> 的动作，即泛型信息在编译为字节码之后就<strong>丢失</strong>了，实际的类型都当做了 <strong>Object</strong> 类型来处理：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo3</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">      list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token class-name">Integer</span> x <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应字节码</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Code:</span>\n<span class="line">    stack=2, locals=3, args_size=1</span>\n<span class="line">       0: new           #2                  // class java/util/ArrayList</span>\n<span class="line">       3: dup</span>\n<span class="line">       4: invokespecial #3                  // Method java/util/ArrayList.&quot;&lt;init&gt;&quot;:()V</span>\n<span class="line">       7: astore_1</span>\n<span class="line">       8: aload_1</span>\n<span class="line">       9: bipush        10</span>\n<span class="line">      11: invokestatic  #4                  // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span>\n<span class="line">      //这里进行了泛型擦除，实际调用的是add(Objcet o)</span>\n<span class="line">      14: invokeinterface #5,  2            // InterfaceMethod java/util/List.add:(Ljava/lang/Object;)Z</span>\n<span class="line"></span>\n<span class="line">      19: pop</span>\n<span class="line">      20: aload_1</span>\n<span class="line">      21: iconst_0</span>\n<span class="line">      //这里也进行了泛型擦除，实际调用的是get(Object o)   </span>\n<span class="line">      22: invokeinterface #6,  2            // InterfaceMethod java/util/List.get:(I)Ljava/lang/Object;</span>\n<span class="line">//这里进行了类型转换，将Object转换成了Integer</span>\n<span class="line">      27: checkcast     #7                  // class java/lang/Integer</span>\n<span class="line">      30: astore_2</span>\n<span class="line">      31: return</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所以调用get函数取值时，有一个类型转换的操作</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Integer x = (Integer) list.get(0);</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>如果要将返回结果赋值给一个int类型的变量，则还有<strong>自动拆箱</strong>的操作</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">int x = (Integer) list.get(0).intValue();</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="可变参数" tabindex="-1"><a class="header-anchor" href="#可变参数"><span>可变参数</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo4</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token comment">//将args赋值给arr，可以看出String...实际就是String[] </span></span>\n<span class="line">      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> args<span class="token punctuation">;</span></span>\n<span class="line">      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token function">foo</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可变参数 <strong>String…</strong> args 其实是一个 <strong>String[]</strong> args ，从代码中的赋值语句中就可以看出来。 同 样 java 编译器会在编译期间将上述代码变换为：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo4</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token class-name">Demo4</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">    </span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> args<span class="token punctuation">;</span></span>\n<span class="line">      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意，如果调用的是foo()，即未传递参数时，等价代码为foo(new String[]{})，<strong>创建了一个空数组</strong>，而不是直接传递的null</p><h4 id="foreach" tabindex="-1"><a class="header-anchor" href="#foreach"><span>foreach</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo5</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token comment">//数组赋初值的简化写法也是一种语法糖。</span></span>\n<span class="line">\t\t<span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">:</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译器会帮我们转换为</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo5</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Demo5</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t<span class="token keyword">int</span> x <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>如果是集合使用foreach</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo5</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> x <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">         <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token punctuation">}</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>集合要使用foreach，需要该集合类实现了<strong>Iterable接口</strong>，因为集合的遍历需要用到<strong>迭代器Iterator</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo5</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Demo5</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>\n<span class="line">    </span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token comment">//获得该集合的迭代器</span></span>\n<span class="line">      <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token keyword">while</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">         <span class="token class-name">Integer</span> x <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">         <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token punctuation">}</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="switch字符串" tabindex="-1"><a class="header-anchor" href="#switch字符串"><span>switch字符串</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo6</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token keyword">switch</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">         <span class="token keyword">case</span> <span class="token string">&quot;hello&quot;</span> <span class="token operator">:</span></span>\n<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;h&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>\n<span class="line">         <span class="token keyword">case</span> <span class="token string">&quot;world&quot;</span> <span class="token operator">:</span></span>\n<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>\n<span class="line">         <span class="token keyword">default</span><span class="token operator">:</span></span>\n<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token punctuation">}</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在编译器中执行的操作</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo6</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token class-name">Demo6</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      </span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token comment">//通过字符串的hashCode+value来判断是否匹配</span></span>\n<span class="line">      <span class="token keyword">switch</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">         <span class="token comment">//hello的hashCode</span></span>\n<span class="line">         <span class="token keyword">case</span> <span class="token number">99162322</span> <span class="token operator">:</span></span>\n<span class="line">            <span class="token comment">//再次比较，因为字符串的hashCode有可能相等</span></span>\n<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">               x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token punctuation">}</span></span>\n<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>\n<span class="line">         <span class="token comment">//world的hashCode</span></span>\n<span class="line">         <span class="token keyword">case</span> <span class="token number">11331880</span> <span class="token operator">:</span></span>\n<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">               x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token punctuation">}</span></span>\n<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>\n<span class="line">         <span class="token keyword">default</span><span class="token operator">:</span></span>\n<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">      <span class="token comment">//用第二个switch在进行输出判断</span></span>\n<span class="line">      <span class="token keyword">switch</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">         <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span></span>\n<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;h&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>\n<span class="line">         <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span></span>\n<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>\n<span class="line">         <span class="token keyword">default</span><span class="token operator">:</span></span>\n<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token punctuation">}</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>过程说明：</p><ul><li>在编译期间，单个的switch被分为了两个 <ul><li>第一个用来匹配字符串，并给x赋值 <ul><li>字符串的匹配用到了字符串的hashCode，还用到了equals方法</li><li>使用hashCode是为了提高比较效率，使用equals是防止有hashCode冲突（如BM和C.）</li></ul></li><li>第二个用来根据x的值来决定输出语句</li></ul></li></ul><h4 id="switch枚举" tabindex="-1"><a class="header-anchor" href="#switch枚举"><span>switch枚举</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo7</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token class-name">SEX</span> sex <span class="token operator">=</span> <span class="token constant">SEX</span><span class="token punctuation">.</span><span class="token constant">MALE</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token keyword">switch</span> <span class="token punctuation">(</span>sex<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">         <span class="token keyword">case</span> <span class="token constant">MALE</span><span class="token operator">:</span></span>\n<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;man&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>\n<span class="line">         <span class="token keyword">case</span> <span class="token constant">FEMALE</span><span class="token operator">:</span></span>\n<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;woman&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>\n<span class="line">         <span class="token keyword">default</span><span class="token operator">:</span></span>\n<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token punctuation">}</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">enum</span> <span class="token class-name">SEX</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token constant">MALE</span><span class="token punctuation">,</span> <span class="token constant">FEMALE</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译器中执行的代码如下</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo7</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token doc-comment comment">/**     </span>\n<span class="line">    * 定义一个合成类（仅 jvm 使用，对我们不可见）     </span>\n<span class="line">    * 用来映射枚举的 ordinal 与数组元素的关系     </span>\n<span class="line">    * 枚举的 ordinal 表示枚举对象的序号，从 0 开始     </span>\n<span class="line">    * 即 MALE 的 ordinal()=0，FEMALE 的 ordinal()=1     </span>\n<span class="line">    */</span> </span>\n<span class="line">   <span class="token keyword">static</span> <span class="token keyword">class</span> $<span class="token constant">MAP</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token comment">//数组大小即为枚举元素个数，里面存放了case用于比较的数字</span></span>\n<span class="line">      <span class="token keyword">static</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token keyword">static</span> <span class="token punctuation">{</span></span>\n<span class="line">         <span class="token comment">//ordinal即枚举元素对应所在的位置，MALE为0，FEMALE为1</span></span>\n<span class="line">         map<span class="token punctuation">[</span><span class="token constant">SEX</span><span class="token punctuation">.</span><span class="token constant">MALE</span><span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>\n<span class="line">         map<span class="token punctuation">[</span><span class="token constant">SEX</span><span class="token punctuation">.</span><span class="token constant">FEMALE</span><span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token punctuation">}</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token class-name">SEX</span> sex <span class="token operator">=</span> <span class="token constant">SEX</span><span class="token punctuation">.</span><span class="token constant">MALE</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token comment">//将对应位置枚举元素的值赋给x，用于case操作</span></span>\n<span class="line">      <span class="token keyword">int</span> x <span class="token operator">=</span> $<span class="token constant">MAP</span><span class="token punctuation">.</span>map<span class="token punctuation">[</span>sex<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token keyword">switch</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">         <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span></span>\n<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;man&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>\n<span class="line">         <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span></span>\n<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;woman&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>\n<span class="line">         <span class="token keyword">default</span><span class="token operator">:</span></span>\n<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token punctuation">}</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">enum</span> <span class="token class-name">SEX</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token constant">MALE</span><span class="token punctuation">,</span> <span class="token constant">FEMALE</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="枚举类" tabindex="-1"><a class="header-anchor" href="#枚举类"><span>枚举类</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">enum</span> <span class="token class-name">SEX</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token constant">MALE</span><span class="token punctuation">,</span> <span class="token constant">FEMALE</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>转换后的代码</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Sex</span> <span class="token keyword">extends</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Sex</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>   </span>\n<span class="line">   <span class="token comment">//对应枚举类中的元素</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Sex</span> <span class="token constant">MALE</span><span class="token punctuation">;</span>    </span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Sex</span> <span class="token constant">FEMALE</span><span class="token punctuation">;</span>    </span>\n<span class="line">   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Sex</span><span class="token punctuation">[</span><span class="token punctuation">]</span> $<span class="token constant">VALUES</span><span class="token punctuation">;</span></span>\n<span class="line">   </span>\n<span class="line">    <span class="token keyword">static</span> <span class="token punctuation">{</span>       </span>\n<span class="line">    \t<span class="token comment">//调用构造函数，传入枚举元素的值及ordinal</span></span>\n<span class="line">    \t<span class="token constant">MALE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sex</span><span class="token punctuation">(</span><span class="token string">&quot;MALE&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    </span>\n<span class="line">        <span class="token constant">FEMALE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sex</span><span class="token punctuation">(</span><span class="token string">&quot;FEMALE&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   </span>\n<span class="line">        $<span class="token constant">VALUES</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sex</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token constant">MALE</span><span class="token punctuation">,</span> <span class="token constant">FEMALE</span><span class="token punctuation">}</span><span class="token punctuation">;</span> </span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"> \t</span>\n<span class="line">   <span class="token comment">//调用父类中的方法</span></span>\n<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Sex</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> ordinal<span class="token punctuation">)</span> <span class="token punctuation">{</span>     </span>\n<span class="line">        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> ordinal<span class="token punctuation">)</span><span class="token punctuation">;</span>    </span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">   </span>\n<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Sex</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>\n<span class="line">        <span class="token keyword">return</span> $<span class="token constant">VALUES</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Sex</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>\n<span class="line">        <span class="token keyword">return</span> <span class="token class-name">Enum</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">Sex</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>\n<span class="line">    <span class="token punctuation">}</span> </span>\n<span class="line">   </span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="匿名内部类" tabindex="-1"><a class="header-anchor" href="#匿名内部类"><span>匿名内部类</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo8</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">         <span class="token annotation punctuation">@Override</span></span>\n<span class="line">         <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">         <span class="token punctuation">}</span></span>\n<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>转换后的代码</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo8</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token comment">//用额外创建的类来创建匿名内部类对象</span></span>\n<span class="line">      <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Demo8</span>$<span class="token function">1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line"><span class="token comment">//创建了一个额外的类，实现了Runnable接口</span></span>\n<span class="line"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Demo8</span>$<span class="token number">1</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token class-name">Demo8</span>$<span class="token function">1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">   <span class="token annotation punctuation">@Override</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果匿名内部类中引用了<strong>局部变量</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo8</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">         <span class="token annotation punctuation">@Override</span></span>\n<span class="line">         <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">         <span class="token punctuation">}</span></span>\n<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>转化后代码</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token comment">// 代码有问题</span></span>\n<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo8</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Demo8</span>$<span class="token function">1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">         <span class="token annotation punctuation">@Override</span></span>\n<span class="line">         <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">         <span class="token punctuation">}</span></span>\n<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Demo8</span>$<span class="token number">1</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token comment">//多创建了一个变量</span></span>\n<span class="line">   <span class="token keyword">int</span> val$x<span class="token punctuation">;</span></span>\n<span class="line">   <span class="token comment">//变为了有参构造器</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token class-name">Demo8</span>$<span class="token function">1</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>val$x <span class="token operator">=</span> x<span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">   <span class="token annotation punctuation">@Override</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>val$x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4、类加载阶段" tabindex="-1"><a class="header-anchor" href="#_4、类加载阶段"><span>4、类加载阶段</span></a></h3><h4 id="加载" tabindex="-1"><a class="header-anchor" href="#加载"><span>加载</span></a></h4><ul><li><p>将类的字节码载入</p><p>方法区</p><p>（1.8后为元空间，在本地内存中）中，内部采用 C++ 的 instanceKlass 描述 java 类，它的重要 ﬁeld 有：</p><ul><li>_java_mirror 即 java 的类镜像，例如对 String 来说，它的镜像类就是 String.class，作用是把 klass 暴露给 java 使用</li><li>_super 即父类</li><li>_ﬁelds 即成员变量</li><li>_methods 即方法</li><li>_constants 即常量池</li><li>_class_loader 即类加载器</li><li>_vtable 虚方法表</li><li>_itable 接口方法</li></ul></li><li><p>如果这个类还有父类没有加载，<strong>先加载父类</strong></p></li><li><p>加载和链接可能是<strong>交替运行</strong>的</p></li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611205050.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611205050.png" alt="img"></a></p><ul><li>instanceKlass保存在<strong>方法区</strong>。JDK 8以后，方法区位于元空间中，而元空间又位于本地内存中</li><li>_java_mirror则是保存在<strong>堆内存</strong>中</li><li>InstanceKlass和*.class(JAVA镜像类)互相保存了对方的地址</li><li>类的对象在对象头中保存了*.class的地址。让对象可以通过其找到方法区中的instanceKlass，从而获取类的各种信息</li></ul><h4 id="链接" tabindex="-1"><a class="header-anchor" href="#链接"><span>链接</span></a></h4><h5 id="验证" tabindex="-1"><a class="header-anchor" href="#验证"><span>验证</span></a></h5><p>验证类是否符合 JVM规范，安全性检查</p><h5 id="准备" tabindex="-1"><a class="header-anchor" href="#准备"><span>准备</span></a></h5><p>为 static 变量分配空间，设置默认值</p><ul><li>static变量在JDK 7以前是存储与instanceKlass末尾。但在JDK 7以后就存储在_java_mirror末尾了</li><li>static变量在分配空间和赋值是在两个阶段完成的。分配空间在准备阶段完成，赋值在初始化阶段完成</li><li>如果 static 变量是 ﬁnal 的<strong>基本类型</strong>，或者是<strong>字符串常量</strong>，那么编译阶段值就确定了，<strong>赋值在准备阶段完成</strong></li><li>如果 static 变量是 ﬁnal 的，但属于<strong>引用类型</strong>，那么赋值也会在<strong>初始化阶段完成</strong></li></ul><h5 id="解析" tabindex="-1"><a class="header-anchor" href="#解析"><span>解析</span></a></h5><p><strong>HSDB的使用</strong></p><ul><li>先获得要查看的进程ID</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">jps</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>打开HSDB</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token function">java</span> <span class="token parameter variable">-cp</span> F:<span class="token punctuation">\\</span>JAVA<span class="token punctuation">\\</span>JDK8.0<span class="token punctuation">\\</span>lib<span class="token punctuation">\\</span>sa-jdi.jar sun.jvm.hotspot.HSDB</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>运行时可能会报错，是因为<strong>缺少一个.dll的文件</strong>，我们在JDK的安装目录中找到该文件，复制到缺失的文件下即可</li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611221703.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611221703.png" alt="img"></a></p><ul><li>定位需要的进程</li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611221857.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611221857.png" alt="img"></a></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611222029.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611222029.png" alt="img"></a></p><p><strong>解析的含义</strong></p><p>将常量池中的符号引用解析为直接引用</p><ul><li>未解析时，常量池中的看到的对象仅是符号，未真正的存在于内存中</li></ul><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token class-name">ClassLoader</span> loader <span class="token operator">=</span> <span class="token class-name">Demo1</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token comment">//只加载不解析</span></span>\n<span class="line">      <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">&quot;com.nyima.JVM.day8.C&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token comment">//用于阻塞主线程</span></span>\n<span class="line">      <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token class-name">D</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">class</span> <span class="token class-name">D</span> <span class="token punctuation">{</span></span>\n<span class="line"></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>打开HSDB <ul><li>可以看到此时只加载了类C</li></ul></li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611223153.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611223153.png" alt="img"></a></p><p>查看类C的常量池，可以看到类D<strong>未被解析</strong>，只是存在于常量池中的符号</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611230658.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611230658.png" alt="img"></a></p><ul><li><p>解析以后，会将常量池中的符号引用解析为直接引用</p><ul><li>可以看到，此时已加载并解析了类C和类D</li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611223441.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611223441.png" alt="img"></a></p></li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200613104723.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200613104723.png" alt="img"></a></p><h4 id="初始化" tabindex="-1"><a class="header-anchor" href="#初始化"><span>初始化</span></a></h4><p>初始化阶段就是<strong>执行类构造器clinit()方法的过程</strong>，虚拟机会保证这个类的『构造方法』的线程安全</p><ul><li>clinit()方法是由编译器自动收集类中的所有类变量的<strong>静态赋值动作和静态代码块</strong>（static{}块）中的语句合并产生的</li></ul><p><strong>注意</strong></p><p>编译器收集的顺序是由语句在源文件中<strong>出现的顺序决定</strong>的，静态语句块中只能访问到定义在静态语句块之前的变量，定义在它<strong>之后</strong>的变量，在前面的静态语句块<strong>可以赋值，但是不能访问</strong>，如</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20201118204542.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20201118204542.png" alt="img"></a></p><h5 id="发生时机" tabindex="-1"><a class="header-anchor" href="#发生时机"><span>发生时机</span></a></h5><p><strong>类的初始化的懒惰的</strong>，以下情况会初始化</p><ul><li>main 方法所在的类，总会被首先初始化</li><li>首次访问这个类的静态变量或静态方法时</li><li>子类初始化，如果父类还没初始化，会引发</li><li>子类访问父类的静态变量，只会触发父类的初始化</li><li>Class.forName</li><li>new 会导致初始化</li></ul><p>以下情况不会初始化</p><ul><li>访问类的 static ﬁnal 静态常量（基本类型和字符串）因为这两个是在准备阶段就赋值了</li><li>类对象.class 不会触发初始化</li><li>创建该类对象的数组</li><li>类加载器的.loadClass方法</li><li>Class.forNamed的参数2为false时</li></ul><p><strong>验证类是否被初始化，可以看改类的静态代码块是否被执行</strong></p><h3 id="_5、类加载器" tabindex="-1"><a class="header-anchor" href="#_5、类加载器"><span>5、类加载器</span></a></h3><p>Java虚拟机设计团队有意把类加载阶段中的**“通过一个类的全限定名来获取描述该类的二进制字节流”<strong>这个动作放到Java虚拟机外部去实现，以便让应用程序自己决定如何去获取所需的类。实现这个动作的代码被称为</strong>“类加载器”**（ClassLoader）</p><h4 id="类与类加载器" tabindex="-1"><a class="header-anchor" href="#类与类加载器"><span>类与类加载器</span></a></h4><p>类加载器虽然只用于实现类的加载动作，但它在Java程序中起到的作用却远超类加载阶段</p><p>对于任意一个类，都必须由加载它的<strong>类加载器</strong>和这个<strong>类本身</strong>一起共同确立其在Java虚拟机中的唯一性，每一个类加载器，都拥有一个独立的类名称空间。这句话可以表达得更通俗一些：<strong>比较两个类是否“相等”，只有在这两个类是由同一个类加载器加载的前提下才有意义</strong>，否则，即使这两个类来源于同一个Class文件，被同一个Java虚拟机加载，只要加载它们的类加载器不同，那这两个类就必定不相等</p><p>以JDK 8为例</p><table><thead><tr><th>名称</th><th>加载的类</th><th>说明</th></tr></thead><tbody><tr><td>Bootstrap ClassLoader（启动类加载器）</td><td>JAVA_HOME/jre/lib</td><td>无法直接访问</td></tr><tr><td>Extension ClassLoader(拓展类加载器)</td><td>JAVA_HOME/jre/lib/ext</td><td>上级为Bootstrap，<strong>显示为null</strong></td></tr><tr><td>Application ClassLoader(应用程序类加载器)</td><td>classpath</td><td>上级为Extension</td></tr><tr><td>自定义类加载器</td><td>自定义</td><td>上级为Application</td></tr></tbody></table><h4 id="启动类加载器" tabindex="-1"><a class="header-anchor" href="#启动类加载器"><span>启动类加载器</span></a></h4><p>可通过在控制台输入指令，使得类被启动类加器加载</p><h4 id="拓展类加载器" tabindex="-1"><a class="header-anchor" href="#拓展类加载器"><span>拓展类加载器</span></a></h4><p>如果classpath和JAVA_HOME/jre/lib/ext 下有同名类，加载时会使用<strong>拓展类加载器</strong>加载。当应用程序类加载器发现拓展类加载器已将该同名类加载过了，则不会再次加载</p><h4 id="双亲委派模式" tabindex="-1"><a class="header-anchor" href="#双亲委派模式"><span>双亲委派模式</span></a></h4><p>双亲委派模式，即调用类加载器ClassLoader 的 loadClass 方法时，查找类的规则</p><p>loadClass源码</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span></span>\n<span class="line">    <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span></span>\n<span class="line"><span class="token punctuation">{</span></span>\n<span class="line">    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getClassLoadingLock</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token comment">// 首先查找该类是否已经被该类加载器加载过了</span></span>\n<span class="line">        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token comment">//如果没有被加载过</span></span>\n<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token keyword">long</span> t0 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token comment">//看是否被它的上级加载器加载过了 Extension的上级是Bootstarp，但它显示为null</span></span>\n<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                    c <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>\n<span class="line">                    <span class="token comment">//看是否被启动类加载器加载过</span></span>\n<span class="line">                    c <span class="token operator">=</span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                <span class="token punctuation">}</span></span>\n<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token comment">// ClassNotFoundException thrown if class not found</span></span>\n<span class="line">                <span class="token comment">// from the non-null parent class loader</span></span>\n<span class="line">                <span class="token comment">//捕获异常，但不做任何处理</span></span>\n<span class="line">            <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token comment">//如果还是没有找到，先让拓展类加载器调用findClass方法去找到该类，如果还是没找到，就抛出异常</span></span>\n<span class="line">                <span class="token comment">//然后让应用类加载器去找classpath下找该类</span></span>\n<span class="line">                <span class="token keyword">long</span> t1 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">                <span class="token comment">// 记录时间</span></span>\n<span class="line">                <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getParentDelegationTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTime</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getFindClassTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addElapsedTimeFrom</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getFindClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token punctuation">}</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line">        <span class="token keyword">return</span> c<span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="自定义类加载器" tabindex="-1"><a class="header-anchor" href="#自定义类加载器"><span>自定义类加载器</span></a></h4><h5 id="使用场景" tabindex="-1"><a class="header-anchor" href="#使用场景"><span>使用场景</span></a></h5><ul><li>想加载非 classpath 随意路径中的类文件</li><li>通过接口来使用实现，希望解耦时，常用在框架设计</li><li>这些类希望予以隔离，不同应用的同名类都可以加载，不冲突，常见于 tomcat 容器</li></ul><h5 id="步骤" tabindex="-1"><a class="header-anchor" href="#步骤"><span>步骤</span></a></h5><ul><li>继承ClassLoader父类</li><li>要遵从双亲委派机制，重写 ﬁndClass 方法 <ul><li>不是重写loadClass方法，否则不会走双亲委派机制</li></ul></li><li>读取类文件的字节码</li><li>调用父类的 deﬁneClass 方法来加载类</li><li>使用者调用该类加载器的 loadClass 方法</li></ul><h4 id="破坏双亲委派模式" tabindex="-1"><a class="header-anchor" href="#破坏双亲委派模式"><span>破坏双亲委派模式</span></a></h4><ul><li>双亲委派模型的第一次“被破坏”其实发生在双亲委派模型出现之前——即JDK1.2面世以前的“远古”时代 <ul><li>建议用户重写findClass()方法，在类加载器中的loadClass()方法中也会调用该方法</li></ul></li><li>双亲委派模型的第二次“被破坏”是由这个模型自身的缺陷导致的 <ul><li>如果有基础类型又要调用回用户的代码，此时也会破坏双亲委派模式</li></ul></li><li>双亲委派模型的第三次“被破坏”是由于用户对程序动态性的追求而导致的 <ul><li>这里所说的“动态性”指的是一些非常“热”门的名词：代码热替换（Hot Swap）、模块热部署（Hot Deployment）等</li></ul></li></ul><h3 id="_6、运行期优化" tabindex="-1"><a class="header-anchor" href="#_6、运行期优化"><span>6、运行期优化</span></a></h3><h4 id="分层编译" tabindex="-1"><a class="header-anchor" href="#分层编译"><span>分层编译</span></a></h4><p>JVM 将执行状态分成了 5 个层次：</p><ul><li>0层：解释执行，用解释器将字节码翻译为机器码</li><li>1层：使用 C1 <strong>即时编译器</strong>编译执行（不带 proﬁling）</li><li>2层：使用 C1 即时编译器编译执行（带基本的profiling）</li><li>3层：使用 C1 即时编译器编译执行（带完全的profiling）</li><li>4层：使用 C2 即时编译器编译执行</li></ul><p>proﬁling 是指在运行过程中收集一些程序执行状态的数据，例如【方法的调用次数】，【循环的 回边次数】等</p><h5 id="即时编译器-jit-与解释器的区别" tabindex="-1"><a class="header-anchor" href="#即时编译器-jit-与解释器的区别"><span>即时编译器（JIT）与解释器的区别</span></a></h5><ul><li>解释器 <ul><li>将字节码<strong>解释</strong>为机器码，下次即使遇到相同的字节码，仍会执行重复的解释</li><li>是将字节码解释为针对所有平台都通用的机器码</li></ul></li><li>即时编译器 <ul><li>将一些字节码<strong>编译</strong>为机器码，<strong>并存入 Code Cache</strong>，下次遇到相同的代码，直接执行，无需再编译</li><li>根据平台类型，生成平台特定的机器码</li></ul></li></ul><p>对于大部分的不常用的代码，我们无需耗费时间将其编译成机器码，而是采取解释执行的方式运行；另一方面，对于仅占据小部分的热点代码，我们则可以将其编译成机器码，以达到理想的运行速度。 执行效率上简单比较一下 Interpreter &lt; C1 &lt; C2，总的目标是发现热点代码（hotspot名称的由 来），并优化这些热点代码</p><h4 id="逃逸分析" tabindex="-1"><a class="header-anchor" href="#逃逸分析"><span>逃逸分析</span></a></h4><p>逃逸分析（Escape Analysis）简单来讲就是，Java Hotspot 虚拟机可以分析新创建对象的使用范围，并决定是否在 Java 堆上分配内存的一项技术</p><p>逃逸分析的 JVM 参数如下：</p><ul><li>开启逃逸分析：-XX:+DoEscapeAnalysis</li><li>关闭逃逸分析：-XX:-DoEscapeAnalysis</li><li>显示分析结果：-XX:+PrintEscapeAnalysis</li></ul><p>逃逸分析技术在 Java SE 6u23+ 开始支持，并默认设置为启用状态，可以不用额外加这个参数</p><p><strong>对象逃逸状态</strong></p><p><strong>全局逃逸（GlobalEscape）</strong></p><ul><li>即一个对象的作用范围逃出了当前方法或者当前线程，有以下几种场景： <ul><li>对象是一个静态变量</li><li>对象是一个已经发生逃逸的对象</li><li>对象作为当前方法的返回值</li></ul></li></ul><p><strong>参数逃逸（ArgEscape）</strong></p><ul><li>即一个对象被作为方法参数传递或者被参数引用，但在调用过程中不会发生全局逃逸，这个状态是通过被调方法的字节码确定的</li></ul><p><strong>没有逃逸</strong></p><ul><li>即方法中的对象没有发生逃逸</li></ul><p><strong>逃逸分析优化</strong></p><p>针对上面第三点，当一个对象<strong>没有逃逸</strong>时，可以得到以下几个虚拟机的优化</p><h5 id="锁消除" tabindex="-1"><a class="header-anchor" href="#锁消除"><span><strong>锁消除</strong></span></a></h5><p>我们知道线程同步锁是非常牺牲性能的，当编译器确定当前对象只有当前线程使用，那么就会移除该对象的同步锁</p><p>例如，StringBuffer 和 Vector 都是用 synchronized 修饰线程安全的，但大部分情况下，它们都只是在当前线程中用到，这样编译器就会优化移除掉这些锁操作</p><p>锁消除的 JVM 参数如下：</p><ul><li>开启锁消除：-XX:+EliminateLocks</li><li>关闭锁消除：-XX:-EliminateLocks</li></ul><p>锁消除在 JDK8 中都是默认开启的，并且锁消除都要建立在逃逸分析的基础上</p><h5 id="标量替换" tabindex="-1"><a class="header-anchor" href="#标量替换"><span><strong>标量替换</strong></span></a></h5><p>首先要明白标量和聚合量，<strong>基础类型</strong>和<strong>对象的引用</strong>可以理解为<strong>标量</strong>，它们不能被进一步分解。而能被进一步分解的量就是聚合量，比如：对象</p><p>对象是聚合量，它又可以被进一步分解成标量，将其成员变量分解为分散的变量，这就叫做<strong>标量替换</strong>。</p><p>这样，如果一个对象没有发生逃逸，那压根就不用创建它，只会在栈或者寄存器上创建它用到的成员标量，节省了内存空间，也提升了应用程序性能</p><p>标量替换的 JVM 参数如下：</p><ul><li>开启标量替换：-XX:+EliminateAllocations</li><li>关闭标量替换：-XX:-EliminateAllocations</li><li>显示标量替换详情：-XX:+PrintEliminateAllocations</li></ul><p>标量替换同样在 JDK8 中都是默认开启的，并且都要建立在逃逸分析的基础上</p><h5 id="栈上分配" tabindex="-1"><a class="header-anchor" href="#栈上分配"><span><strong>栈上分配</strong></span></a></h5><p>当对象没有发生逃逸时，该<strong>对象</strong>就可以通过标量替换分解成成员标量分配在<strong>栈内存</strong>中，和方法的生命周期一致，随着栈帧出栈时销毁，减少了 GC 压力，提高了应用程序性能</p><h4 id="方法内联" tabindex="-1"><a class="header-anchor" href="#方法内联"><span>方法内联</span></a></h4><h5 id="内联函数" tabindex="-1"><a class="header-anchor" href="#内联函数"><span><strong>内联函数</strong></span></a></h5><p>内联函数就是在程序编译时，编译器将程序中出现的内联函数的调用表达式用内联函数的函数体来直接进行替换</p><h5 id="jvm内联函数" tabindex="-1"><a class="header-anchor" href="#jvm内联函数"><span><strong>JVM内联函数</strong></span></a></h5><p>C++是否为内联函数由自己决定，Java由<strong>编译器决定</strong>。Java不支持直接声明为内联函数的，如果想让他内联，你只能够向编译器提出请求: 关键字<strong>final修饰</strong> 用来指明那个函数是希望被JVM内联的，如</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>\n<span class="line">        <span class="token comment">// to do something  </span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>总的来说，一般的函数都不会被当做内联函数，只有声明了final后，编译器才会考虑是不是要把你的函数变成内联函数</p><p>JVM内建有许多运行时优化。首先<strong>短方法</strong>更利于JVM推断。流程更明显，作用域更短，副作用也更明显。如果是长方法JVM可能直接就跪了。</p><p>第二个原因则更重要：<strong>方法内联</strong></p><p>如果JVM监测到一些<strong>小方法被频繁的执行</strong>，它会把方法的调用替换成方法体本身，如：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">add4</span><span class="token punctuation">(</span><span class="token keyword">int</span> x1<span class="token punctuation">,</span> <span class="token keyword">int</span> x2<span class="token punctuation">,</span> <span class="token keyword">int</span> x3<span class="token punctuation">,</span> <span class="token keyword">int</span> x4<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>\n<span class="line">\t\t<span class="token comment">//这里调用了add2方法</span></span>\n<span class="line">        <span class="token keyword">return</span> <span class="token function">add2</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> x2<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">add2</span><span class="token punctuation">(</span>x3<span class="token punctuation">,</span> x4<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>\n<span class="line">    <span class="token punctuation">}</span>  </span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">add2</span><span class="token punctuation">(</span><span class="token keyword">int</span> x1<span class="token punctuation">,</span> <span class="token keyword">int</span> x2<span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>\n<span class="line">        <span class="token keyword">return</span> x1 <span class="token operator">+</span> x2<span class="token punctuation">;</span>  </span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>方法调用被替换后</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">add4</span><span class="token punctuation">(</span><span class="token keyword">int</span> x1<span class="token punctuation">,</span> <span class="token keyword">int</span> x2<span class="token punctuation">,</span> <span class="token keyword">int</span> x3<span class="token punctuation">,</span> <span class="token keyword">int</span> x4<span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>\n<span class="line">    \t<span class="token comment">//被替换为了方法本身</span></span>\n<span class="line">        <span class="token keyword">return</span> x1 <span class="token operator">+</span> x2 <span class="token operator">+</span> x3 <span class="token operator">+</span> x4<span class="token punctuation">;</span>  </span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="反射优化" tabindex="-1"><a class="header-anchor" href="#反射优化"><span>反射优化</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Reflect1</span> <span class="token punctuation">{</span></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;foo...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token class-name">Method</span> foo <span class="token operator">=</span> <span class="token class-name">Demo3</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span><span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">         foo<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token punctuation">}</span></span>\n<span class="line">   <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>foo.invoke 前面 0 ~ 15 次调用使用的是 MethodAccessor 的 NativeMethodAccessorImpl 实现</p><p>invoke方法源码</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token annotation punctuation">@CallerSensitive</span></span>\n<span class="line"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span></span>\n<span class="line">    <span class="token keyword">throws</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">,</span></span>\n<span class="line">       <span class="token class-name">InvocationTargetException</span></span>\n<span class="line"><span class="token punctuation">{</span></span>\n<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>override<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Reflection</span><span class="token punctuation">.</span><span class="token function">quickCheckMemberAccess</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> modifiers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> caller <span class="token operator">=</span> <span class="token class-name">Reflection</span><span class="token punctuation">.</span><span class="token function">getCallerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token function">checkAccess</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> modifiers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token comment">//MethodAccessor是一个接口，有3个实现类，其中有一个是抽象类</span></span>\n<span class="line">    <span class="token class-name">MethodAccessor</span> ma <span class="token operator">=</span> methodAccessor<span class="token punctuation">;</span>             <span class="token comment">// read volatile</span></span>\n<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ma <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        ma <span class="token operator">=</span> <span class="token function">acquireMethodAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token keyword">return</span> ma<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200614133554.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200614133554.png" alt="img"></a></p><p>会由DelegatingMehodAccessorImpl去调用NativeMethodAccessorImpl</p><p>NativeMethodAccessorImpl源码</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">NativeMethodAccessorImpl</span> <span class="token keyword">extends</span> <span class="token class-name">MethodAccessorImpl</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Method</span> method<span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">private</span> <span class="token class-name">DelegatingMethodAccessorImpl</span> parent<span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">private</span> <span class="token keyword">int</span> numInvocations<span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token class-name">NativeMethodAccessorImpl</span><span class="token punctuation">(</span><span class="token class-name">Method</span> var1<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">=</span> var1<span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">\t</span>\n<span class="line">\t<span class="token comment">//每次进行反射调用，会让numInvocation与ReflectionFactory.inflationThreshold的值（15）进行比较，并使使得numInvocation的值加一</span></span>\n<span class="line">\t<span class="token comment">//如果numInvocation&gt;ReflectionFactory.inflationThreshold，则会调用本地方法invoke0方法</span></span>\n<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> var1<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> var2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>numInvocations <span class="token operator">&gt;</span> <span class="token class-name">ReflectionFactory</span><span class="token punctuation">.</span><span class="token function">inflationThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">ReflectUtil</span><span class="token punctuation">.</span><span class="token function">isVMAnonymousClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token class-name">MethodAccessorImpl</span> var3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MethodAccessorImpl</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MethodAccessorGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">generateMethod</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">getExceptionTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">setDelegate</span><span class="token punctuation">(</span>var3<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">        <span class="token keyword">return</span> <span class="token function">invoke0</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">,</span> var1<span class="token punctuation">,</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">void</span> <span class="token function">setParent</span><span class="token punctuation">(</span><span class="token class-name">DelegatingMethodAccessorImpl</span> var1<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> var1<span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token class-name">Object</span> <span class="token function">invoke0</span><span class="token punctuation">(</span><span class="token class-name">Method</span> var0<span class="token punctuation">,</span> <span class="token class-name">Object</span> var1<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"><span class="token comment">//ReflectionFactory.inflationThreshold()方法的返回值</span></span>\n<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> inflationThreshold <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>一开始if条件不满足，就会调用本地方法invoke0</li><li>随着numInvocation的增大，当它大于ReflectionFactory.inflationThreshold的值16时，就会本地方法访问器替换为一个运行时动态生成的访问器，来提高效率 <ul><li>这时会从反射调用变为<strong>正常调用</strong>，即直接调用 Reflect1.foo()</li></ul></li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200614135011.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200614135011.png" alt="img"></a></p><h1 id="五、内存模型" tabindex="-1"><a class="header-anchor" href="#五、内存模型"><span>五、内存模型</span></a></h1><h2 id="_1、java内存模型-jmm" tabindex="-1"><a class="header-anchor" href="#_1、java内存模型-jmm"><span>1、JAVA内存模型（JMM）</span></a></h2><p>JMM 即 Java Memory Model，它定义了**主存（共享内存）、工作内存（线程私有）**抽象概念，底层对应着 CPU 寄存器、缓存、硬件内存、 CPU 指令优化等。</p><p><strong>JMM体现在以下几个方面</strong></p><ul><li>原子性 - 保证指令不会受到线程上下文切换的影响</li><li>可见性 - 保证指令不会受 cpu 缓存的影响</li><li>有序性 - 保证指令不会受 cpu 指令并行优化的影响</li></ul><h2 id="_2、可见性" tabindex="-1"><a class="header-anchor" href="#_2、可见性"><span>2、可见性</span></a></h2><h4 id="引例" tabindex="-1"><a class="header-anchor" href="#引例"><span>引例</span></a></h4><p><strong>退出不了的循环</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token class-name">Boolean</span> run <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span></span>\n<span class="line">\t\t\t<span class="token keyword">while</span> <span class="token punctuation">(</span>run<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t\t<span class="token comment">//如果run为真，则一直执行</span></span>\n<span class="line">\t\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">\t\t<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;改变run的值为false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\trun <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>为什么无法退出该循环</strong></p><ul><li>初始状态， t 线程刚开始从<strong>主内存</strong>读取了 run 的值到<strong>工作内存</strong>。</li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145505.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145505.png" alt="img"></a></p><ul><li>因为 t 线程要频繁从主内存中读取 run 的值，JIT 编译器会将 run 的值<strong>缓存至自己工作内存</strong>中的高速缓存中， 减少对主存中 run 的访问，提高效率</li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145517.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145517.png" alt="img"></a></p><ul><li>1 秒之后，main 线程修改了 run 的值，并同步至主存，而 t 是从自己工作内存中的高速缓存中读取这个变量 的值，结果永远是<strong>旧值</strong></li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145529.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145529.png" alt="img"></a></p><p><strong>解决方法</strong></p><ul><li>使用<strong>volatile</strong>易变关键字</li><li>它可以用来修饰<strong>成员变量</strong>和<strong>静态成员变量</strong>（放在主存中的变量），他可以避免线程从自己的工作缓存中查找变量的值，必须到主存中获取它的值，线程操作 volatile 变量都是<strong>直接操作主存</strong></li></ul><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token comment">//使用易变关键字</span></span>\n<span class="line"><span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token class-name">Boolean</span> run <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token keyword">while</span> <span class="token punctuation">(</span>run<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t<span class="token comment">//如果run为真，则一直执行</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;改变run的值为false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\trun <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="可见性与原子性" tabindex="-1"><a class="header-anchor" href="#可见性与原子性"><span>可见性与原子性</span></a></h4><p>前面例子体现的实际就是<strong>可见性</strong>，它保证的是在多个线程之间，一个线程对<strong>volatile变量</strong>的修改对另一个线程可见， <strong>不能</strong>保证原子性，仅用在<strong>一个写</strong>线程，<strong>多个读</strong>线程的情况</p><ul><li><p>注意 synchronized 语句块既可以保证代码块的<strong>原子性</strong>，也同时保证代码块内变量的<strong>可见性</strong>。</p></li><li><p>但缺点是 synchronized 是属于<strong>重量级</strong>操作，性能相对更低。</p></li><li><p><strong>如果在前面示例的死循环中加入 System.out.println() 会发现即使不加 volatile 修饰符，线程 t 也能正确看到 对 run 变量的修改了，想一想为什么？</strong></p><ul><li><p>因为使用了<strong>synchronized</strong>关键字</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token comment">//使用了synchronized关键字</span></span>\n<span class="line">        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token function">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">            <span class="token function">newLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li></ul><h4 id="两阶终止模式优化" tabindex="-1"><a class="header-anchor" href="#两阶终止模式优化"><span>两阶终止模式优化</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test7</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token class-name">Monitor</span> monitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Monitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\tmonitor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\tmonitor<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">class</span> <span class="token class-name">Monitor</span> <span class="token punctuation">{</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token class-name">Thread</span> monitor<span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token comment">//设置标记，用于判断是否被终止了</span></span>\n<span class="line">\t<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> stop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token doc-comment comment">/**</span>\n<span class="line">\t * 启动监控器线程</span>\n<span class="line">\t */</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token comment">//设置线控器线程，用于监控线程状态</span></span>\n<span class="line">\t\tmonitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t<span class="token annotation punctuation">@Override</span></span>\n<span class="line">\t\t\t<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t\t<span class="token comment">//开始不停的监控</span></span>\n<span class="line">\t\t\t\t<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t\t\t<span class="token keyword">if</span><span class="token punctuation">(</span>stop<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t\t\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;处理后续任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t\t\t\t<span class="token keyword">break</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t\t\t\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;监控器运行中...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t\t\t<span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t\t\t\t<span class="token comment">//线程休眠</span></span>\n<span class="line">\t\t\t\t\t\t<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t\t\t<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t\t\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;被打断了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t\t\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="line">\t\tmonitor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token doc-comment comment">/**</span>\n<span class="line">\t * \t用于停止监控器线程</span>\n<span class="line">\t */</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token comment">//打断线程</span></span>\n<span class="line">\t\tmonitor<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token comment">//修改标记</span></span>\n<span class="line">\t\tstop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="同步模式之犹豫模式" tabindex="-1"><a class="header-anchor" href="#同步模式之犹豫模式"><span>同步模式之犹豫模式</span></a></h4><p><strong>定义</strong></p><p>Balking （犹豫）模式用在一个线程发现另一个线程或本线程<strong>已经做了某一件相同</strong>的事，那么本线程就无需再做 了，<strong>直接结束返回</strong></p><ul><li>用一个标记来判断该任务是否已经被执行过了</li><li>需要避免线程安全问题 <ul><li>加锁的代码块要尽量的小，以保证性能</li></ul></li></ul><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>nyima<span class="token punctuation">.</span>day1</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line"><span class="token doc-comment comment">/**</span>\n<span class="line"> * <span class="token keyword">@author</span> Chen Panwen</span>\n<span class="line"> * <span class="token keyword">@data</span> 2020/3/26 16:11</span>\n<span class="line"> */</span></span>\n<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test7</span> <span class="token punctuation">{</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token class-name">Monitor</span> monitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Monitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\tmonitor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\tmonitor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\tmonitor<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">class</span> <span class="token class-name">Monitor</span> <span class="token punctuation">{</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token class-name">Thread</span> monitor<span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token comment">//设置标记，用于判断是否被终止了</span></span>\n<span class="line">\t<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> stop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token comment">//设置标记，用于判断是否已经启动过了</span></span>\n<span class="line">\t<span class="token keyword">private</span> <span class="token keyword">boolean</span> starting <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token doc-comment comment">/**</span>\n<span class="line">\t * 启动监控器线程</span>\n<span class="line">\t */</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token comment">//上锁，避免多线程运行时出现线程安全问题</span></span>\n<span class="line">\t\t<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t<span class="token keyword">if</span> <span class="token punctuation">(</span>starting<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t\t<span class="token comment">//已被启动，直接返回</span></span>\n<span class="line">\t\t\t\t<span class="token keyword">return</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t\t\t<span class="token comment">//启动监视器，改变标记</span></span>\n<span class="line">\t\t\tstarting <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t\t<span class="token comment">//设置线控器线程，用于监控线程状态</span></span>\n<span class="line">\t\tmonitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t<span class="token annotation punctuation">@Override</span></span>\n<span class="line">\t\t\t<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t\t<span class="token comment">//开始不停的监控</span></span>\n<span class="line">\t\t\t\t<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t\t\t<span class="token keyword">if</span><span class="token punctuation">(</span>stop<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t\t\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;处理后续任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t\t\t\t<span class="token keyword">break</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t\t\t\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;监控器运行中...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t\t\t<span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t\t\t\t<span class="token comment">//线程休眠</span></span>\n<span class="line">\t\t\t\t\t\t<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t\t\t<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t\t\t\t\t<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;被打断了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\t\t\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t\t\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t\t\t<span class="token punctuation">}</span></span>\n<span class="line">\t\t<span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="line">\t\tmonitor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">\t<span class="token doc-comment comment">/**</span>\n<span class="line">\t * \t用于停止监控器线程</span>\n<span class="line">\t */</span></span>\n<span class="line">\t<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">\t\t<span class="token comment">//打断线程</span></span>\n<span class="line">\t\tmonitor<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">\t\tstop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>\n<span class="line">\t<span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3、有序性" tabindex="-1"><a class="header-anchor" href="#_3、有序性"><span>3、有序性</span></a></h2><h3 id="指令重排" tabindex="-1"><a class="header-anchor" href="#指令重排"><span>指令重排</span></a></h3><ul><li>JVM 会在<strong>不影响正确性</strong>的前提下，可以<strong>调整</strong>语句的执行<strong>顺序</strong></li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145546.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145546.png" alt="img"></a></p><p>这种特性称之为『<strong>指令重排</strong>』，<strong>多线程下『指令重排』会影响正确性</strong>。</p><h3 id="指令重排序优化" tabindex="-1"><a class="header-anchor" href="#指令重排序优化"><span>指令重排序优化</span></a></h3><ul><li>事实上，现代处理器会设计为一个时钟周期完成一条执行时间长的 CPU 指令。为什么这么做呢？可以想到指令还可以再划分成一个个更小的阶段，例如，每条指令都可以分为： <strong>取指令 - 指令译码 - 执行指令 - 内存访问 - 数据写回</strong> 这5 个阶段</li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145615.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145615.png" alt="img"></a></p><ul><li><p>在不改变程序结果的前提下，这些指令的各个阶段可以通过<strong>重排序</strong>和<strong>组合</strong>来实现<strong>指令级并行</strong></p></li><li><p>指令重排的前提是，重排指令<strong>不能影响结果</strong>，例如</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">// 可以重排的例子 </span>\n<span class="line">int a = 10; </span>\n<span class="line">int b = 20; </span>\n<span class="line">System.out.println( a + b );</span>\n<span class="line"></span>\n<span class="line">// 不能重排的例子 </span>\n<span class="line">int a = 10;</span>\n<span class="line">int b = a - 5;</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="支持流水线的处理器" tabindex="-1"><a class="header-anchor" href="#支持流水线的处理器"><span>支持流水线的处理器</span></a></h3><p>现代 CPU 支持多级<strong>指令流水线</strong>，例如支持<strong>同时</strong>执行 <strong>取指令 - 指令译码 - 执行指令 - 内存访问 - 数据写回</strong> 的处理器，就可以称之为五级指令流水线。这时 CPU 可以在一个时钟周期内，同时运行五条指令的不同阶段（相当于一 条执行时间长的复杂指令），IPC = 1，本质上，流水线技术并不能缩短单条指令的执行时间，但它变相地提高了指令地<strong>吞吐率</strong>。</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145602.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145602.png" alt="img"></a></p><p><strong>在多线程环境下，指令重排序可能导致出现意料之外的结果</strong></p><h3 id="解决办法" tabindex="-1"><a class="header-anchor" href="#解决办法"><span>解决办法</span></a></h3><p><strong>volatile</strong> 修饰的变量，可以<strong>禁用</strong>指令重排</p><ul><li>禁止的是加volatile关键字变量之前的代码被重排序</li></ul><h2 id="_4、内存屏障" tabindex="-1"><a class="header-anchor" href="#_4、内存屏障"><span>4、内存屏障</span></a></h2><ul><li>可见性 <ul><li><strong>写屏障</strong>（sfence）保证在该屏障<strong>之前</strong>的，对共享变量的改动，都同步到主存当中</li><li><strong>读屏障</strong>（lfence）保证在该屏障<strong>之后</strong>，对共享变量的读取，加载的是主存中新数据</li></ul></li><li>有序性 <ul><li>写屏障会确保指令重排序时，不会将<strong>写屏障之前</strong>的代码排在写屏障之后</li><li>读屏障会确保指令重排序时，不会将<strong>读屏障之后</strong>的代码排在读屏障之前</li></ul></li></ul><h2 id="_5、volatile-原理" tabindex="-1"><a class="header-anchor" href="#_5、volatile-原理"><span>5、volatile 原理</span></a></h2><p>volatile的底层实现原理是<strong>内存屏障</strong>，Memory Barrier（Memory Fence）</p><ul><li>对 volatile 变量的写指令后会加入写屏障</li><li>对 volatile 变量的读指令前会加入读屏障</li></ul><h3 id="如何保证可见性" tabindex="-1"><a class="header-anchor" href="#如何保证可见性"><span>如何保证可见性</span></a></h3><ul><li><p>写屏障（sfence）保证在该屏障之前的，对共享变量的改动，都同步到主存当中</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145630.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145630.png" alt="img"></a></p></li><li><p>而读屏障（lfence）保证在该屏障之后，对共享变量的读取，加载的是主存中新数据</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145713.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145713.png" alt="img"></a></p></li></ul><h3 id="如何保证有序性" tabindex="-1"><a class="header-anchor" href="#如何保证有序性"><span>如何保证有序性</span></a></h3><ul><li><p>写屏障会确保指令重排序时，不会将写屏障之前的代码排在写屏障之后</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145723.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145723.png" alt="img"></a></p></li><li><p>读屏障会确保指令重排序时，不会将读屏障之后的代码排在读屏障之前</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145729.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145729.png" alt="img"></a></p></li></ul><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145741.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145741.png" alt="img"></a></p><p><strong>但是不能解决指令交错问题</strong></p><ul><li>写屏障仅仅是保证之后的读能够读到新的结果，但不能保证读跑到它前面去</li><li>而有序性的保证也只是保证了<strong>本线程内</strong>相关代码不被重排序</li></ul><h3 id="实现原理之lock前缀" tabindex="-1"><a class="header-anchor" href="#实现原理之lock前缀"><span>实现原理之Lock前缀</span></a></h3><p>在X86处理器下通过工具获取JIT编译器生成的汇编指令来查看对volatile进行写操作时</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">instance = new Singleton();</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>对应的汇编代码是</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">... lock addl ...</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>有volatile变量修饰的共享变量进行写操作的时候会多出第二行汇编代码，通过查IA-32架构软件开发者手册可知，<strong>Lock前缀</strong>的指令在多核处理器下会引发了两件事</p><ul><li><p>Lock前缀指令会引起处理器缓存回写到内存</p><ul><li>Lock前缀指令导致在执行指令期间，声言处理器的LOCK#信号。在多处理器环境中，LOCK#信号确保在声言该信号期间，处理器可以独占任何共享内存。但是，在最近的处理器里，LOCK #信号一般不锁总线，而是<strong>锁缓存</strong>，毕竟锁总线开销的比较大。使用缓存一致性机制来确保修改的原子性，此操作被称为“缓存锁定”，<strong>缓存一致性机制会阻止同时修改由两个以上处理器缓存的内存区域数据</strong></li></ul></li><li><p>一个处理器的缓存回写到内存会导致其他处理器的缓存无效</p><ul><li>在多核处理器系统中进行操作的时候，IA-32和Intel 64处理器能<strong>嗅探其他处理器访问系统内存和它们的内部缓存</strong>。处理器使用嗅探技术保证它的内部缓存、系统内存和其他处理器的缓存的数据在总线上保持一致</li></ul></li></ul><h1 id="五、共享模型之无锁" tabindex="-1"><a class="header-anchor" href="#五、共享模型之无锁"><span>五、共享模型之无锁</span></a></h1><h2 id="_1、无锁解决线程安全问题" tabindex="-1"><a class="header-anchor" href="#_1、无锁解决线程安全问题"><span>1、无锁解决线程安全问题</span></a></h2><ul><li><p>使用<strong>原子整数</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">AtomicInteger balance = new AtomicInteger();</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">interface Account {</span>\n<span class="line">\tInteger getBalance();</span>\n<span class="line"></span>\n<span class="line">\tvoid withdraw(Integer amount);</span>\n<span class="line"></span>\n<span class="line">\t/**</span>\n<span class="line">\t * 方法内会启动 1000 个线程，每个线程做 -10 元 的操作     * 如果初始余额为 10000 那么正确的结果应当是 0</span>\n<span class="line">\t */</span>\n<span class="line">\tstatic void demo(Account account) {</span>\n<span class="line">\t\tList&lt;Thread&gt; ts = new ArrayList&lt;&gt;();</span>\n<span class="line">\t\tlong start = System.nanoTime();</span>\n<span class="line">\t\tfor (int i = 0; i &lt; 1000; i++) {</span>\n<span class="line">\t\t\tts.add(new Thread(() -&gt; {</span>\n<span class="line">\t\t\t\taccount.withdraw(10);</span>\n<span class="line">\t\t\t}));</span>\n<span class="line">\t\t}</span>\n<span class="line">\t\tts.forEach(Thread::start);</span>\n<span class="line">\t\tts.forEach(t -&gt; {</span>\n<span class="line">\t\t\ttry {</span>\n<span class="line">\t\t\t\tt.join();</span>\n<span class="line">\t\t\t} catch (InterruptedException e) {</span>\n<span class="line">\t\t\t\te.printStackTrace();</span>\n<span class="line">\t\t\t}</span>\n<span class="line">\t\t});</span>\n<span class="line">\t\tlong end = System.nanoTime();</span>\n<span class="line">\t\tSystem.out.println(account.getBalance() + &quot; cost: &quot; + (end - start) / 1000_000 + &quot; ms&quot;);</span>\n<span class="line">\t}</span>\n<span class="line">}</span>\n<span class="line"></span>\n<span class="line">//线程不安全的做法</span>\n<span class="line">class AccountUnsafe implements Account {</span>\n<span class="line">\tprivate Integer balance;</span>\n<span class="line"></span>\n<span class="line">\tpublic AccountUnsafe(Integer balance) {</span>\n<span class="line">\t\tthis.balance = balance;</span>\n<span class="line">\t}</span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line">\t@Override</span>\n<span class="line">\tpublic Integer getBalance() {</span>\n<span class="line">\t\treturn this.balance;</span>\n<span class="line">\t}</span>\n<span class="line"></span>\n<span class="line">\t@Override</span>\n<span class="line">\tpublic synchronized void withdraw(Integer amount) {</span>\n<span class="line">\t\tbalance -= amount;</span>\n<span class="line">\t}</span>\n<span class="line"></span>\n<span class="line">\tpublic static void main(String[] args) {</span>\n<span class="line">\t\tAccount.demo(new AccountUnsafe(10000));</span>\n<span class="line">\t\tAccount.demo(new AccountCas(10000));</span>\n<span class="line">\t}</span>\n<span class="line">}</span>\n<span class="line"></span>\n<span class="line">//线程安全的做法</span>\n<span class="line">class AccountCas implements Account {</span>\n<span class="line">\t//使用原子整数</span>\n<span class="line">\tprivate AtomicInteger balance;</span>\n<span class="line"></span>\n<span class="line">\tpublic AccountCas(int balance) {</span>\n<span class="line">\t\tthis.balance = new AtomicInteger(balance);</span>\n<span class="line">\t}</span>\n<span class="line"></span>\n<span class="line">\t@Override</span>\n<span class="line">\tpublic Integer getBalance() {</span>\n<span class="line">\t\t//得到原子整数的值</span>\n<span class="line">\t\treturn balance.get();</span>\n<span class="line">\t}</span>\n<span class="line"></span>\n<span class="line">\t@Override</span>\n<span class="line">\tpublic void withdraw(Integer amount) {</span>\n<span class="line">\t\twhile(true) {</span>\n<span class="line">\t\t\t//获得修改前的值</span>\n<span class="line">\t\t\tint prev = balance.get();</span>\n<span class="line">\t\t\t//获得修改后的值</span>\n<span class="line">\t\t\tint next = prev-amount;</span>\n<span class="line">\t\t\t//比较并设值</span>\n<span class="line">\t\t\tif(balance.compareAndSet(prev, next)) {</span>\n<span class="line">\t\t\t\tbreak;</span>\n<span class="line">\t\t\t}</span>\n<span class="line">\t\t}</span>\n<span class="line">\t}</span>\n<span class="line">}</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2、cas与volatile" tabindex="-1"><a class="header-anchor" href="#_2、cas与volatile"><span>2、CAS与volatile</span></a></h2><p>前面看到的 AtomicInteger 的解决方法，内部并没有用锁来保护共享变量的线程安全。那么它是如何实现的呢？</p><p>其中的<strong>关键是 compareAndSwap</strong>（比较并设置值），它的<strong>简称就是 CAS</strong> （也有 Compare And Swap 的说法），它必须是<strong>原子操作</strong>。</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145914.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145914.png" alt="img"></a></p><h3 id="工作流程" tabindex="-1"><a class="header-anchor" href="#工作流程"><span><strong>工作流程</strong></span></a></h3><ul><li>当一个线程要去修改Account对象中的值时，先获取值pre（调用get方法），然后再将其设置为新的值next（调用cas方法）。在调用cas方法时，会将pre与Account中的余额进行比较。 <ul><li>如果<strong>两者相等</strong>，就说明该值还未被其他线程修改，此时便可以进行修改操作。</li><li>如果<strong>两者不相等</strong>，就不设置值，重新获取值pre（调用get方法），然后再将其设置为新的值next（调用cas方法），直到修改成功为止。</li></ul></li></ul><p><strong>注意</strong></p><ul><li>其实 CAS 的底层是 <strong>lock cmpxchg</strong> 指令（X86 架构），在单核 CPU 和多核 CPU 下都能够保证【比较-交换】的<strong>原子性</strong>。</li><li>在多核状态下，某个核执行到带 lock 的指令时，CPU 会让总线锁住，当这个核把此指令执行完毕，再开启总线。这个过程中不会被线程的调度机制所打断，保证了多个线程对内存操作的准确性，是原子的。</li></ul><h3 id="volatile" tabindex="-1"><a class="header-anchor" href="#volatile"><span>volatile</span></a></h3><p>获取共享变量时，为了保证该变量的<strong>可见性</strong>，需要使用 <strong>volatile</strong> 修饰。 它可以用来修饰成员变量和静态成员变量，他可以避免线程从自己的工作缓存中查找变量的值，必须到<strong>主存中获取</strong> 它的值，线程操作 volatile 变量都是直接操作主存。即一个线程对 volatile 变量的修改，对另一个线程可见。</p><p><strong>注意</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">volatile 仅仅保证了共享变量的可见性，让其它线程能够看到新值，但不能解决指令交错问题（不能保证原子性）</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>CAS 必须借助 volatile</strong> 才能读取到共享变量的新值来实现【比较并交换】的效果</p><h3 id="效率问题" tabindex="-1"><a class="header-anchor" href="#效率问题"><span>效率问题</span></a></h3><p>一般情况下，使用无锁比使用加锁的<strong>效率更高。</strong></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145931.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145931.png" alt="img"></a></p><p><strong>原因</strong></p><h3 id="cas特点" tabindex="-1"><a class="header-anchor" href="#cas特点"><span>CAS特点</span></a></h3><p>结合 CAS 和 volatile 可以实现<strong>无锁并发</strong>，适用于<strong>线程数少、多核 CPU</strong> 的场景下。</p><ul><li><p>CAS 是基于<strong>乐观锁</strong>的思想：乐观的估计，不怕别的线程来修改共享变量，就算改了也没关系，我吃亏点再重试呗。</p></li><li><p>synchronized 是基于悲观锁的思想：悲观的估计，得防着其它线程来修改共享变量，我上了锁你们都别想改，我改完了解开锁，你们才有机会。</p></li><li><p>CAS 体现的是</p><p>无锁并发、无阻塞并发</p><p>，请仔细体会这两句话的意思</p><ul><li>因为没有使用 synchronized，所以线程不会陷入阻塞，这是效率提升的因素之一</li><li>但如果竞争激烈，可以想到重试必然频繁发生，反而效率会受影响</li></ul></li></ul><h2 id="_3、原子整数" tabindex="-1"><a class="header-anchor" href="#_3、原子整数"><span>3、原子整数</span></a></h2><p>J.U.C 并发包提供了</p><ul><li>AtomicBoolean</li><li>AtomicInteger</li><li>AtomicLong</li></ul><p><strong>以 AtomicInteger 为例</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line"> AtomicInteger i = new AtomicInteger(0);</span>\n<span class="line"> </span>\n<span class="line">// 获取并自增（i = 0, 结果 i = 1, 返回 0），类似于 i++ System.out.println(i.getAndIncrement());</span>\n<span class="line"> </span>\n<span class="line">// 自增并获取（i = 1, 结果 i = 2, 返回 2），类似于 ++i System.out.println(i.incrementAndGet());</span>\n<span class="line"> </span>\n<span class="line">// 自减并获取（i = 2, 结果 i = 1, 返回 1），类似于 --i System.out.println(i.decrementAndGet());</span>\n<span class="line"> </span>\n<span class="line">// 获取并自减（i = 1, 结果 i = 0, 返回 1），类似于 i--</span>\n<span class="line">System.out.println(i.getAndDecrement());</span>\n<span class="line"> </span>\n<span class="line">// 获取并加值（i = 0, 结果 i = 5, 返回 0） </span>\n<span class="line">System.out.println(i.getAndAdd(5));</span>\n<span class="line"> </span>\n<span class="line">// 加值并获取（i = 5, 结果 i = 0, 返回 0） </span>\n<span class="line">System.out.println(i.addAndGet(-5));</span>\n<span class="line"> </span>\n<span class="line">// 获取并更新（i = 0, p 为 i 的当前值, 结果 i = -2, 返回 0） </span>\n<span class="line">// 其中函数中的操作能保证原子，但函数需要无副作用 </span>\n<span class="line">System.out.println(i.getAndUpdate(p -&gt; p - 2));</span>\n<span class="line"> </span>\n<span class="line">// 更新并获取（i = -2, p 为 i 的当前值, 结果 i = 0, 返回 0）</span>\n<span class="line">// 其中函数中的操作能保证原子，但函数需要无副作用 </span>\n<span class="line">System.out.println(i.updateAndGet(p -&gt; p + 2));</span>\n<span class="line"> </span>\n<span class="line">// 获取并计算（i = 0, p 为 i 的当前值, x 为参数1, 结果 i = 10, 返回 0） </span>\n<span class="line">// 其中函数中的操作能保证原子，但函数需要无副作用 // getAndUpdate 如果在 lambda 中引用了外部的局部变量，要保证该局部变量是 final 的 </span>\n<span class="line">// getAndAccumulate 可以通过 参数1 来引用外部的局部变量，但因为其不在 lambda 中因此不必是 </span>\n<span class="line">final System.out.println(i.getAndAccumulate(10, (p, x) -&gt; p + x));</span>\n<span class="line"> </span>\n<span class="line">// 计算并获取（i = 10, p 为 i 的当前值, x 为参数1, 结果 i = 0, 返回 0） </span>\n<span class="line">// 其中函数中的操作能保证原子，但函数需要无副作用</span>\n<span class="line">System.out.println(i.accumulateAndGet(-10, (p, x) -&gt; p + x));</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4、原子引用" tabindex="-1"><a class="header-anchor" href="#_4、原子引用"><span>4、原子引用</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">public interface DecimalAccount {</span>\n<span class="line">\tBigDecimal getBalance();</span>\n<span class="line"></span>\n<span class="line">\tvoid withdraw(BigDecimal amount);</span>\n<span class="line"></span>\n<span class="line">\t/**</span>\n<span class="line">\t * 方法内会启动 1000 个线程，每个线程做 -10 元 的操作    </span>\n<span class="line">     * 如果初始余额为 10000 那么正确的结果应当是 0</span>\n<span class="line">\t */</span>\n<span class="line">\tstatic void demo(DecimalAccountImpl account) {</span>\n<span class="line">\t\tList&lt;Thread&gt; ts = new ArrayList&lt;&gt;();</span>\n<span class="line">\t\tlong start = System.nanoTime();</span>\n<span class="line">\t\tfor (int i = 0; i &lt; 1000; i++) {</span>\n<span class="line">\t\t\tts.add(new Thread(() -&gt; {</span>\n<span class="line">\t\t\t\taccount.withdraw(BigDecimal.TEN);</span>\n<span class="line">\t\t\t}));</span>\n<span class="line">\t\t}</span>\n<span class="line">\t\tts.forEach(Thread::start);</span>\n<span class="line">\t\tts.forEach(t -&gt; {</span>\n<span class="line">\t\t\ttry {</span>\n<span class="line">\t\t\t\tt.join();</span>\n<span class="line">\t\t\t} catch (InterruptedException e) {</span>\n<span class="line">\t\t\t\te.printStackTrace();</span>\n<span class="line">\t\t\t}</span>\n<span class="line">\t\t});</span>\n<span class="line">\t\tlong end = System.nanoTime();</span>\n<span class="line">\t\tSystem.out.println(account.getBalance() + &quot; cost: &quot; + (end - start) / 1000_000 + &quot; ms&quot;);</span>\n<span class="line">\t}</span>\n<span class="line">}</span>\n<span class="line"></span>\n<span class="line">class DecimalAccountImpl implements DecimalAccount {</span>\n<span class="line">\t//原子引用，泛型类型为小数类型</span>\n<span class="line">\tAtomicReference&lt;BigDecimal&gt; balance;</span>\n<span class="line"></span>\n<span class="line">\tpublic DecimalAccountImpl(BigDecimal balance) {</span>\n<span class="line">\t\tthis.balance = new AtomicReference&lt;BigDecimal&gt;(balance);</span>\n<span class="line">\t}</span>\n<span class="line"></span>\n<span class="line">\t@Override</span>\n<span class="line">\tpublic BigDecimal getBalance() {</span>\n<span class="line">\t\treturn balance.get();</span>\n<span class="line">\t}</span>\n<span class="line"></span>\n<span class="line">\t@Override</span>\n<span class="line">\tpublic void withdraw(BigDecimal amount) {</span>\n<span class="line">\t\twhile(true) {</span>\n<span class="line">\t\t\tBigDecimal pre = balance.get();</span>\n<span class="line">\t\t\tBigDecimal next = pre.subtract(amount);</span>\n<span class="line">\t\t\tif(balance.compareAndSet(pre, next)) {</span>\n<span class="line">\t\t\t\tbreak;</span>\n<span class="line">\t\t\t}</span>\n<span class="line">\t\t}</span>\n<span class="line">\t}</span>\n<span class="line"></span>\n<span class="line">\tpublic static void main(String[] args) {</span>\n<span class="line">\t\tDecimalAccount.demo(new DecimalAccountImpl(new BigDecimal(&quot;10000&quot;)));</span>\n<span class="line">\t}</span>\n<span class="line">}</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5、aba问题" tabindex="-1"><a class="header-anchor" href="#_5、aba问题"><span>5、ABA问题</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">public class Demo3 {</span>\n<span class="line">\tstatic AtomicReference&lt;String&gt; str = new AtomicReference&lt;&gt;(&quot;A&quot;);</span>\n<span class="line">\tpublic static void main(String[] args) {</span>\n<span class="line">\t\tnew Thread(() -&gt; {</span>\n<span class="line">\t\t\tString pre = str.get();</span>\n<span class="line">\t\t\tSystem.out.println(&quot;change&quot;);</span>\n<span class="line">\t\t\ttry {</span>\n<span class="line">\t\t\t\tother();</span>\n<span class="line">\t\t\t} catch (InterruptedException e) {</span>\n<span class="line">\t\t\t\te.printStackTrace();</span>\n<span class="line">\t\t\t}</span>\n<span class="line">\t\t\ttry {</span>\n<span class="line">\t\t\t\tThread.sleep(1000);</span>\n<span class="line">\t\t\t} catch (InterruptedException e) {</span>\n<span class="line">\t\t\t\te.printStackTrace();</span>\n<span class="line">\t\t\t}</span>\n<span class="line">\t\t\t//把str中的A改为C</span>\n<span class="line">\t\t\tSystem.out.println(&quot;change A-&gt;C &quot; + str.compareAndSet(pre, &quot;C&quot;));</span>\n<span class="line">\t\t}).start();</span>\n<span class="line">\t}</span>\n<span class="line"></span>\n<span class="line">\tstatic void other() throws InterruptedException {</span>\n<span class="line">\t\tnew Thread(()-&gt; {</span>\n<span class="line">\t\t\tSystem.out.println(&quot;change A-&gt;B &quot; + str.compareAndSet(&quot;A&quot;, &quot;B&quot;));</span>\n<span class="line">\t\t}).start();</span>\n<span class="line">\t\tThread.sleep(500);</span>\n<span class="line">\t\tnew Thread(()-&gt; {</span>\n<span class="line">\t\t\tSystem.out.println(&quot;change B-&gt;A &quot; + str.compareAndSet(&quot;B&quot;, &quot;A&quot;));</span>\n<span class="line">\t\t}).start();</span>\n<span class="line">\t}</span>\n<span class="line">}</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145952.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608145952.png" alt="img"></a></p><p>主线程仅能判断出共享变量的值与初值 A <strong>是否相同</strong>，不能感知到这种从 A 改为 B 又 改回 A 的情况，如果主线程希望： 只要有其它线程【<strong>动过了</strong>】共享变量，那么自己的 <strong>cas 就算失败</strong>，这时，仅比较值是不够的，需要再加一个<strong>版本号</strong></p><h3 id="atomicstampedreference" tabindex="-1"><a class="header-anchor" href="#atomicstampedreference"><span><strong>AtomicStampedReference</strong></span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">public class Demo3 {</span>\n<span class="line">\t//指定版本号</span>\n<span class="line">\tstatic AtomicStampedReference&lt;String&gt; str = new AtomicStampedReference&lt;&gt;(&quot;A&quot;, 0);</span>\n<span class="line">\tpublic static void main(String[] args) {</span>\n<span class="line">\t\tnew Thread(() -&gt; {</span>\n<span class="line">\t\t\tString pre = str.getReference();</span>\n<span class="line">\t\t\t//获得版本号</span>\n<span class="line">\t\t\tint stamp = str.getStamp();</span>\n<span class="line">\t\t\tSystem.out.println(&quot;change&quot;);</span>\n<span class="line">\t\t\ttry {</span>\n<span class="line">\t\t\t\tother();</span>\n<span class="line">\t\t\t} catch (InterruptedException e) {</span>\n<span class="line">\t\t\t\te.printStackTrace();</span>\n<span class="line">\t\t\t}</span>\n<span class="line">\t\t\ttry {</span>\n<span class="line">\t\t\t\tThread.sleep(1000);</span>\n<span class="line">\t\t\t} catch (InterruptedException e) {</span>\n<span class="line">\t\t\t\te.printStackTrace();</span>\n<span class="line">\t\t\t}</span>\n<span class="line">\t\t\t//把str中的A改为C,并比对版本号，如果版本号相同，就执行替换，并让版本号+1</span>\n<span class="line">\t\t\tSystem.out.println(&quot;change A-&gt;C stamp &quot; + stamp + str.compareAndSet(pre, &quot;C&quot;, stamp, stamp+1));</span>\n<span class="line">\t\t}).start();</span>\n<span class="line">\t}</span>\n<span class="line"></span>\n<span class="line">\tstatic void other() throws InterruptedException {</span>\n<span class="line">\t\tnew Thread(()-&gt; {</span>\n<span class="line">\t\t\tint stamp = str.getStamp();</span>\n<span class="line">\t\t\tSystem.out.println(&quot;change A-&gt;B stamp &quot; + stamp + str.compareAndSet(&quot;A&quot;, &quot;B&quot;, stamp, stamp+1));</span>\n<span class="line">\t\t}).start();</span>\n<span class="line">\t\tThread.sleep(500);</span>\n<span class="line">\t\tnew Thread(()-&gt; {</span>\n<span class="line">\t\t\tint stamp = str.getStamp();</span>\n<span class="line">\t\t\tSystem.out.println(&quot;change B-&gt;A stamp &quot; + stamp +  str.compareAndSet(&quot;B&quot;, &quot;A&quot;, stamp, stamp+1));</span>\n<span class="line">\t\t}).start();</span>\n<span class="line">\t}</span>\n<span class="line">}</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150003.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150003.png" alt="img"></a></p><h3 id="atomicmarkablereference" tabindex="-1"><a class="header-anchor" href="#atomicmarkablereference"><span>AtomicMarkableReference</span></a></h3><p>AtomicStampedReference 可以给原子引用加上版本号，追踪原子引用整个的变化过程，如： A -&gt; B -&gt; A -&gt; C ，通过AtomicStampedReference，我们可以知道，引用变量中途被更改了几次。 但是有时候，并不关心引用变量更改了几次，只是单纯的关心<strong>是否更改过</strong>，所以就有了 <strong>AtomicMarkableReference</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">public class Demo4 {</span>\n<span class="line">\t//指定版本号</span>\n<span class="line">\tstatic AtomicMarkableReference&lt;String&gt; str = new AtomicMarkableReference&lt;&gt;(&quot;A&quot;, true);</span>\n<span class="line">\tpublic static void main(String[] args) {</span>\n<span class="line">\t\tnew Thread(() -&gt; {</span>\n<span class="line">\t\t\tString pre = str.getReference();</span>\n<span class="line">\t\t\tSystem.out.println(&quot;change&quot;);</span>\n<span class="line">\t\t\ttry {</span>\n<span class="line">\t\t\t\tother();</span>\n<span class="line">\t\t\t} catch (InterruptedException e) {</span>\n<span class="line">\t\t\t\te.printStackTrace();</span>\n<span class="line">\t\t\t}</span>\n<span class="line">\t\t\ttry {</span>\n<span class="line">\t\t\t\tThread.sleep(1000);</span>\n<span class="line">\t\t\t} catch (InterruptedException e) {</span>\n<span class="line">\t\t\t\te.printStackTrace();</span>\n<span class="line">\t\t\t}</span>\n<span class="line">\t\t\t//把str中的A改为C,并比对版本号，如果版本号相同，就执行替换，并让版本号+1</span>\n<span class="line">\t\t\tSystem.out.println(&quot;change A-&gt;C mark &quot; +  str.compareAndSet(pre, &quot;C&quot;, true, false));</span>\n<span class="line">\t\t}).start();</span>\n<span class="line">\t}</span>\n<span class="line"></span>\n<span class="line">\tstatic void other() throws InterruptedException {</span>\n<span class="line">\t\tnew Thread(() -&gt; {</span>\n<span class="line">\t\t\tSystem.out.println(&quot;change A-&gt;A mark &quot; + str.compareAndSet(&quot;A&quot;, &quot;A&quot;, true, false));</span>\n<span class="line">\t\t}).start();</span>\n<span class="line">\t}</span>\n<span class="line">}</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150017.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150017.png" alt="img"></a></p><h3 id="两者的区别" tabindex="-1"><a class="header-anchor" href="#两者的区别"><span>两者的区别</span></a></h3><ul><li><strong>AtomicStampedReference</strong> 需要我们传入<strong>整型变量</strong>作为版本号，来判定是否被更改过</li><li><strong>AtomicMarkableReference</strong>需要我们传入<strong>布尔变量</strong>作为标记，来判断是否被更改过</li></ul><h2 id="_6、原子数组" tabindex="-1"><a class="header-anchor" href="#_6、原子数组"><span>6、原子数组</span></a></h2><ul><li>AtomicIntegerArray</li><li>AtomicLongArray</li><li>AtomicReferenceArray</li></ul><h3 id="lamba表达式的使用" tabindex="-1"><a class="header-anchor" href="#lamba表达式的使用"><span>lamba表达式的使用</span></a></h3><ul><li>提供者 <ul><li>无参又返回</li><li>()-&gt;返回结果</li></ul></li><li>方法 <ul><li>有参有返回</li><li>(参数一…)-&gt;返回结果</li></ul></li><li>消费者 <ul><li>有参无返回</li><li>(参数一…)-&gt;void</li></ul></li></ul><h2 id="_7、原子更新器" tabindex="-1"><a class="header-anchor" href="#_7、原子更新器"><span>7、原子更新器</span></a></h2><ul><li>AtomicReferenceFieldUpdater // 域 字段</li><li>AtomicIntegerFieldUpdater</li><li>AtomicLongFieldUpdate</li></ul><p>原子更新器用于帮助我们改变某个对象中的某个属性</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">public class Demo1 {</span>\n<span class="line">   public static void main(String[] args) {</span>\n<span class="line">      Student student = new Student();</span>\n<span class="line">       </span>\n<span class="line">      // 获得原子更新器</span>\n<span class="line">      // 泛型</span>\n<span class="line">      // 参数1 持有属性的类 参数2 被更新的属性的类</span>\n<span class="line">      // newUpdater中的参数：第三个为属性的名称</span>\n<span class="line">      AtomicReferenceFieldUpdater&lt;Student, String&gt; updater = AtomicReferenceFieldUpdater.newUpdater(Student.class, String.class, &quot;name&quot;);</span>\n<span class="line">       </span>\n<span class="line">      // 修改</span>\n<span class="line">      updater.compareAndSet(student, null, &quot;Nyima&quot;);</span>\n<span class="line">      System.out.println(student);</span>\n<span class="line">   }</span>\n<span class="line">}</span>\n<span class="line"></span>\n<span class="line">class Student {</span>\n<span class="line">   volatile String name;</span>\n<span class="line"></span>\n<span class="line">   @Override</span>\n<span class="line">   public String toString() {</span>\n<span class="line">      return &quot;Student{&quot; +</span>\n<span class="line">            &quot;name=&#39;&quot; + name + &#39;\\&#39;&#39; +</span>\n<span class="line">            &#39;}&#39;;</span>\n<span class="line">   }</span>\n<span class="line">}</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="原子更新器初始化过程" tabindex="-1"><a class="header-anchor" href="#原子更新器初始化过程"><span>原子更新器初始化过程</span></a></h3><p>从上面的例子可以看出，原子更新器是通过newUpdater来获取实例的。其中传入了三个参数</p><ul><li>拥有属性的类的Class</li><li>属性的Class</li><li>属性的名称</li></ul><p>大概可以猜出来，<strong>初始化过程用到了反射</strong>，让我们看看源码来验证一下这个猜测。</p><h4 id="newupdater方法" tabindex="-1"><a class="header-anchor" href="#newupdater方法"><span>newUpdater方法</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">public static &lt;U,W&gt; AtomicReferenceFieldUpdater&lt;U,W&gt; newUpdater(Class&lt;U&gt; tclass,</span>\n<span class="line">                                                                Class&lt;W&gt; vclass,</span>\n<span class="line">                                                                String fieldName) {</span>\n<span class="line">    // 返回了一个AtomicReferenceFieldUpdaterImpl实例</span>\n<span class="line">    return new AtomicReferenceFieldUpdaterImpl&lt;U,W&gt;</span>\n<span class="line">        (tclass, vclass, fieldName, Reflection.getCallerClass());</span>\n<span class="line">}</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从newUpdater方法还并不能看出来具体的初始化过程</p><h4 id="内部实现类" tabindex="-1"><a class="header-anchor" href="#内部实现类"><span>内部实现类</span></a></h4><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20201020145006.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20201020145006.png" alt="img"></a></p><p>AtomicReferenceFieldUpdater为抽象类，该类<strong>内部有一个自己的实现类AtomicReferenceFieldUpdaterImpl</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">private static final class AtomicReferenceFieldUpdaterImpl&lt;T,V&gt;</span>\n<span class="line">        extends AtomicReferenceFieldUpdater&lt;T,V&gt;</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20201020145119.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20201020145119.png" alt="img"></a></p><p><strong>构造方法</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code><span class="line"><span class="token class-name">AtomicReferenceFieldUpdaterImpl</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> tclass<span class="token punctuation">,</span></span>\n<span class="line">                                <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> vclass<span class="token punctuation">,</span></span>\n<span class="line">                                <span class="token keyword">final</span> <span class="token class-name">String</span> fieldName<span class="token punctuation">,</span></span>\n<span class="line">                                <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> caller<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token comment">// 用于保存要被修改的属性</span></span>\n<span class="line">    <span class="token keyword">final</span> <span class="token class-name">Field</span> field<span class="token punctuation">;</span></span>\n<span class="line">    </span>\n<span class="line">    <span class="token comment">// 属性的Class</span></span>\n<span class="line">    <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> fieldClass<span class="token punctuation">;</span></span>\n<span class="line">    </span>\n<span class="line">    <span class="token comment">// field的修饰符</span></span>\n<span class="line">    <span class="token keyword">final</span> <span class="token keyword">int</span> modifiers<span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token comment">// 反射获得属性</span></span>\n<span class="line">        field <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span></span>\n<span class="line">            <span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">                <span class="token keyword">public</span> <span class="token class-name">Field</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchFieldException</span> <span class="token punctuation">{</span></span>\n<span class="line">                    <span class="token comment">// tclass为传入的属性的Class，可以通过它来获得属性</span></span>\n<span class="line">                    <span class="token keyword">return</span> tclass<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">                <span class="token punctuation">}</span></span>\n<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        </span>\n<span class="line">        <span class="token comment">// 获得属性的修饰符，主要用于判断</span></span>\n<span class="line">        <span class="token comment">// 1、vclass 与 属性确切的类型是否匹配</span></span>\n<span class="line">        <span class="token comment">// 2、是否为引用类型</span></span>\n<span class="line">        <span class="token comment">// 3、被修改的属性是否加了volatile关键字</span></span>\n<span class="line">        modifiers <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>ReflectUtil</span><span class="token punctuation">.</span><span class="token function">ensureMemberAccess</span><span class="token punctuation">(</span></span>\n<span class="line">            caller<span class="token punctuation">,</span> tclass<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> modifiers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span> tclass<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token class-name">ClassLoader</span> ccl <span class="token operator">=</span> caller<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ccl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ccl <span class="token operator">!=</span> cl<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>\n<span class="line">            <span class="token punctuation">(</span><span class="token punctuation">(</span>cl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isAncestor</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> ccl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>ReflectUtil</span><span class="token punctuation">.</span><span class="token function">checkPackageAccess</span><span class="token punctuation">(</span>tclass<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line">        </span>\n<span class="line">        <span class="token comment">// 获得属性类的Class</span></span>\n<span class="line">        fieldClass <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PrivilegedActionException</span> pae<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>pae<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>vclass <span class="token operator">!=</span> fieldClass<span class="token punctuation">)</span></span>\n<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassCastException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>vclass<span class="token punctuation">.</span><span class="token function">isPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Must be reference type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isVolatile</span><span class="token punctuation">(</span>modifiers<span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Must be volatile type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token comment">// Access to protected field members is restricted to receivers only</span></span>\n<span class="line">    <span class="token comment">// of the accessing class, or one of its subclasses, and the</span></span>\n<span class="line">    <span class="token comment">// accessing class must in turn be a subclass (or package sibling)</span></span>\n<span class="line">    <span class="token comment">// of the protected member&#39;s defining class.</span></span>\n<span class="line">    <span class="token comment">// If the updater refers to a protected field of a declaring class</span></span>\n<span class="line">    <span class="token comment">// outside the current package, the receiver argument will be</span></span>\n<span class="line">    <span class="token comment">// narrowed to the type of the accessing class.</span></span>\n<span class="line"> \t<span class="token comment">// 对类中的属性进行初始化</span></span>\n<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>cclass <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isProtected</span><span class="token punctuation">(</span>modifiers<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>\n<span class="line">                   tclass<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>\n<span class="line">                   <span class="token operator">!</span><span class="token function">isSamePackage</span><span class="token punctuation">(</span>tclass<span class="token punctuation">,</span> caller<span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line">                  <span class="token operator">?</span> caller <span class="token operator">:</span> tclass<span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>tclass <span class="token operator">=</span> tclass<span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>vclass <span class="token operator">=</span> vclass<span class="token punctuation">;</span></span>\n<span class="line">    <span class="token comment">// 获得偏移量</span></span>\n<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>offset <span class="token operator">=</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">objectFieldOffset</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>可以看出，原子引用更新器确实使用了反射</strong></p><h2 id="_8、longadder原理" tabindex="-1"><a class="header-anchor" href="#_8、longadder原理"><span>8、LongAdder原理</span></a></h2><h3 id="原理之伪共享" tabindex="-1"><a class="header-anchor" href="#原理之伪共享"><span>原理之伪共享</span></a></h3><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150037.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150037.png" alt="img"></a></p><p>缓存行伪共享得从缓存说起 缓存与内存的速度比较</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150051.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150051.png" alt="img"></a></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150102.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150102.png" alt="img"></a></p><p>因为 CPU 与 内存的速度差异很大，需要靠预读数据至<strong>缓存</strong>来提升效率。 而缓存以<strong>缓存行</strong>为单位，每个缓存行对应着一块内存，一般是 <strong>64 byte</strong>（8 个 long） 缓存的加入会造成数据副本的产生，即同一份数据会缓存在不同核心的缓存行中 CPU 要保证数据的<strong>一致性</strong>，如果某个 CPU 核心<strong>更改</strong>了数据，其它 CPU 核心对应的整个缓存行必须<strong>失效</strong></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150111.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150111.png" alt="img"></a></p><p>因为 Cell 是数组形式，在内存中是连续存储的，一个 Cell 为 24 字节（16 字节的对象头和 8 字节的 value），因 此缓存行可以存下 2 个的 Cell 对象。这样问题来了：</p><ul><li>Core-0 要修改 Cell[0]</li><li>Core-1 要修改 Cell[1]</li></ul><p>无论谁修改成功，都会导致对方 Core 的缓存行失效，</p><p>比如 Core-0 中 Cell[0]=6000, Cell[1]=8000 要累加 Cell[0]=6001, Cell[1]=8000 ，这时会让 Core-1 的缓存行失效</p><p>@sun.misc.Contended 用来解决这个问题，它的原理是在使用此注解的对象或字段的<strong>前后各增加 128 字节大小的 padding</strong>（空白），从而让 CPU 将对象预读至缓存时<strong>占用不同的缓存行</strong>，这样，不会造成对方缓存行的失效</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150119.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150119.png" alt="img"></a></p><p><strong>累加主要调用以下方法</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">public void add(long x) {</span>\n<span class="line">       Cell[] as; long b, v; int m; Cell a;</span>\n<span class="line">       if ((as = cells) != null || !casBase(b = base, b + x)) {</span>\n<span class="line">           boolean uncontended = true;</span>\n<span class="line">           if (as == null || (m = as.length - 1) &lt; 0 ||</span>\n<span class="line">               (a = as[getProbe() &amp; m]) == null ||</span>\n<span class="line">               !(uncontended = a.cas(v = a.value, v + x)))</span>\n<span class="line">               longAccumulate(x, null, uncontended);</span>\n<span class="line">       }</span>\n<span class="line">   }</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>累加流程图</strong></p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150129.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150129.png" alt="img"></a></p><h2 id="_9、unsafe" tabindex="-1"><a class="header-anchor" href="#_9、unsafe"><span>9、Unsafe</span></a></h2><p>Unsafe 对象提供了非常底层的，操作内存、线程的方法，Unsafe 对象不能直接调用，只能通过<strong>反射</strong>获得</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">public class GetUnsafe {</span>\n<span class="line">\tpublic static void main(String[] args) throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, NoSuchFieldException {</span>\n<span class="line">\t\t// 通过反射获得Unsafe对象</span>\n<span class="line">\t\tClass unsafeClass = Unsafe.class;</span>\n<span class="line">\t\t// 获得构造函数，Unsafe的构造函数为私有的</span>\n<span class="line">\t\tConstructor constructor = unsafeClass.getDeclaredConstructor();</span>\n<span class="line">\t\t// 设置为允许访问私有内容</span>\n<span class="line">\t\tconstructor.setAccessible(true);</span>\n<span class="line">\t\t// 创建Unsafe对象</span>\n<span class="line">\t\tUnsafe unsafe = (Unsafe) constructor.newInstance();</span>\n<span class="line">\t\t</span>\n<span class="line">\t\t// 创建Person对象</span>\n<span class="line">\t\tPerson person = new Person();</span>\n<span class="line">\t\t// 获得其属性 name 的偏移量</span>\n<span class="line">\t\tField field = Person.class.getDeclaredField(&quot;name&quot;);</span>\n<span class="line">\t\tlong offset = unsafe.objectFieldOffset(field);</span>\n<span class="line"></span>\n<span class="line">\t\t// 通过unsafe的CAS操作改变值</span>\n<span class="line">\t\tunsafe.compareAndSwapObject(person, offset, null, &quot;Nyima&quot;);</span>\n<span class="line">\t\tSystem.out.println(person);</span>\n<span class="line">\t}</span>\n<span class="line">}</span>\n<span class="line"></span>\n<span class="line">class Person {</span>\n<span class="line">    // 配合CAS操作，必须用volatile修饰</span>\n<span class="line"> \tvolatile String name;</span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line">\t@Override</span>\n<span class="line">\tpublic String toString() {</span>\n<span class="line">\t\treturn &quot;Person{&quot; +</span>\n<span class="line">\t\t\t\t&quot;name=&#39;&quot; + name + &#39;\\&#39;&#39; +</span>\n<span class="line">\t\t\t\t&#39;}&#39;;</span>\n<span class="line">\t}</span>\n<span class="line">}</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="六、共享模型之不可变" tabindex="-1"><a class="header-anchor" href="#六、共享模型之不可变"><span>六、共享模型之不可变</span></a></h1><h3 id="_1、不可变" tabindex="-1"><a class="header-anchor" href="#_1、不可变"><span>1、不可变</span></a></h3><p>如果一个对象在<strong>不能够修</strong>改其内部状态（属性），那么它就是线程安全的，因为不存在并发修改。</p><h3 id="_2、不可变设计" tabindex="-1"><a class="header-anchor" href="#_2、不可变设计"><span>2、不可变设计</span></a></h3><h4 id="string类中不可变的体现" tabindex="-1"><a class="header-anchor" href="#string类中不可变的体现"><span>String类中不可变的体现</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">public final class String</span>\n<span class="line">    implements java.io.Serializable, Comparable&lt;String&gt;, CharSequence {</span>\n<span class="line">    /** The value is used for character storage. */</span>\n<span class="line">    private final char value[];</span>\n<span class="line"></span>\n<span class="line">    /** Cache the hash code for the string */</span>\n<span class="line">    private int hash; // Default to 0</span>\n<span class="line">    </span>\n<span class="line">   //....</span>\n<span class="line">  }</span>\n<span class="line">}</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em><em>ﬁnal 的使用 *</em> 发现该类、类中所有属性都是 *<em>ﬁnal</em></em> 的</p><ul><li>属性用 ﬁnal 修饰保证了该属性是只读的，不能修改</li><li>类用 ﬁnal 修饰保证了该类中的方法不能被覆盖，<strong>防止子类无意间破坏不可变性</strong></li></ul><p>**保护性拷贝 **</p><p>但有同学会说，使用字符串时，也有一些跟修改相关的方法啊，比如 substring 等，那么下面就看一看这些方法是 如何实现的，就以 substring 为例</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">public String substring(int beginIndex) {</span>\n<span class="line">        if (beginIndex &lt; 0) {</span>\n<span class="line">            throw new StringIndexOutOfBoundsException(beginIndex);</span>\n<span class="line">        }</span>\n<span class="line">        int subLen = value.length - beginIndex;</span>\n<span class="line">        if (subLen &lt; 0) {</span>\n<span class="line">            throw new StringIndexOutOfBoundsException(subLen);</span>\n<span class="line">        }</span>\n<span class="line">    \t//返回的是一个新的对象</span>\n<span class="line">        return (beginIndex == 0) ? this : new String(value, beginIndex, subLen);</span>\n<span class="line">    }</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>发现其内部是调用 String 的构造方法<strong>创建了一个新字符串</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">public String(char value[], int offset, int count) {</span>\n<span class="line">        if (offset &lt; 0) {</span>\n<span class="line">            throw new StringIndexOutOfBoundsException(offset);</span>\n<span class="line">        }</span>\n<span class="line">        if (count &lt;= 0) {</span>\n<span class="line">            if (count &lt; 0) {</span>\n<span class="line">                throw new StringIndexOutOfBoundsException(count);</span>\n<span class="line">            }</span>\n<span class="line">            if (offset &lt;= value.length) {</span>\n<span class="line">                this.value = &quot;&quot;.value;</span>\n<span class="line">                return;</span>\n<span class="line">            }</span>\n<span class="line">        }</span>\n<span class="line">        // Note: offset or count might be near -1&gt;&gt;&gt;1.</span>\n<span class="line">        if (offset &gt; value.length - count) {</span>\n<span class="line">            throw new StringIndexOutOfBoundsException(offset + count);</span>\n<span class="line">        }</span>\n<span class="line">        this.value = Arrays.OfRange(value, offset, offset+count);</span>\n<span class="line">    }</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>构造新字符串对象时，会生成新的 char[] value，对内容进行复制 。这种通过创建副本对象来避免共享的手段称之为【<strong>保护性拷贝</strong>（defensive ）】</p><h1 id="七、线程池" tabindex="-1"><a class="header-anchor" href="#七、线程池"><span>七、线程池</span></a></h1><h2 id="_1、自定义线程池" tabindex="-1"><a class="header-anchor" href="#_1、自定义线程池"><span>1、自定义线程池</span></a></h2><h3 id="图解" tabindex="-1"><a class="header-anchor" href="#图解"><span>图解</span></a></h3><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20201021154837.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20201021154837.png" alt="img"></a></p><ul><li>阻塞队列中维护了由主线程（或者其他线程）所产生的的任务</li><li>主线程类似于<strong>生产者</strong>，产生任务并放入阻塞队列中</li><li>线程池类似于<strong>消费者</strong>，得到阻塞队列中已有的任务并执行</li></ul><h3 id="代码" tabindex="-1"><a class="header-anchor" href="#代码"><span>代码</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">public class Demo3 {</span>\n<span class="line">   public static void main(String[] args) {</span>\n<span class="line">      ThreadPool threadPool = new ThreadPool(2,  TimeUnit.SECONDS, 1, 4);</span>\n<span class="line">      for (int i = 0; i &lt; 10; i++) {</span>\n<span class="line">         threadPool.execute(()-&gt;{</span>\n<span class="line">            try {</span>\n<span class="line">               TimeUnit.SECONDS.sleep(10000);</span>\n<span class="line">            } catch (InterruptedException e) {</span>\n<span class="line">               e.printStackTrace();</span>\n<span class="line">            }</span>\n<span class="line">            System.out.println(&quot;任务正在执行!&quot;);</span>\n<span class="line">         });</span>\n<span class="line">      }</span>\n<span class="line">   }</span>\n<span class="line">}</span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line">/**</span>\n<span class="line"> * 自定义线程池</span>\n<span class="line"> */</span>\n<span class="line">class ThreadPool {</span>\n<span class="line">   /**</span>\n<span class="line">    * 自定义阻塞队列</span>\n<span class="line">    */</span>\n<span class="line">   private BlockingQueue&lt;Runnable&gt; blockingQueue;</span>\n<span class="line"></span>\n<span class="line">   /**</span>\n<span class="line">    * 核心线程数</span>\n<span class="line">    */</span>\n<span class="line">   private int coreSize;</span>\n<span class="line"></span>\n<span class="line">   private HashSet&lt;Worker&gt; workers = new HashSet&lt;&gt;();</span>\n<span class="line"></span>\n<span class="line">   /**</span>\n<span class="line">    * 用于指定线程最大存活时间</span>\n<span class="line">    */</span>\n<span class="line">   private TimeUnit timeUnit;</span>\n<span class="line">   private long timeout;</span>\n<span class="line"></span>\n<span class="line">   /**</span>\n<span class="line">    * 工作线程类</span>\n<span class="line">    * 内部封装了Thread类，并且添加了一些属性</span>\n<span class="line">    */</span>\n<span class="line">   private class Worker extends Thread {</span>\n<span class="line">      Runnable task;</span>\n<span class="line"></span>\n<span class="line">      public Worker(Runnable task) {</span>\n<span class="line">         System.out.println(&quot;初始化任务&quot;);</span>\n<span class="line">         this.task = task;</span>\n<span class="line">      }</span>\n<span class="line"></span>\n<span class="line">      @Override</span>\n<span class="line">      public void run() {</span>\n<span class="line">         // 如果有任务就执行</span>\n<span class="line">         // 如果阻塞队列中有任务，就继续执行</span>\n<span class="line">         while (task != null || (task = blockingQueue.take()) != null) {</span>\n<span class="line">            try {</span>\n<span class="line">               System.out.println(&quot;执行任务&quot;);</span>\n<span class="line">               task.run();</span>\n<span class="line">            } catch (Exception e) {</span>\n<span class="line">               e.printStackTrace();</span>\n<span class="line">            } finally {</span>\n<span class="line">               // 任务执行完毕，设为空</span>\n<span class="line">               System.out.println(&quot;任务执行完毕&quot;);</span>\n<span class="line">               task = null;</span>\n<span class="line">            }</span>\n<span class="line">         }</span>\n<span class="line">         // 移除任务</span>\n<span class="line">         synchronized (workers) {</span>\n<span class="line">            System.out.println(&quot;移除任务&quot;);</span>\n<span class="line">            workers.remove(this);</span>\n<span class="line">         }</span>\n<span class="line">      }</span>\n<span class="line">   }</span>\n<span class="line"></span>\n<span class="line">   public ThreadPool(int coreSize, TimeUnit timeUnit, long timeout, int capacity) {</span>\n<span class="line">      this.coreSize = coreSize;</span>\n<span class="line">      this.timeUnit = timeUnit;</span>\n<span class="line">      blockingQueue = new BlockingQueue&lt;&gt;(capacity);</span>\n<span class="line">      this.timeout = timeout;</span>\n<span class="line">   }</span>\n<span class="line"></span>\n<span class="line">   public void execute(Runnable task) {</span>\n<span class="line">      synchronized (workers) {</span>\n<span class="line">         // 创建任务</span>\n<span class="line">         // 池中还有空余线程时，可以运行任务</span>\n<span class="line">         // 否则阻塞</span>\n<span class="line">         if (workers.size() &lt; coreSize) {</span>\n<span class="line">            Worker worker = new Worker(task);</span>\n<span class="line">            workers.add(worker);</span>\n<span class="line">            worker.start();</span>\n<span class="line">         } else {</span>\n<span class="line">            System.out.println(&quot;线程池中线程已用完，请稍等&quot;);</span>\n<span class="line">            blockingQueue.put(task);</span>\n<span class="line">         }</span>\n<span class="line">      }</span>\n<span class="line">   }</span>\n<span class="line">}</span>\n<span class="line"></span>\n<span class="line">/**</span>\n<span class="line"> * 阻塞队列</span>\n<span class="line"> * 用于存放主线程或其他线程产生的任务</span>\n<span class="line"> */</span>\n<span class="line">class BlockingQueue&lt;T&gt; {</span>\n<span class="line">   /**</span>\n<span class="line">    * 阻塞队列</span>\n<span class="line">    */</span>\n<span class="line">   private  Deque&lt;T&gt; blockingQueue;</span>\n<span class="line"></span>\n<span class="line">   /**</span>\n<span class="line">    * 阻塞队列容量</span>\n<span class="line">    */</span>\n<span class="line">   private int capacity;</span>\n<span class="line"></span>\n<span class="line">   /**</span>\n<span class="line">    * 锁</span>\n<span class="line">    */</span>\n<span class="line">   private ReentrantLock lock;</span>\n<span class="line"></span>\n<span class="line">   /**</span>\n<span class="line">    * 条件队列</span>\n<span class="line">    */</span>\n<span class="line">   private Condition fullQueue;</span>\n<span class="line">   private Condition emptyQueue;</span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line">   public BlockingQueue(int capacity) {</span>\n<span class="line">      blockingQueue = new ArrayDeque&lt;&gt;(capacity);</span>\n<span class="line">      lock = new ReentrantLock();</span>\n<span class="line">      fullQueue = lock.newCondition();</span>\n<span class="line">      emptyQueue = lock.newCondition();</span>\n<span class="line">      this.capacity = capacity;</span>\n<span class="line">   }</span>\n<span class="line"></span>\n<span class="line">   /**</span>\n<span class="line">    * 获取任务的方法</span>\n<span class="line">    */</span>\n<span class="line">   public T take() {</span>\n<span class="line">      // 加锁</span>\n<span class="line">      lock.lock();</span>\n<span class="line">      try {</span>\n<span class="line">         // 如果阻塞队列为空（没有任务），就一直等待</span>\n<span class="line">         while (blockingQueue.isEmpty()) {</span>\n<span class="line">            try {</span>\n<span class="line">               emptyQueue.await();</span>\n<span class="line">            } catch (InterruptedException e) {</span>\n<span class="line">               e.printStackTrace();</span>\n<span class="line">            }</span>\n<span class="line">         }</span>\n<span class="line">         // 获取任务并唤醒生产者线程</span>\n<span class="line">         T task = blockingQueue.removeFirst();</span>\n<span class="line">         fullQueue.signalAll();</span>\n<span class="line">         return task;</span>\n<span class="line">      } finally {</span>\n<span class="line">         lock.unlock();</span>\n<span class="line">      }</span>\n<span class="line">   }</span>\n<span class="line"></span>\n<span class="line">   public T takeNanos(long timeout, TimeUnit unit) {</span>\n<span class="line">      // 转换等待时间</span>\n<span class="line">      lock.lock();</span>\n<span class="line">      try {</span>\n<span class="line">         long nanos = unit.toNanos(timeout);</span>\n<span class="line">         while (blockingQueue.isEmpty()) {</span>\n<span class="line">            try {</span>\n<span class="line">               // awaitNanos会返回剩下的等待时间</span>\n<span class="line">               nanos = emptyQueue.awaitNanos(nanos);</span>\n<span class="line">               if (nanos &lt; 0) {</span>\n<span class="line">                  return null;</span>\n<span class="line">               }</span>\n<span class="line">            } catch (InterruptedException e) {</span>\n<span class="line">               e.printStackTrace();</span>\n<span class="line">            }</span>\n<span class="line">         }</span>\n<span class="line">         T task = blockingQueue.removeFirst();</span>\n<span class="line">         fullQueue.signalAll();</span>\n<span class="line">         return task;</span>\n<span class="line">      } finally {</span>\n<span class="line">         lock.unlock();</span>\n<span class="line">      }</span>\n<span class="line">   }</span>\n<span class="line"></span>\n<span class="line">   /**</span>\n<span class="line">    * 放入任务的方法</span>\n<span class="line">    * @param task 放入阻塞队列的任务</span>\n<span class="line">    */</span>\n<span class="line">   public void put(T task) {</span>\n<span class="line">      lock.lock();</span>\n<span class="line">      try {</span>\n<span class="line">         while (blockingQueue.size() == capacity) {</span>\n<span class="line">            try {</span>\n<span class="line">               System.out.println(&quot;阻塞队列已满&quot;);</span>\n<span class="line">               fullQueue.await();</span>\n<span class="line">            } catch (InterruptedException e) {</span>\n<span class="line">               e.printStackTrace();</span>\n<span class="line">            }</span>\n<span class="line">         }</span>\n<span class="line">         blockingQueue.add(task);</span>\n<span class="line">         // 唤醒等待的消费者</span>\n<span class="line">         emptyQueue.signalAll();</span>\n<span class="line">      } finally {</span>\n<span class="line">         lock.unlock();</span>\n<span class="line">      }</span>\n<span class="line">   }</span>\n<span class="line"></span>\n<span class="line">   public int getSize() {</span>\n<span class="line">      lock.lock();</span>\n<span class="line">      try {</span>\n<span class="line">         return blockingQueue.size();</span>\n<span class="line">      } finally {</span>\n<span class="line">         lock.unlock();</span>\n<span class="line">      }</span>\n<span class="line">   }</span>\n<span class="line">}</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现了一个简单的线程池</p><ul><li>阻塞队列BlockingQueue用于暂存来不及被线程执行的任务 <ul><li>也可以说是平衡生产者和消费者执行速度上的差异</li><li>里面的获取任务和放入任务用到了<strong>生产者消费者模式</strong></li></ul></li><li>线程池中对线程Thread进行了再次的封装，封装为了Worker <ul><li>在调用任务的run方法时，线程会去执行该任务，执行完毕后还会<strong>到阻塞队列中获取新任务来执行</strong></li></ul></li><li>线程池中执行任务的主要方法为execute方法 <ul><li>执行时要判断正在执行的线程数是否大于了线程池容量</li></ul></li></ul><h2 id="_2、threadpoolexecutor" tabindex="-1"><a class="header-anchor" href="#_2、threadpoolexecutor"><span>2、ThreadPoolExecutor</span></a></h2><h3 id="继承关系" tabindex="-1"><a class="header-anchor" href="#继承关系"><span>继承关系</span></a></h3><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20201022212832.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20201022212832.png" alt="img"></a></p><h3 id="线程池状态" tabindex="-1"><a class="header-anchor" href="#线程池状态"><span>线程池状态</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">// 线程池状态</span>\n<span class="line">// runState is stored in the high-order bits</span>\n<span class="line">// RUNNING 高3位为111</span>\n<span class="line">private static final int RUNNING    = -1 &lt;&lt; COUNT_BITS;</span>\n<span class="line"></span>\n<span class="line">// SHUTDOWN 高3位为000</span>\n<span class="line">private static final int SHUTDOWN   =  0 &lt;&lt; COUNT_BITS;</span>\n<span class="line"></span>\n<span class="line">// 高3位 001</span>\n<span class="line">private static final int STOP       =  1 &lt;&lt; COUNT_BITS;</span>\n<span class="line"></span>\n<span class="line">// 高3位 010</span>\n<span class="line">private static final int TIDYING    =  2 &lt;&lt; COUNT_BITS;</span>\n<span class="line"></span>\n<span class="line">// 高3位 011</span>\n<span class="line">private static final int TERMINATED =  3 &lt;&lt; COUNT_BITS;</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th>状态名称</th><th>高3位的值</th><th>描述</th></tr></thead><tbody><tr><td>RUNNING</td><td>111</td><td>接收新任务，同时处理任务队列中的任务</td></tr><tr><td>SHUTDOWN</td><td>000</td><td>不接受新任务，但是处理任务队列中的任务</td></tr><tr><td>STOP</td><td>001</td><td>中断正在执行的任务，同时抛弃阻塞队列中的任务</td></tr><tr><td>TIDYING</td><td>010</td><td>任务执行完毕，活动线程为0时，即将进入终结阶段</td></tr><tr><td>TERMINATED</td><td>011</td><td>终结状态</td></tr></tbody></table><p>线程池状态和线程池中线程的数量<strong>由一个原子整型ctl来共同表示</strong></p><ul><li>使用一个数来表示两个值的主要原因是：<strong>可以通过一次CAS同时更改两个属性的值</strong></li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">// 原子整数，前3位保存了线程池的状态，剩余位保存的是线程数量</span>\n<span class="line">private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));</span>\n<span class="line"></span>\n<span class="line">// 并不是所有平台的int都是32位。</span>\n<span class="line">// 去掉前三位保存线程状态的位数，剩下的用于保存线程数量</span>\n<span class="line">// 高3位为0，剩余位数全为1</span>\n<span class="line">private static final int COUNT_BITS = Integer.SIZE - 3;</span>\n<span class="line"></span>\n<span class="line">// 2^COUNT_BITS次方，表示可以保存的最大线程数</span>\n<span class="line">// CAPACITY 的高3位为 0</span>\n<span class="line">private static final int CAPACITY   = (1 &lt;&lt; COUNT_BITS) - 1;</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>获取线程池状态、线程数量以及合并两个值的操作</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">// Packing and unpacking ctl</span>\n<span class="line">// 获取运行状态</span>\n<span class="line">// 该操作会让除高3位以外的数全部变为0</span>\n<span class="line">private static int runStateOf(int c)     { return c &amp; ~CAPACITY; }</span>\n<span class="line"></span>\n<span class="line">// 获取运行线程数</span>\n<span class="line">// 该操作会让高3位为0</span>\n<span class="line">private static int workerCountOf(int c)  { return c &amp; CAPACITY; }</span>\n<span class="line"></span>\n<span class="line">// 计算ctl新值</span>\n<span class="line">private static int ctlOf(int rs, int wc) { return rs | wc; }</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="线程池属性" tabindex="-1"><a class="header-anchor" href="#线程池属性"><span>线程池属性</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">// 工作线程，内部封装了Thread</span>\n<span class="line">private final class Worker</span>\n<span class="line">        extends AbstractQueuedSynchronizer</span>\n<span class="line">        implements Runnable {</span>\n<span class="line">    ...</span>\n<span class="line">}</span>\n<span class="line"></span>\n<span class="line">// 阻塞队列，用于存放来不及被核心线程执行的任务</span>\n<span class="line">private final BlockingQueue&lt;Runnable&gt; workQueue;</span>\n<span class="line"></span>\n<span class="line">// 锁</span>\n<span class="line">private final ReentrantLock mainLock = new ReentrantLock();</span>\n<span class="line"></span>\n<span class="line">//  用于存放核心线程的容器，只有当持有锁时才能够获取其中的元素（核心线程）</span>\n<span class="line">private final HashSet&lt;Worker&gt; workers = new HashSet&lt;Worker&gt;();</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="构造方法极其参数" tabindex="-1"><a class="header-anchor" href="#构造方法极其参数"><span>构造方法极其参数</span></a></h3><p><strong>ThreadPoolExecutor最全面的构造方法</strong></p><p>也是构造自定义线程池的方法</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">public ThreadPoolExecutor(int corePoolSize,</span>\n<span class="line">                          int maximumPoolSize,</span>\n<span class="line">                          long keepAliveTime,</span>\n<span class="line">                          TimeUnit unit,</span>\n<span class="line">                          BlockingQueue&lt;Runnable&gt; workQueue,</span>\n<span class="line">                          ThreadFactory threadFactory,</span>\n<span class="line">                          RejectedExecutionHandler handler)</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="参数解释" tabindex="-1"><a class="header-anchor" href="#参数解释"><span><strong>参数解释</strong></span></a></h4><ul><li>corePoolSize：核心线程数</li><li>maximumPoolSize：最大线程数 <ul><li>maximumPoolSize - corePoolSize = 救急线程数</li></ul></li><li>keepAliveTime：救急线程空闲时的最大生存时间</li><li>unit：时间单位</li><li>workQueue：阻塞队列（存放任务） <ul><li>有界阻塞队列 ArrayBlockingQueue</li><li>无界阻塞队列 LinkedBlockingQueue</li><li>最多只有一个同步元素的 SynchronousQueue</li><li>优先队列 PriorityBlockingQueue</li></ul></li><li>threadFactory：线程工厂（给线程取名字）</li><li>handler：拒绝策略</li></ul><h4 id="工作方式" tabindex="-1"><a class="header-anchor" href="#工作方式"><span>工作方式</span></a></h4><ul><li>当一个任务传给线程池以后，可能有以下几种可能 <ul><li>将任务分配给一个核心线程来执行</li><li>核心线程都在执行任务，将任务放到阻塞队列workQueue中等待被执行</li><li>阻塞队列满了，使用救急线程来执行任务 <ul><li>救急线程用完以后，超过生存时间（keepAliveTime）后会被释放</li></ul></li><li>任务总数大于了 最大线程数（maximumPoolSize）与阻塞队列容量的最大值（workQueue.capacity），使用拒接策略</li></ul></li></ul><h4 id="拒绝策略" tabindex="-1"><a class="header-anchor" href="#拒绝策略"><span>拒绝策略</span></a></h4><p>如果线程到达 maximumPoolSize 仍然有新任务这时会执行<strong>拒绝策略</strong>。拒绝策略 jdk 提供了 4 种实现</p><p><a href="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20201022194718.png" target="_blank" rel="noopener noreferrer"><img src="https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20201022194718.png" alt="img"></a></p><ul><li>AbortPolicy：让调用者抛出 RejectedExecutionException 异常，<strong>这是默认策略</strong></li><li>CallerRunsPolicy：让调用者运行任务</li><li>DiscardPolicy：放弃本次任务</li><li>DiscardOldestPolicy：放弃队列中最早的任务，本任务取而代之</li></ul>',860)])])}]]),t=JSON.parse('{"path":"/guide/Jvm.html","title":"JVM (黑马)","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"程序计数器","slug":"程序计数器","link":"#程序计数器","children":[]},{"level":2,"title":"虚拟机栈","slug":"虚拟机栈","link":"#虚拟机栈","children":[]},{"level":2,"title":"线程诊断","slug":"线程诊断","link":"#线程诊断","children":[]},{"level":2,"title":"堆","slug":"堆","link":"#堆","children":[]},{"level":2,"title":"StringTable（常量池）","slug":"stringtable-常量池","link":"#stringtable-常量池","children":[{"level":3,"title":"常量池调优","slug":"常量池调优","link":"#常量池调优","children":[]}]},{"level":2,"title":"什么是JVM","slug":"什么是jvm","link":"#什么是jvm","children":[{"level":3,"title":"定义","slug":"定义","link":"#定义","children":[]},{"level":3,"title":"好处","slug":"好处","link":"#好处","children":[]},{"level":3,"title":"比较","slug":"比较","link":"#比较","children":[]}]},{"level":2,"title":"二、内存结构","slug":"二、内存结构","link":"#二、内存结构","children":[{"level":3,"title":"整体架构","slug":"整体架构","link":"#整体架构","children":[]},{"level":3,"title":"1、程序计数器","slug":"_1、程序计数器","link":"#_1、程序计数器","children":[]},{"level":3,"title":"2、虚拟机栈","slug":"_2、虚拟机栈","link":"#_2、虚拟机栈","children":[]},{"level":3,"title":"3、本地方法栈","slug":"_3、本地方法栈","link":"#_3、本地方法栈","children":[]},{"level":3,"title":"4、堆","slug":"_4、堆","link":"#_4、堆","children":[]},{"level":3,"title":"5、方法区","slug":"_5、方法区","link":"#_5、方法区","children":[]}]},{"level":2,"title":"直接内存","slug":"直接内存","link":"#直接内存","children":[]},{"level":2,"title":"垃圾回收","slug":"垃圾回收","link":"#垃圾回收","children":[{"level":3,"title":"1、如何判断对象可以回收","slug":"_1、如何判断对象可以回收","link":"#_1、如何判断对象可以回收","children":[]},{"level":3,"title":"2、垃圾回收算法","slug":"_2、垃圾回收算法","link":"#_2、垃圾回收算法","children":[]},{"level":3,"title":"3、分代回收","slug":"_3、分代回收","link":"#_3、分代回收","children":[]},{"level":3,"title":"4、垃圾回收器","slug":"_4、垃圾回收器","link":"#_4、垃圾回收器","children":[]},{"level":3,"title":"5、GC 调优","slug":"_5、gc-调优","link":"#_5、gc-调优","children":[]}]},{"level":2,"title":"类加载与字节码技术","slug":"类加载与字节码技术","link":"#类加载与字节码技术","children":[{"level":3,"title":"1、类文件结构","slug":"_1、类文件结构","link":"#_1、类文件结构","children":[]},{"level":3,"title":"2、字节码指令","slug":"_2、字节码指令","link":"#_2、字节码指令","children":[]},{"level":3,"title":"3、编译期处理","slug":"_3、编译期处理","link":"#_3、编译期处理","children":[]},{"level":3,"title":"4、类加载阶段","slug":"_4、类加载阶段","link":"#_4、类加载阶段","children":[]},{"level":3,"title":"5、类加载器","slug":"_5、类加载器","link":"#_5、类加载器","children":[]},{"level":3,"title":"6、运行期优化","slug":"_6、运行期优化","link":"#_6、运行期优化","children":[]}]},{"level":2,"title":"1、JAVA内存模型（JMM）","slug":"_1、java内存模型-jmm","link":"#_1、java内存模型-jmm","children":[]},{"level":2,"title":"2、可见性","slug":"_2、可见性","link":"#_2、可见性","children":[]},{"level":2,"title":"3、有序性","slug":"_3、有序性","link":"#_3、有序性","children":[{"level":3,"title":"指令重排","slug":"指令重排","link":"#指令重排","children":[]},{"level":3,"title":"指令重排序优化","slug":"指令重排序优化","link":"#指令重排序优化","children":[]},{"level":3,"title":"支持流水线的处理器","slug":"支持流水线的处理器","link":"#支持流水线的处理器","children":[]},{"level":3,"title":"解决办法","slug":"解决办法","link":"#解决办法","children":[]}]},{"level":2,"title":"4、内存屏障","slug":"_4、内存屏障","link":"#_4、内存屏障","children":[]},{"level":2,"title":"5、volatile 原理","slug":"_5、volatile-原理","link":"#_5、volatile-原理","children":[{"level":3,"title":"如何保证可见性","slug":"如何保证可见性","link":"#如何保证可见性","children":[]},{"level":3,"title":"如何保证有序性","slug":"如何保证有序性","link":"#如何保证有序性","children":[]},{"level":3,"title":"实现原理之Lock前缀","slug":"实现原理之lock前缀","link":"#实现原理之lock前缀","children":[]}]},{"level":2,"title":"1、无锁解决线程安全问题","slug":"_1、无锁解决线程安全问题","link":"#_1、无锁解决线程安全问题","children":[]},{"level":2,"title":"2、CAS与volatile","slug":"_2、cas与volatile","link":"#_2、cas与volatile","children":[{"level":3,"title":"工作流程","slug":"工作流程","link":"#工作流程","children":[]},{"level":3,"title":"volatile","slug":"volatile","link":"#volatile","children":[]},{"level":3,"title":"效率问题","slug":"效率问题","link":"#效率问题","children":[]},{"level":3,"title":"CAS特点","slug":"cas特点","link":"#cas特点","children":[]}]},{"level":2,"title":"3、原子整数","slug":"_3、原子整数","link":"#_3、原子整数","children":[]},{"level":2,"title":"4、原子引用","slug":"_4、原子引用","link":"#_4、原子引用","children":[]},{"level":2,"title":"5、ABA问题","slug":"_5、aba问题","link":"#_5、aba问题","children":[{"level":3,"title":"AtomicStampedReference","slug":"atomicstampedreference","link":"#atomicstampedreference","children":[]},{"level":3,"title":"AtomicMarkableReference","slug":"atomicmarkablereference","link":"#atomicmarkablereference","children":[]},{"level":3,"title":"两者的区别","slug":"两者的区别","link":"#两者的区别","children":[]}]},{"level":2,"title":"6、原子数组","slug":"_6、原子数组","link":"#_6、原子数组","children":[{"level":3,"title":"lamba表达式的使用","slug":"lamba表达式的使用","link":"#lamba表达式的使用","children":[]}]},{"level":2,"title":"7、原子更新器","slug":"_7、原子更新器","link":"#_7、原子更新器","children":[{"level":3,"title":"原子更新器初始化过程","slug":"原子更新器初始化过程","link":"#原子更新器初始化过程","children":[]}]},{"level":2,"title":"8、LongAdder原理","slug":"_8、longadder原理","link":"#_8、longadder原理","children":[{"level":3,"title":"原理之伪共享","slug":"原理之伪共享","link":"#原理之伪共享","children":[]}]},{"level":2,"title":"9、Unsafe","slug":"_9、unsafe","link":"#_9、unsafe","children":[{"level":3,"title":"1、不可变","slug":"_1、不可变","link":"#_1、不可变","children":[]},{"level":3,"title":"2、不可变设计","slug":"_2、不可变设计","link":"#_2、不可变设计","children":[]}]},{"level":2,"title":"1、自定义线程池","slug":"_1、自定义线程池","link":"#_1、自定义线程池","children":[{"level":3,"title":"图解","slug":"图解","link":"#图解","children":[]},{"level":3,"title":"代码","slug":"代码","link":"#代码","children":[]}]},{"level":2,"title":"2、ThreadPoolExecutor","slug":"_2、threadpoolexecutor","link":"#_2、threadpoolexecutor","children":[{"level":3,"title":"继承关系","slug":"继承关系","link":"#继承关系","children":[]},{"level":3,"title":"线程池状态","slug":"线程池状态","link":"#线程池状态","children":[]},{"level":3,"title":"线程池属性","slug":"线程池属性","link":"#线程池属性","children":[]},{"level":3,"title":"构造方法极其参数","slug":"构造方法极其参数","link":"#构造方法极其参数","children":[]}]}],"git":{"updatedTime":1767700977000,"contributors":[{"name":"womeng","username":"womeng","email":"donglongqin@qq.com","commits":1,"url":"https://github.com/womeng"}],"changelog":[{"hash":"b8e7af09363e2aa76ceb6847db16cbf052e12d54","time":1767700977000,"email":"donglongqin@qq.com","author":"womeng","message":"提交文档"}]},"filePathRelative":"guide/Jvm.md"}')}}]);